<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QScrap Garage Partner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .request-card { transition: all 0.2s; border-left: 5px solid #0d6efd; }
        .request-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .new-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <!-- Login Section -->
    <div id="login-section" class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4>Garage Partner Login</h4>
                </div>
                <div class="card-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label>Phone Number</label>
                            <input type="text" id="phone" class="form-control" placeholder="+974..." required>
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="d-none">
        <nav class="navbar navbar-light bg-white shadow-sm mb-4 rounded">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">QScrap Garage</span>
                <span id="garage-name" class="me-3 fw-bold"></span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
            </div>
        </nav>

        <div class="row">
            <div class="col-md-8">
                <h5 class="mb-3">Live Requests <span id="status-dot" class="text-success">‚óè Live</span></h5>
                <div id="requests-list">
                    <!-- Requests will appear here -->
                    <div class="text-center text-muted py-5">Waiting for requests...</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">My Stats</div>
                    <div class="card-body">
                        <h3>Accepted Bids: <span id="stat-accepted">0</span></h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bid Modal -->
<div class="modal fade" id="bidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submit Bid</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bid-form">
                    <input type="hidden" id="bid-request-id">
                    <div class="mb-2">
                         <label>Info</label>
                         <p id="bid-request-info" class="fw-bold"></p>
                    </div>
                    <div class="mb-3">
                        <label>Price (QAR)</label>
                        <input type="number" id="bid-amount" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Condition</label>
                        <select id="bid-condition" class="form-select">
                            <option value="used">Used (Good)</option>
                            <option value="new">New</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Warranty (Days)</label>
                        <input type="number" id="bid-warranty" class="form-control" value="3" required>
                    </div>
                    <div class="mb-3">
                         <label>Upload Photo</label>
                         <input type="file" id="bid-image" class="form-control" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-success w-100">Send Bid</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = '/api';
    let token = localStorage.getItem('token');
    let socket;
    let userId;

    // Check Auth
    if(token) {
        showDashboard();
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = document.getElementById('phone').value;
        const password = document.getElementById('password').value;

        try {
            const res = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone_number: phone, password })
            });
            const data = await res.json();
            if(data.token) {
                if(data.userType !== 'garage') return alert('Not a garage account');
                localStorage.setItem('token', data.token);
                localStorage.setItem('userId', data.userId);
                token = data.token;
                userId = data.userId;
                showDashboard();
            } else {
                alert(data.error);
            }
        } catch(err) { alert('Login failed'); }
    });

    function logout() {
        localStorage.clear();
        location.reload();
    }

    async function showDashboard() {
        document.getElementById('login-section').classList.add('d-none');
        document.getElementById('dashboard-section').classList.remove('d-none');
        userId = localStorage.getItem('userId');

        // Connect Socket
        socket = io();
        socket.emit('join_garage_room', userId);
        
        socket.on('new_request', (data) => {
            prependRequest(data);
            playNotificationSound();
        });

        socket.on('bid_accepted', (data) => {
            alert(data.notification);
            // Refresh stats or orders list
        });

        await loadRequests();
    }

    async function loadRequests() {
        const res = await fetch(`${API_URL}/requests/pending`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const requests = await res.json();
        const list = document.getElementById('requests-list');
        list.innerHTML = '';
        requests.forEach(r => {
            list.innerHTML += createRequestCard(r);
        });
    }

    function createRequestCard(req) {
        const desc = req.part_description || req.summary?.part || 'Part Request';
        const title = req.car_make ? `${req.car_make} ${req.car_model}` : req.summary?.car || 'Unknown Car';
        // Handle summary object from socket vs direct DB row
        const id = req.request_id;
        
        return `
        <div class="card mb-3 request-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h5 class="card-title">${title}</h5>
                    <span class="badge bg-warning text-dark">Active</span>
                </div>
                <p class="card-text">${desc}</p>
                <button onclick="openBidModal('${id}', '${title} - ${desc}')" class="btn btn-primary btn-sm">Bid Now</button>
            </div>
        </div>`;
    }

    function prependRequest(data) {
        // Data likely comes as { request_id, summary: {...} }
        const html = createRequestCard(data);
        const list = document.getElementById('requests-list');
        // Remove "waiting" text if present
        if(list.innerText.includes('Waiting')) list.innerHTML = '';
        list.insertAdjacentHTML('afterbegin', html);
    }

    window.openBidModal = (reqId, info) => {
        document.getElementById('bid-request-id').value = reqId;
        document.getElementById('bid-request-info').innerText = info;
        new bootstrap.Modal(document.getElementById('bidModal')).show();
    };

    document.getElementById('bid-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const reqId = document.getElementById('bid-request-id').value;
        const amount = document.getElementById('bid-amount').value;
        const warranty = document.getElementById('bid-warranty').value;
        const condition = document.getElementById('bid-condition').value;
        const image = document.getElementById('bid-image').files[0];

        const formData = new FormData();
        formData.append('request_id', reqId);
        formData.append('bid_amount', amount);
        formData.append('warranty_days', warranty);
        formData.append('part_condition', condition);
        if(image) formData.append('images', image);

        try {
            const res = await fetch(`${API_URL}/bids`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            const data = await res.json();
            if(data.bid_id) {
                alert('Bid Sent!');
                bootstrap.Modal.getInstance(document.getElementById('bidModal')).hide();
                document.getElementById('bid-form').reset();
            } else {
                alert(data.error);
            }
        } catch(err) { alert('Error sending bid'); }
    });

    function playNotificationSound() {
        // Simple beep or creating Audio element
        // new Audio('/beep.mp3').play().catch(e=>{});
        console.log('Beep!');
    }
</script>
</body>
</html>

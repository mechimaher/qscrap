name: Database Backup

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC (3 AM Qatar)
  workflow_dispatch:  # Allow manual trigger

jobs:
  backup:
    name: PostgreSQL Backup to R2
    runs-on: ubuntu-latest
    
    steps:
      - name: Run existing backup script
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "ðŸ“¦ Triggering production backup script..."
            
            # Use the existing proven backup script
            if [ -f /opt/qscrap/scripts/backup-db.sh ]; then
              chmod +x /opt/qscrap/scripts/backup-db.sh
              /opt/qscrap/scripts/backup-db.sh
            else
              echo "âŒ Backup script not found!"
              exit 1
            fi

      - name: Verify backup
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "=== Latest Local Backups ==="
            ls -lh /opt/qscrap/backups/*.sql.gz 2>/dev/null | tail -3
            
            echo ""
            echo "=== Backup Integrity Check ==="
            LATEST=$(ls -t /opt/qscrap/backups/*.sql.gz 2>/dev/null | head -1)
            if [ -n "$LATEST" ]; then
              gunzip -t "$LATEST" && echo "âœ… Integrity verified: $(basename $LATEST)"
            fi

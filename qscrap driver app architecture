
QScrap is a B2C /B2B used car spares scrap plaform delivery in QATAR. customer has an application mobile, driver has also for delivery and assignments, garages dashboard, operations or customer service dashboard and admin dashboard. Let s focus now for driver android application mobile architecture. keep in mind that must premium cutting edge modern based on React Native, application must exceed famous delivery applications. i need Frond end, backend business flow for the driver app

5:52 PM
QScrap Driver App - Premium Architecture & Business Flow
I'll design a cutting-edge, world-class driver application architecture that exceeds modern delivery apps like Uber, Talabat, and DoorDash.

ğŸ¯ Executive Summary
A real-time, AI-powered driver application with predictive routing, intelligent earnings optimization, and seamless multi-delivery orchestration specifically designed for auto parts delivery in Qatar.

ğŸ“± FRONTEND ARCHITECTURE (React Native)
Core Technology Stack
React Native 0.73+ (New Architecture - Fabric & TurboModules)
â”œâ”€â”€ TypeScript 5.3+ (Strict mode)
â”œâ”€â”€ React Navigation 6+ (Native Stack)
â”œâ”€â”€ Redux Toolkit + RTK Query (State & API)
â”œâ”€â”€ React Query (Server state)
â”œâ”€â”€ Zustand (Lightweight local state)
â””â”€â”€ Reanimated 3 (Animations)
Premium Libraries & Features
Navigation & UX:

@react-navigation/native-stack - Native performance
react-native-gesture-handler - Smooth gestures
react-native-reanimated 3 - 120fps animations
react-native-skia - Custom graphics for maps overlay
Real-time Communication:

Socket.io-client - Real-time order updates
@react-native-firebase/messaging - Push notifications
react-native-webrtc - Voice/video customer support
Maps & Location:

react-native-maps with Google Maps
@react-native-community/geolocation - Background tracking
react-native-background-geolocation - Battery-optimized tracking
Custom route optimization algorithm integration
Media & Scanning:

react-native-vision-camera V3 - High-performance camera
react-native-mlkit - Barcode/QR scanning
react-native-image-picker - Proof of delivery photos
react-native-compressor - Image optimization
Biometrics & Security:

react-native-biometrics - Fingerprint/Face ID
react-native-keychain - Secure credential storage
react-native-device-info - Device verification
End-to-end encryption for sensitive data
Performance & Monitoring:

@sentry/react-native - Error tracking
react-native-performance - Performance monitoring
flipper - Development debugging
@shopify/flash-list - Ultra-fast lists
Offline Capabilities:

@react-native-async-storage/async-storage - Local storage
react-native-mmkv - Ultra-fast key-value storage
WatermelonDB - Offline-first database
Custom sync engine
Frontend Architecture Pattern
/src
â”œâ”€â”€ /app
â”‚   â”œâ”€â”€ /navigation
â”‚   â”‚   â”œâ”€â”€ RootNavigator.tsx
â”‚   â”‚   â”œâ”€â”€ AuthStack.tsx
â”‚   â”‚   â”œâ”€â”€ MainStack.tsx
â”‚   â”‚   â””â”€â”€ DeliveryStack.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /screens
â”‚   â”‚   â”œâ”€â”€ /auth
â”‚   â”‚   â”‚   â”œâ”€â”€ LoginScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BiometricSetupScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ OnboardingScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /home
â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ AvailableOrdersScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ActiveDeliveryScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /delivery
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderDetailsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ NavigationScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PickupScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DeliveryScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ProofOfDeliveryScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /earnings
â”‚   â”‚   â”‚   â”œâ”€â”€ EarningsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PayoutHistoryScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ InvoiceDetailsScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ /profile
â”‚   â”‚       â”œâ”€â”€ ProfileScreen.tsx
â”‚   â”‚       â”œâ”€â”€ DocumentsScreen.tsx
â”‚   â”‚       â”œâ”€â”€ VehicleInfoScreen.tsx
â”‚   â”‚       â””â”€â”€ SettingsScreen.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /components
â”‚   â”‚   â”œâ”€â”€ /common
â”‚   â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Badge.tsx
â”‚   â”‚   â”‚   â””â”€â”€ LoadingOverlay.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /delivery
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DeliveryTimeline.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ItemsList.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CustomerInfo.tsx
â”‚   â”‚   â”‚   â””â”€â”€ NavigationBar.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /map
â”‚   â”‚   â”‚   â”œâ”€â”€ LiveMap.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RouteOverlay.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MarkerCluster.tsx
â”‚   â”‚   â”‚   â””â”€â”€ TrafficLayer.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ /earnings
â”‚   â”‚       â”œâ”€â”€ EarningsCard.tsx
â”‚   â”‚       â”œâ”€â”€ WeeklyChart.tsx
â”‚   â”‚       â””â”€â”€ PayoutSummary.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /store
â”‚   â”‚   â”œâ”€â”€ /slices
â”‚   â”‚   â”‚   â”œâ”€â”€ authSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ deliverySlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ locationSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ earningsSlice.ts
â”‚   â”‚   â”‚   â””â”€â”€ notificationSlice.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /api
â”‚   â”‚   â”‚   â”œâ”€â”€ authApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ deliveryApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ orderApi.ts
â”‚   â”‚   â”‚   â””â”€â”€ earningsApi.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ store.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”œâ”€â”€ socket.service.ts
â”‚   â”‚   â”œâ”€â”€ location.service.ts
â”‚   â”‚   â”œâ”€â”€ notification.service.ts
â”‚   â”‚   â”œâ”€â”€ storage.service.ts
â”‚   â”‚   â”œâ”€â”€ biometric.service.ts
â”‚   â”‚   â””â”€â”€ sync.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /hooks
â”‚   â”‚   â”œâ”€â”€ useLocation.ts
â”‚   â”‚   â”œâ”€â”€ useSocket.ts
â”‚   â”‚   â”œâ”€â”€ useCamera.ts
â”‚   â”‚   â”œâ”€â”€ usePermissions.ts
â”‚   â”‚   â””â”€â”€ useOfflineSync.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /utils
â”‚   â”‚   â”œâ”€â”€ validators.ts
â”‚   â”‚   â”œâ”€â”€ formatters.ts
â”‚   â”‚   â”œâ”€â”€ constants.ts
â”‚   â”‚   â””â”€â”€ helpers.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /types
â”‚   â”‚   â”œâ”€â”€ order.types.ts
â”‚   â”‚   â”œâ”€â”€ delivery.types.ts
â”‚   â”‚   â”œâ”€â”€ user.types.ts
â”‚   â”‚   â””â”€â”€ api.types.ts
â”‚   â”‚
â”‚   â””â”€â”€ /theme
â”‚       â”œâ”€â”€ colors.ts
â”‚       â”œâ”€â”€ typography.ts
â”‚       â”œâ”€â”€ spacing.ts
â”‚       â””â”€â”€ animations.ts
â”‚
â”œâ”€â”€ /assets
â”‚   â”œâ”€â”€ /images
â”‚   â”œâ”€â”€ /icons
â”‚   â”œâ”€â”€ /animations (Lottie)
â”‚   â””â”€â”€ /sounds
â”‚
â””â”€â”€ /config
    â”œâ”€â”€ env.ts
    â”œâ”€â”€ firebase.ts
    â””â”€â”€ sentry.ts
ğŸ”§ BACKEND ARCHITECTURE
Technology Stack
Node.js 20+ LTS
â”œâ”€â”€ Express.js / Fastify (API Gateway)
â”œâ”€â”€ TypeScript 5.3+
â”œâ”€â”€ PostgreSQL 16 (Primary DB)
â”œâ”€â”€ Redis 7+ (Cache & Real-time)
â”œâ”€â”€ MongoDB (Logs & Analytics)
â”œâ”€â”€ RabbitMQ / Apache Kafka (Message Queue)
â”œâ”€â”€ Socket.io (WebSocket)
â””â”€â”€ Docker + Kubernetes (Orchestration)
Microservices Architecture
API Gateway (Kong / AWS API Gateway)
â”‚
â”œâ”€â”€ Auth Service
â”‚   â”œâ”€â”€ JWT authentication
â”‚   â”œâ”€â”€ Biometric verification
â”‚   â”œâ”€â”€ Session management
â”‚   â””â”€â”€ Role-based access control
â”‚
â”œâ”€â”€ Driver Service
â”‚   â”œâ”€â”€ Driver profile management
â”‚   â”œâ”€â”€ Document verification
â”‚   â”œâ”€â”€ Availability status
â”‚   â”œâ”€â”€ Vehicle information
â”‚   â””â”€â”€ Performance metrics
â”‚
â”œâ”€â”€ Order Assignment Service
â”‚   â”œâ”€â”€ Smart order matching algorithm
â”‚   â”œâ”€â”€ Proximity-based assignment
â”‚   â”œâ”€â”€ Load balancing
â”‚   â”œâ”€â”€ Multi-pickup optimization
â”‚   â””â”€â”€ Rejection handling
â”‚
â”œâ”€â”€ Delivery Service
â”‚   â”œâ”€â”€ Order lifecycle management
â”‚   â”œâ”€â”€ Status updates
â”‚   â”œâ”€â”€ Proof of delivery
â”‚   â”œâ”€â”€ Item verification
â”‚   â””â”€â”€ Exception handling
â”‚
â”œâ”€â”€ Location Service
â”‚   â”œâ”€â”€ Real-time GPS tracking
â”‚   â”œâ”€â”€ Geofencing
â”‚   â”œâ”€â”€ Route optimization
â”‚   â”œâ”€â”€ ETA calculation
â”‚   â””â”€â”€ Location history
â”‚
â”œâ”€â”€ Earnings Service
â”‚   â”œâ”€â”€ Fare calculation
â”‚   â”œâ”€â”€ Commission management
â”‚   â”œâ”€â”€ Bonus/incentive logic
â”‚   â”œâ”€â”€ Payout processing
â”‚   â””â”€â”€ Invoice generation
â”‚
â”œâ”€â”€ Notification Service
â”‚   â”œâ”€â”€ Push notifications (FCM)
â”‚   â”œâ”€â”€ SMS alerts (Twilio)
â”‚   â”œâ”€â”€ Email notifications
â”‚   â”œâ”€â”€ In-app notifications
â”‚   â””â”€â”€ WhatsApp integration
â”‚
â”œâ”€â”€ Analytics Service
â”‚   â”œâ”€â”€ Performance tracking
â”‚   â”œâ”€â”€ Delivery metrics
â”‚   â”œâ”€â”€ Revenue analytics
â”‚   â””â”€â”€ Predictive insights
â”‚
â””â”€â”€ Communication Service
    â”œâ”€â”€ Driver-Customer chat
    â”œâ”€â”€ Voice calling
    â”œâ”€â”€ Support tickets
    â””â”€â”€ Call masking
Backend Structure
/backend
â”œâ”€â”€ /services
â”‚   â”œâ”€â”€ /auth-service
â”‚   â”œâ”€â”€ /driver-service
â”‚   â”œâ”€â”€ /order-service
â”‚   â”œâ”€â”€ /delivery-service
â”‚   â”œâ”€â”€ /location-service
â”‚   â”œâ”€â”€ /earnings-service
â”‚   â”œâ”€â”€ /notification-service
â”‚   â””â”€â”€ /analytics-service
â”‚
â”œâ”€â”€ /api-gateway
â”‚   â”œâ”€â”€ /routes
â”‚   â”œâ”€â”€ /middleware
â”‚   â””â”€â”€ /config
â”‚
â”œâ”€â”€ /shared
â”‚   â”œâ”€â”€ /types
â”‚   â”œâ”€â”€ /utils
â”‚   â”œâ”€â”€ /constants
â”‚   â””â”€â”€ /database
â”‚
â””â”€â”€ /infrastructure
    â”œâ”€â”€ docker-compose.yml
    â”œâ”€â”€ kubernetes/
    â””â”€â”€ terraform/
ğŸ”„ COMPLETE BUSINESS FLOW
1. DRIVER ONBOARDING & AUTHENTICATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Driver Registration                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Driver opens app                              â”‚
â”‚ â†’ Enters phone number                           â”‚
â”‚ â†’ OTP verification screen                       â”‚
â”‚ â†’ Completes profile (name, email, etc.)        â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/auth/register                    â”‚
â”‚ â†’ Validates phone number format                 â”‚
â”‚ â†’ Sends OTP via SMS (Twilio/SNS)               â”‚
â”‚ â†’ POST /api/v1/auth/verify-otp                  â”‚
â”‚ â†’ Creates driver record (status: PENDING)       â”‚
â”‚ â†’ Returns temporary JWT token                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Document Upload & Verification               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Driver uploads:                               â”‚
â”‚   â€¢ QID (Qatar ID)                              â”‚
â”‚   â€¢ Driving License                             â”‚
â”‚   â€¢ Vehicle registration                        â”‚
â”‚   â€¢ Insurance documents                         â”‚
â”‚ â†’ Uses camera with auto-capture                 â”‚
â”‚ â†’ Real-time document quality check              â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/driver/documents                 â”‚
â”‚ â†’ Uploads to S3/CloudStorage                    â”‚
â”‚ â†’ AI verification (OCR - AWS Textract)         â”‚
â”‚ â†’ Manual review queue for admin                 â”‚
â”‚ â†’ Webhook on approval/rejection                 â”‚
â”‚ â†’ Updates driver status: APPROVED               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Biometric Setup & Security                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Prompt for Face ID/Fingerprint setup         â”‚
â”‚ â†’ Store biometric flag locally                  â”‚
â”‚ â†’ Secure token storage in Keychain             â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/driver/biometric/enable          â”‚
â”‚ â†’ Associates device ID with driver              â”‚
â”‚ â†’ Generates refresh token                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
2. GOING ONLINE & ORDER DISCOVERY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Driver Goes Online                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Driver toggles "GO ONLINE" switch            â”‚
â”‚ â†’ Requests location permissions                 â”‚
â”‚ â†’ Starts background location tracking           â”‚
â”‚ â†’ Connects to WebSocket                         â”‚
â”‚ â†’ Shows dashboard with stats                    â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/driver/status/online             â”‚
â”‚ â†’ Updates driver status in Redis                â”‚
â”‚   Key: driver:{id}:status = ONLINE             â”‚
â”‚   Key: driver:{id}:location = {lat, lng}       â”‚
â”‚ â†’ Adds driver to geospatial index              â”‚
â”‚   GEOADD qatar:drivers {lng} {lat} {driver_id} â”‚
â”‚ â†’ WebSocket: socket.join('drivers:active')     â”‚
â”‚ â†’ Publishes event to order assignment service   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Real-time Location Tracking                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Updates location every 10 seconds             â”‚
â”‚ â†’ Uses exponential backoff when stationary      â”‚
â”‚ â†’ Batches updates to save battery               â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/driver/location                  â”‚
â”‚ â†’ Updates Redis geospatial index                â”‚
â”‚ â†’ Stores in TimescaleDB for history            â”‚
â”‚ â†’ Triggers ETA recalculation for active orders â”‚
â”‚ â†’ Publishes to customer tracking stream         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Available Orders Feed                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Shows list of nearby orders                   â”‚
â”‚ â†’ Displays:                                     â”‚
â”‚   â€¢ Pickup location (Garage name)              â”‚
â”‚   â€¢ Delivery location                           â”‚
â”‚   â€¢ Distance                                    â”‚
â”‚   â€¢ Estimated earnings                          â”‚
â”‚   â€¢ Item count & weight                         â”‚
â”‚   â€¢ Customer rating                             â”‚
â”‚ â†’ Auto-refreshes every 5 seconds                â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ GET /api/v1/orders/available                  â”‚
â”‚   ?lat={lat}&lng={lng}&radius=10km             â”‚
â”‚ â†’ Queries orders with status: READY_FOR_PICKUP â”‚
â”‚ â†’ Filters by driver vehicle type                â”‚
â”‚ â†’ Sorts by:                                     â”‚
â”‚   1. Distance                                   â”‚
â”‚   2. Earnings potential                         â”‚
â”‚   3. Customer priority                          â”‚
â”‚ â†’ Returns paginated results                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
3. ORDER ASSIGNMENT & ACCEPTANCE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Smart Order Assignment (Push Model)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend Algorithm:                              â”‚
â”‚ â†’ New order created by customer/garage          â”‚
â”‚ â†’ Assignment Service triggers:                  â”‚
â”‚   1. GEORADIUS qatar:drivers {lng} {lat} 5 KM  â”‚
â”‚   2. Filters online drivers                     â”‚
â”‚   3. Scores drivers based on:                   â”‚
â”‚      â€¢ Distance (40% weight)                    â”‚
â”‚      â€¢ Acceptance rate (20%)                    â”‚
â”‚      â€¢ Customer rating (20%)                    â”‚
â”‚      â€¢ Current load (10%)                       â”‚
â”‚      â€¢ Completion rate (10%)                    â”‚
â”‚   4. Selects top 5 drivers                      â”‚
â”‚   5. Sends offer sequentially (30s timeout)     â”‚
â”‚                                                 â”‚
â”‚ Frontend:                                       â”‚
â”‚ â†’ WebSocket receives order offer                â”‚
â”‚   socket.on('order:offer', (order) => {...})   â”‚
â”‚ â†’ Shows full-screen modal with:                 â”‚
â”‚   â€¢ Pickup & delivery locations on map         â”‚
â”‚   â€¢ Estimated earnings                          â”‚
â”‚   â€¢ Distance & time                             â”‚
â”‚   â€¢ Accept/Reject buttons                       â”‚
â”‚ â†’ 30-second countdown timer                     â”‚
â”‚ â†’ Sound alert + vibration                       â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ Creates temporary order lock in Redis         â”‚
â”‚   SETEX order:{id}:locked 30 {driver_id}       â”‚
â”‚ â†’ Tracks offer in database                      â”‚
â”‚ â†’ If timeout, offers to next driver             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Driver Accepts Order                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Driver taps "ACCEPT"                          â”‚
â”‚ â†’ Shows loading state                           â”‚
â”‚ â†’ Navigates to Order Details screen             â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/accept               â”‚
â”‚ â†’ BEGIN TRANSACTION                             â”‚
â”‚   â€¢ Updates order status: ASSIGNED              â”‚
â”‚   â€¢ Assigns driver_id                           â”‚
â”‚   â€¢ Sets assignment_time                        â”‚
â”‚   â€¢ Creates delivery record                     â”‚
â”‚   â€¢ Removes from available orders queue         â”‚
â”‚   â€¢ Publishes to customer notification service  â”‚
â”‚ â†’ COMMIT                                        â”‚
â”‚ â†’ WebSocket: Notifies customer                  â”‚
â”‚   socket.to(customer_id).emit('driver:assigned')â”‚
â”‚ â†’ Removes order from other drivers' feeds       â”‚
â”‚ â†’ Starts SLA timer                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Driver Rejects Order                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Driver taps "REJECT"                          â”‚
â”‚ â†’ Optional: Shows rejection reason modal        â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/reject               â”‚
â”‚ â†’ Logs rejection reason                         â”‚
â”‚ â†’ Updates driver acceptance_rate                â”‚
â”‚ â†’ Releases order lock                           â”‚
â”‚ â†’ Triggers assignment to next driver            â”‚
â”‚ â†’ If 3 rejections â†’ manual assignment           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
4. PICKUP JOURNEY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Navigate to Pickup Location                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Shows order details:                          â”‚
â”‚   â€¢ Garage name & address                       â”‚
â”‚   â€¢ Contact number (click to call)             â”‚
â”‚   â€¢ Items list with codes                       â”‚
â”‚   â€¢ Special instructions                        â”‚
â”‚ â†’ "START NAVIGATION" button                     â”‚
â”‚ â†’ Opens Google Maps / Waze with coordinates     â”‚
â”‚ â†’ Shows live ETA                                â”‚
â”‚ â†’ In-app mini-map with route                    â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ GET /api/v1/orders/{id}/details               â”‚
â”‚ â†’ Returns full order data                       â”‚
â”‚ â†’ GET /api/v1/routing/optimize                  â”‚
â”‚   â€¢ Uses Google Directions API                  â”‚
â”‚   â€¢ Considers Qatar traffic data                â”‚
â”‚   â€¢ Returns optimized route                     â”‚
â”‚ â†’ Continuous ETA updates via location stream    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Arrive at Garage                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Geofence triggers "ARRIVED" button           â”‚
â”‚   (within 100m radius)                          â”‚
â”‚ â†’ Driver taps "I'VE ARRIVED"                    â”‚
â”‚ â†’ Shows items checklist                         â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/arrived-pickup       â”‚
â”‚ â†’ Updates order status: DRIVER_AT_PICKUP        â”‚
â”‚ â†’ Records arrival time                          â”‚
â”‚ â†’ Notifies garage via WebSocket/SMS             â”‚
â”‚ â†’ Starts pickup preparation timer               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Verify & Collect Items                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Shows checklist of items to collect:          â”‚
â”‚   [ ] Engine Oil Filter (QS-123456)            â”‚
â”‚   [ ] Brake Pads Set (QS-789012)               â”‚
â”‚ â†’ For each item:                                â”‚
â”‚   â€¢ Scan barcode/QR code                        â”‚
â”‚   â€¢ Or manual checkbox                          â”‚
â”‚   â€¢ Photo capture (optional)                    â”‚
â”‚ â†’ Verify packaging integrity                    â”‚
â”‚ â†’ Signature from garage staff                   â”‚
â”‚ â†’ "CONFIRM PICKUP" button (enabled when all    â”‚
â”‚   items checked)                                â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/verify-items         â”‚
â”‚   Body: {                                       â”‚
â”‚     items: [                                    â”‚
â”‚       {item_id, scanned: true, photo_url},      â”‚
â”‚       ...                                       â”‚
â”‚     ],                                          â”‚
â”‚     signature_url,                              â”‚
â”‚     pickup_notes                                â”‚
â”‚   }                                             â”‚
â”‚ â†’ Validates all required items collected        â”‚
â”‚ â†’ Stores verification data                      â”‚
â”‚ â†’ Updates order status: PICKED_UP               â”‚
â”‚ â†’ Records pickup_time                           â”‚
â”‚ â†’ Notifies customer: "Driver picked up parts"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Issue Handling at Pickup                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ "REPORT ISSUE" button                         â”‚
â”‚ â†’ Issue types:                                  â”‚
â”‚   â€¢ Items not ready                             â”‚
â”‚   â€¢ Missing items                               â”‚
â”‚   â€¢ Wrong items                                 â”‚
â”‚   â€¢ Damaged packaging                           â”‚
â”‚   â€¢ Garage closed                               â”‚
â”‚ â†’ Photo upload + notes                          â”‚
â”‚ â†’ Connects to support                           â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/report-issue         â”‚
â”‚ â†’ Creates support ticket                        â”‚
â”‚ â†’ Notifies operations team                      â”‚
â”‚ â†’ Pauses SLA timer                              â”‚
â”‚ â†’ Updates order status: ISSUE_AT_PICKUP         â”‚
â”‚ â†’ Triggers resolution workflow                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
5. DELIVERY JOURNEY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Navigate to Customer                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Automatically starts navigation to customer   â”‚
â”‚ â†’ Shows customer details:                       â”‚
â”‚   â€¢ Name (masked for privacy)                   â”‚
â”‚   â€¢ Delivery address                            â”‚
â”‚   â€¢ Phone number (click to call/chat)          â”‚
â”‚   â€¢ Delivery instructions                       â”‚
â”‚ â†’ Live ETA visible to customer                  â”‚
â”‚ â†’ In-app chat available                         â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ Updates order status: IN_TRANSIT              â”‚
â”‚ â†’ Real-time location broadcast to customer:     â”‚
â”‚   Redis Pub/Sub: PUBLISH customer:{id}:location â”‚
â”‚ â†’ Recalculates ETA every location update        â”‚
â”‚ â†’ Notifies customer when driver is 5 mins away â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Arrive at Delivery Location                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Geofence triggers "ARRIVED" state            â”‚
â”‚ â†’ Driver taps "I'VE ARRIVED"                    â”‚
â”‚ â†’ Can call customer if needed                   â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/arrived-delivery     â”‚
â”‚ â†’ Updates order status: DRIVER_AT_DELIVERY      â”‚
â”‚ â†’ Records arrival time                          â”‚
â”‚ â†’ Sends notification to customer                â”‚
â”‚ â†’ Starts delivery completion timer (5 mins)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Proof of Delivery (POD)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Multi-step POD flow:                          â”‚
â”‚                                                 â”‚
â”‚ Step 1: Verify Items                            â”‚
â”‚   â€¢ Show items checklist                        â”‚
â”‚   â€¢ Customer verifies each item                 â”‚
â”‚   â€¢ Report any issues                           â”‚
â”‚                                                 â”‚
â”‚ Step 2: Capture Photo                           â”‚
â”‚   â€¢ Take photo of delivered items               â”‚
â”‚   â€¢ Auto-compress & upload                      â”‚
â”‚                                                 â”‚
â”‚ Step 3: Collect Signature                       â”‚
â”‚   â€¢ Customer signs on screen                    â”‚
â”‚   â€¢ Or enters OTP (for contactless)            â”‚
â”‚                                                 â”‚
â”‚ Step 4: Cash Collection (if COD)                â”‚
â”‚   â€¢ Enter amount received                       â”‚
â”‚   â€¢ Confirm payment                             â”‚
â”‚                                                 â”‚
â”‚ â†’ "COMPLETE DELIVERY" button                    â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/complete             â”‚
â”‚   Body: {                                       â”‚
â”‚     delivered_items: [...],                     â”‚
â”‚     photo_urls: [...],                          â”‚
â”‚     signature_url / otp,                        â”‚
â”‚     payment_collected: true/false,              â”‚
â”‚     cash_amount (if COD),                       â”‚
â”‚     delivery_notes,                             â”‚
â”‚     completion_time                             â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ BEGIN TRANSACTION                             â”‚
â”‚   â€¢ Updates order status: DELIVERED             â”‚
â”‚   â€¢ Records delivery_time                       â”‚
â”‚   â€¢ Calculates driver earnings                  â”‚
â”‚   â€¢ Creates earnings record                     â”‚
â”‚   â€¢ If COD: Creates payment record              â”‚
â”‚   â€¢ Updates driver statistics                   â”‚
â”‚   â€¢ Releases driver for new orders              â”‚
â”‚ â†’ COMMIT                                        â”‚
â”‚                                                 â”‚
â”‚ â†’ Notifications:                                â”‚
â”‚   â€¢ Customer: "Order delivered successfully"    â”‚
â”‚   â€¢ Garage: "Delivery completed"                â”‚
â”‚   â€¢ Driver: "You earned X QAR"                  â”‚
â”‚                                                 â”‚
â”‚ â†’ Analytics Event:                              â”‚
â”‚   â€¢ Delivery completion time                    â”‚
â”‚   â€¢ Route efficiency                            â”‚
â”‚   â€¢ Customer satisfaction triggers              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Delivery Issues                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ "REPORT ISSUE" options:                       â”‚
â”‚   â€¢ Customer not available                      â”‚
â”‚   â€¢ Wrong address                               â”‚
â”‚   â€¢ Customer refused items                      â”‚
â”‚   â€¢ Access issues (gate, security)             â”‚
â”‚   â€¢ Other                                       â”‚
â”‚ â†’ Photo + notes mandatory                       â”‚
â”‚ â†’ Attempts customer contact                     â”‚
â”‚ â†’ Escalates to support                          â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{id}/delivery-issue       â”‚
â”‚ â†’ Updates status: DELIVERY_FAILED/ATTEMPTED     â”‚
â”‚ â†’ Creates support ticket                        â”‚
â”‚ â†’ Triggers resolution flow:                     â”‚
â”‚   â€¢ If customer unavailable: Schedule redeliveryâ”‚
â”‚   â€¢ If refused: Initiate return to garage       â”‚
â”‚   â€¢ If address wrong: Contact customer          â”‚
â”‚ â†’ Compensates driver for attempt                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
6. EARNINGS & PAYOUTS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Earnings Calculation                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend (Real-time):                            â”‚
â”‚ â†’ Earnings Service calculates:                  â”‚
â”‚                                                 â”‚
â”‚ Base Fare:                                      â”‚
â”‚   â€¢ Distance-based (X QAR/km)                   â”‚
â”‚   â€¢ Time-based (Y QAR/min)                      â”‚
â”‚   â€¢ Base pickup fee                             â”‚
â”‚                                                 â”‚
â”‚ Multipliers:                                    â”‚
â”‚   â€¢ Peak hours (1.5x on rush hours)            â”‚
â”‚   â€¢ Weather conditions (1.3x on extreme heat)   â”‚
â”‚   â€¢ Item weight/size surcharge                  â”‚
â”‚   â€¢ Express delivery premium                    â”‚
â”‚                                                 â”‚
â”‚ Bonuses:                                        â”‚
â”‚   â€¢ Completion streak bonus                     â”‚
â”‚   â€¢ High ratings bonus (4.8+)                   â”‚
â”‚
Continue

5:54 PM
Daily/weekly targets â”‚ â”‚ â€¢ Referral bonuses â”‚ â”‚ â”‚ â”‚ Deductions: â”‚ â”‚ â€¢ Platform commission (15-20%) â”‚ â”‚ â€¢ Cancellation penalties â”‚ â”‚ â€¢ Customer complaints â”‚ â”‚ â”‚ â”‚ Formula: â”‚ â”‚ total_earnings = (base_fare * multipliers) â”‚ â”‚ + bonuses - deductions â”‚ â”‚ â”‚ â”‚ â†’ Stores in earnings table â”‚ â”‚ â†’ Updates driver balance in real-time â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Earnings Dashboard                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Real-time earnings display:                   â”‚
â”‚   â€¢ Today's earnings (live counter)            â”‚
â”‚   â€¢ Weekly earnings                             â”‚
â”‚   â€¢ Monthly earnings                            â”‚
â”‚   â€¢ Available balance                           â”‚
â”‚                                                 â”‚
â”‚ â†’ Charts & Analytics:                           â”‚
â”‚   â€¢ Earnings trend graph (7/30 days)           â”‚
â”‚   â€¢ Breakdown by delivery type                  â”‚
â”‚   â€¢ Peak earnings hours                         â”‚
â”‚   â€¢ Comparison with targets                     â”‚
â”‚                                                 â”‚
â”‚ â†’ Trip History:                                 â”‚
â”‚   â€¢ List of completed deliveries               â”‚
â”‚   â€¢ Earnings per delivery                       â”‚
â”‚   â€¢ Customer ratings                            â”‚
â”‚   â€¢ View invoice/receipt                        â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ GET /api/v1/driver/earnings/summary           â”‚
â”‚   ?period=today|week|month                      â”‚
â”‚ â†’ GET /api/v1/driver/earnings/history           â”‚
â”‚   ?page=1&limit=20                              â”‚
â”‚ â†’ GET /api/v1/driver/earnings/analytics         â”‚
â”‚ â†’ Aggregates from TimescaleDB                   â”‚
â”‚ â†’ Real-time updates via WebSocket               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Payout System                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Payout options:                               â”‚
â”‚   â€¢ Auto-payout (weekly/bi-weekly)             â”‚
â”‚   â€¢ Instant payout (for fee)                    â”‚
â”‚   â€¢ Manual request                              â”‚
â”‚                                                 â”‚
â”‚ â†’ Bank account management:                      â”‚
â”‚   â€¢ Add/edit bank details                       â”‚
â”‚   â€¢ Verify account                              â”‚
â”‚   â€¢ Set primary account                         â”‚
â”‚                                                 â”‚
â”‚ â†’ Payout history:                               â”‚
â”‚   â€¢ Date, amount, status                        â”‚
â”‚   â€¢ Transaction ID                              â”‚
â”‚   â€¢ Download statements                         â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/driver/payout/request            â”‚
â”‚   Body: { amount, account_id, type }           â”‚
â”‚                                                 â”‚
â”‚ â†’ Payout Processing:                            â”‚
â”‚   1. Validates minimum payout (50 QAR)          â”‚
â”‚   2. Checks available balance                   â”‚
â”‚   3. Deducts any pending penalties              â”‚
â”‚   4. Creates payout record (PENDING)            â”‚
â”‚   5. Integrates with payment gateway:           â”‚
â”‚      â€¢ Qatar banks: QNB, CBQ, etc.             â”‚
â”‚      â€¢ International: PayPal, Wise             â”‚
â”‚   6. Updates status: PROCESSING â†’ COMPLETED     â”‚
â”‚   7. Sends confirmation notification            â”‚
â”‚                                                 â”‚
â”‚ â†’ Scheduled Job (Cron):                         â”‚
â”‚   â€¢ Runs weekly on Sunday 2 AM                  â”‚
â”‚   â€¢ Processes auto-payouts for all drivers      â”‚
â”‚   â€¢ Generates tax documents (if required)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


### **7. ADDITIONAL PREMIUM FEATURES**
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Multi-Delivery Optimization                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Shows option to "ACCEPT ANOTHER ORDER"        â”‚
â”‚   while on active delivery                      â”‚
â”‚ â†’ Smart stacking (max 3 orders)                 â”‚
â”‚ â†’ Route optimization visual                     â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ Algorithm considers:                          â”‚
â”‚   â€¢ Geographic proximity                        â”‚
â”‚   â€¢ Pickup/delivery time windows                â”‚
â”‚   â€¢ Item compatibility                          â”‚
â”‚   â€¢ Total route efficiency                      â”‚
â”‚ â†’ Increases earnings potential by 40%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Intelligent Shift Planning                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Heat map showing:                             â”‚
â”‚   â€¢ High-demand areas                           â”‚
â”‚   â€¢ Peak hours                                  â”‚
â”‚   â€¢ Surge pricing zones                         â”‚
â”‚ â†’ Earnings predictions                          â”‚
â”‚ â†’ Suggested work schedule                       â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ Machine Learning model trained on:            â”‚
â”‚   â€¢ Historical order data                       â”‚
â”‚   â€¢ Time patterns                               â”‚
â”‚   â€¢ Location trends                             â”‚
â”‚   â€¢ Seasonal variations                         â”‚
â”‚ â†’ Provides personalized recommendations         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Performance Gamification                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Achievement badges                            â”‚
â”‚ â†’ Leaderboards (daily/weekly/monthly)          â”‚
â”‚ â†’ Milestone rewards                             â”‚
â”‚ â†’ Progress to next tier                         â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ Tier system:                                  â”‚
â”‚   â€¢ Bronze (0-50 deliveries)                    â”‚
â”‚   â€¢ Silver (51-200 deliveries)                  â”‚
â”‚   â€¢ Gold (201-500 deliveries)                   â”‚
â”‚   â€¢ Platinum (500+ deliveries)                  â”‚
â”‚ â†’ Higher tiers = better order priority          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. In-App Support & Communication                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ 24/7 live chat support                        â”‚
â”‚ â†’ Voice call to customer (masked number)        â”‚
â”‚ â†’ FAQ & help center                             â”‚
â”‚ â†’ Report emergency                              â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ Twilio for call masking                       â”‚
â”‚ â†’ Support ticket system                         â”‚
â”‚ â†’ Priority escalation for emergencies           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Safety Features                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Emergency SOS button                          â”‚
â”‚ â†’ Share live location with emergency contact    â”‚
â”‚ â†’ Safe driving mode                             â”‚
â”‚ â†’ Break reminders                               â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ Monitors harsh braking/acceleration           â”‚
â”‚ â†’ Detects accidents via accelerometer           â”‚
â”‚ â†’ Automatic support alert on anomalies          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


---

## ğŸ“Š KEY APIs SUMMARY

### **Authentication**
- `POST /api/v1/auth/register` - Driver registration
- `POST /api/v1/auth/login` - Login
- `POST /api/v1/auth/verify-otp` - OTP verification
- `POST /api/v1/auth/refresh` - Refresh token
- `POST /api/v1/auth/logout` - Logout

### **Driver Management**
- `GET /api/v1/driver/profile` - Get profile
- `PUT /api/v1/driver/profile` - Update profile
- `POST /api/v1/driver/documents` - Upload documents
- `POST /api/v1/driver/status/online` - Go online
- `POST /api/v1/driver/status/offline` - Go offline
- `POST /api/v1/driver/location` - Update location

### **Orders**
- `GET /api/v1/orders/available` - Get nearby orders
- `POST /api/v1/orders/{id}/accept` - Accept order
- `POST /api/v1/orders/{id}/reject` - Reject order
- `GET /api/v1/orders/{id}/details` - Order details
- `POST /api/v1/orders/{id}/arrived-pickup` - Arrived at pickup
- `POST /api/v1/orders/{id}/verify-items` - Verify items
- `POST /api/v1/orders/{id}/arrived-delivery` - Arrived at delivery
- `POST /api/v1/orders/{id}/complete` - Complete delivery
- `POST /api/v1/orders/{id}/report-issue` - Report issue

### **Earnings**
- `GET /api/v1/driver/earnings/summary` - Earnings summary
- `GET /api/v1/driver/earnings/history` - Earnings history
- `GET /api/v1/driver/earnings/analytics` - Analytics
- `POST /api/v1/driver/payout/request` - Request payout

### **Notifications**
- `GET /api/v1/notifications` - Get notifications
- `PUT /api/v1/notifications/{id}/read` - Mark as read

---

## ğŸš€ PERFORMANCE OPTIMIZATIONS

1. **Frontend:**
   - Code splitting & lazy loading
   - Image lazy loading & caching
   - Memoization (useMemo, React.memo)
   - Virtualized lists (FlashList)
   - Debounced location updates
   - Offline-first architecture

2. **Backend:**
   - Redis caching (location, orders, driver status)
   - Database indexing (geospatial, time-based)
   - Connection pooling
   - CDN for static assets
   - Horizontal scaling with load balancers
   - Message queue for async processing

3. **Real-time:**
   - WebSocket connection pooling
   - Redis Pub/Sub for broadcasting
   - Efficient payload compression
   - Exponential backoff on reconnection

---

This architecture provides a **world-class, scalable, and premium** driver experience that exceeds modern delivery apps while being specifically optimized for Qatar's auto parts delivery market. The system handles high concurrency, ensures data consistency, and provides real-time updates with sub-second latency.

Would you like me to dive deeper into any specific component or create the actual implementation code for any module?
no need for AI for now. Replace google maps by openstreet map with dark theme and regenerate the entire archtecture well detailed

5:56 PM
QScrap Driver App - Premium Architecture & Business Flow
OpenStreetMap Dark Theme Integration
I'll design a cutting-edge, world-class driver application architecture using OpenStreetMap with a premium dark theme that exceeds modern delivery apps.

ğŸ“± FRONTEND ARCHITECTURE (React Native)
Core Technology Stack
React Native 0.73+ (New Architecture - Fabric & TurboModules)
â”œâ”€â”€ TypeScript 5.3+ (Strict mode)
â”œâ”€â”€ React Navigation 6+ (Native Stack)
â”œâ”€â”€ Redux Toolkit + RTK Query (State & API)
â”œâ”€â”€ React Query (Server state)
â”œâ”€â”€ Zustand (Lightweight local state)
â””â”€â”€ Reanimated 3 (Animations)
Premium Libraries & Features
Navigation & UX:

@react-navigation/native-stack - Native performance
react-native-gesture-handler - Smooth gestures
react-native-reanimated 3 - 120fps animations
react-native-skia - Custom graphics for maps overlay
lottie-react-native - Premium animations
Maps & Location (OpenStreetMap):

react-native-maps - Base map component
react-native-leaflet - OpenStreetMap integration
react-native-webview - For Leaflet rendering
@maplibre/maplibre-react-native - Modern OSM rendering
@mapbox/polyline - Route encoding/decoding
@turf/turf - Geospatial calculations
react-native-background-geolocation - Battery-optimized tracking
@react-native-community/geolocation - GPS access
Custom dark theme tiles from:
Mapbox Dark (self-hosted)
CartoDB Dark Matter
Custom styled tiles via Mapnik
Real-time Communication:

Socket.io-client - Real-time order updates
@react-native-firebase/messaging - Push notifications
react-native-webrtc - Voice/video customer support
Media & Scanning:

react-native-vision-camera V3 - High-performance camera
vision-camera-code-scanner - Barcode/QR scanning
react-native-image-picker - Proof of delivery photos
react-native-compressor - Image optimization
react-native-image-resizer - Image processing
Biometrics & Security:

react-native-biometrics - Fingerprint/Face ID
react-native-keychain - Secure credential storage
react-native-device-info - Device verification
crypto-js - End-to-end encryption
react-native-aes-crypto - AES encryption
Performance & Monitoring:

@sentry/react-native - Error tracking
react-native-performance - Performance monitoring
flipper - Development debugging
@shopify/flash-list - Ultra-fast lists
react-native-fast-image - Optimized image loading
Offline Capabilities:

@react-native-async-storage/async-storage - Local storage
react-native-mmkv - Ultra-fast key-value storage
WatermelonDB - Offline-first database
realm - Alternative offline database
Custom sync engine
react-native-sqlite-storage - SQLite for caching
Navigation & Routing:

react-native-track-player - Turn-by-turn audio
Custom OSRM (Open Source Routing Machine) integration
Graphhopper for advanced routing
Custom routing algorithm for multi-stop optimization
UI Components:

react-native-svg - Vector graphics
react-native-linear-gradient - Gradients
react-native-blur - Blur effects
react-native-shimmer-placeholder - Loading states
react-native-modal - Modal dialogs
react-native-bottom-sheet - Bottom sheets
react-native-toast-message - Toast notifications
Frontend Architecture Pattern
/src
â”œâ”€â”€ /app
â”‚   â”œâ”€â”€ /navigation
â”‚   â”‚   â”œâ”€â”€ RootNavigator.tsx
â”‚   â”‚   â”œâ”€â”€ AuthStack.tsx
â”‚   â”‚   â”œâ”€â”€ MainStack.tsx
â”‚   â”‚   â””â”€â”€ DeliveryStack.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /screens
â”‚   â”‚   â”œâ”€â”€ /auth
â”‚   â”‚   â”‚   â”œâ”€â”€ LoginScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OTPVerificationScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BiometricSetupScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OnboardingScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ DocumentUploadScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /home
â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ AvailableOrdersScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ActiveDeliveryScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ShiftPlanningScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /delivery
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderDetailsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ NavigationScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ LiveTrackingScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PickupScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ItemVerificationScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DeliveryScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProofOfDeliveryScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SignatureCaptureScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ IssueReportScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /earnings
â”‚   â”‚   â”‚   â”œâ”€â”€ EarningsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ EarningsAnalyticsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PayoutHistoryScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ InvoiceDetailsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BankAccountScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ PayoutRequestScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /performance
â”‚   â”‚   â”‚   â”œâ”€â”€ StatisticsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RatingsScreen.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BadgesScreen.tsx
â”‚   â”‚   â”‚   â””â”€â”€ LeaderboardScreen.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ /profile
â”‚   â”‚       â”œâ”€â”€ ProfileScreen.tsx
â”‚   â”‚       â”œâ”€â”€ DocumentsScreen.tsx
â”‚   â”‚       â”œâ”€â”€ VehicleInfoScreen.tsx
â”‚   â”‚       â”œâ”€â”€ SettingsScreen.tsx
â”‚   â”‚       â”œâ”€â”€ SupportScreen.tsx
â”‚   â”‚       â”œâ”€â”€ NotificationsScreen.tsx
â”‚   â”‚       â””â”€â”€ HelpCenterScreen.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /components
â”‚   â”‚   â”œâ”€â”€ /common
â”‚   â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Badge.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ LoadingOverlay.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ EmptyState.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ErrorBoundary.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SkeletonLoader.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Avatar.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Switch.tsx
â”‚   â”‚   â”‚   â””â”€â”€ BottomSheet.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /delivery
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderList.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DeliveryTimeline.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ItemsList.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ItemCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CustomerInfo.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ NavigationBar.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ETADisplay.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RoutePreview.tsx
â”‚   â”‚   â”‚   â””â”€â”€ StatusBanner.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /map
â”‚   â”‚   â”‚   â”œâ”€â”€ DarkOSMap.tsx              [MAIN MAP COMPONENT]
â”‚   â”‚   â”‚   â”œâ”€â”€ MapStyleProvider.tsx        [DARK THEME PROVIDER]
â”‚   â”‚   â”‚   â”œâ”€â”€ LiveMap.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RouteOverlay.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CustomMarker.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DriverMarker.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PickupMarker.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DeliveryMarker.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MarkerCluster.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ TrafficLayer.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ HeatmapLayer.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ GeofenceCircle.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RoutePolyline.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MapControls.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CompassButton.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ LocationButton.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ZoomControls.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /earnings
â”‚   â”‚   â”‚   â”œâ”€â”€ EarningsCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ EarningsChart.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ WeeklyChart.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DailyBreakdown.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PayoutSummary.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ TripEarningsCard.tsx
â”‚   â”‚   â”‚   â””â”€â”€ BonusBadge.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /camera
â”‚   â”‚   â”‚   â”œâ”€â”€ BarcodeScanner.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PhotoCapture.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SignaturePad.tsx
â”‚   â”‚   â”‚   â””â”€â”€ DocumentScanner.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ /performance
â”‚   â”‚       â”œâ”€â”€ StatCard.tsx
â”‚   â”‚       â”œâ”€â”€ ProgressRing.tsx
â”‚   â”‚       â”œâ”€â”€ RatingStars.tsx
â”‚   â”‚       â”œâ”€â”€ BadgeIcon.tsx
â”‚   â”‚       â””â”€â”€ LeaderboardItem.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /store
â”‚   â”‚   â”œâ”€â”€ /slices
â”‚   â”‚   â”‚   â”œâ”€â”€ authSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ driverSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ deliverySlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ ordersSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ locationSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ mapSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ earningsSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ notificationSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ performanceSlice.ts
â”‚   â”‚   â”‚   â””â”€â”€ settingsSlice.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /api
â”‚   â”‚   â”‚   â”œâ”€â”€ authApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ driverApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ deliveryApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ orderApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ locationApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ routingApi.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ earningsApi.ts
â”‚   â”‚   â”‚   â””â”€â”€ analyticsApi.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ /middleware
â”‚   â”‚   â”‚   â”œâ”€â”€ errorHandler.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ retry.ts
â”‚   â”‚   â”‚   â””â”€â”€ logger.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ store.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”œâ”€â”€ socket.service.ts
â”‚   â”‚   â”œâ”€â”€ location.service.ts
â”‚   â”‚   â”œâ”€â”€ osm.service.ts              [OSM INTEGRATION]
â”‚   â”‚   â”œâ”€â”€ routing.service.ts          [OSRM/GRAPHHOPPER]
â”‚   â”‚   â”œâ”€â”€ geocoding.service.ts        [NOMINATIM]
â”‚   â”‚   â”œâ”€â”€ tiles.service.ts            [TILE MANAGEMENT]
â”‚   â”‚   â”œâ”€â”€ notification.service.ts
â”‚   â”‚   â”œâ”€â”€ storage.service.ts
â”‚   â”‚   â”œâ”€â”€ biometric.service.ts
â”‚   â”‚   â”œâ”€â”€ sync.service.ts
â”‚   â”‚   â”œâ”€â”€ camera.service.ts
â”‚   â”‚   â”œâ”€â”€ encryption.service.ts
â”‚   â”‚   â””â”€â”€ analytics.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /hooks
â”‚   â”‚   â”œâ”€â”€ useLocation.ts
â”‚   â”‚   â”œâ”€â”€ useSocket.ts
â”‚   â”‚   â”œâ”€â”€ useMap.ts
â”‚   â”‚   â”œâ”€â”€ useRouting.ts
â”‚   â”‚   â”œâ”€â”€ useCamera.ts
â”‚   â”‚   â”œâ”€â”€ usePermissions.ts
â”‚   â”‚   â”œâ”€â”€ useOfflineSync.ts
â”‚   â”‚   â”œâ”€â”€ useBiometric.ts
â”‚   â”‚   â”œâ”€â”€ useOrientation.ts
â”‚   â”‚   â””â”€â”€ useNetworkStatus.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /utils
â”‚   â”‚   â”œâ”€â”€ validators.ts
â”‚   â”‚   â”œâ”€â”€ formatters.ts
â”‚   â”‚   â”œâ”€â”€ constants.ts
â”‚   â”‚   â”œâ”€â”€ helpers.ts
â”‚   â”‚   â”œâ”€â”€ geolocation.ts
â”‚   â”‚   â”œâ”€â”€ distance.ts
â”‚   â”‚   â”œâ”€â”€ encryption.ts
â”‚   â”‚   â””â”€â”€ performance.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /types
â”‚   â”‚   â”œâ”€â”€ order.types.ts
â”‚   â”‚   â”œâ”€â”€ delivery.types.ts
â”‚   â”‚   â”œâ”€â”€ user.types.ts
â”‚   â”‚   â”œâ”€â”€ location.types.ts
â”‚   â”‚   â”œâ”€â”€ map.types.ts
â”‚   â”‚   â”œâ”€â”€ route.types.ts
â”‚   â”‚   â”œâ”€â”€ earnings.types.ts
â”‚   â”‚   â””â”€â”€ api.types.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ /config
â”‚   â”‚   â”œâ”€â”€ osm.config.ts              [OSM CONFIGURATION]
â”‚   â”‚   â”œâ”€â”€ map-styles.ts              [DARK THEME STYLES]
â”‚   â”‚   â”œâ”€â”€ routing.config.ts
â”‚   â”‚   â””â”€â”€ tiles.config.ts
â”‚   â”‚
â”‚   â””â”€â”€ /theme
â”‚       â”œâ”€â”€ colors.ts
â”‚       â”œâ”€â”€ darkTheme.ts
â”‚       â”œâ”€â”€ typography.ts
â”‚       â”œâ”€â”€ spacing.ts
â”‚       â”œâ”€â”€ shadows.ts
â”‚       â””â”€â”€ animations.ts
â”‚
â”œâ”€â”€ /assets
â”‚   â”œâ”€â”€ /images
â”‚   â”œâ”€â”€ /icons
â”‚   â”œâ”€â”€ /animations (Lottie)
â”‚   â”œâ”€â”€ /sounds
â”‚   â””â”€â”€ /map-tiles (Cached tiles)
â”‚
â””â”€â”€ /config
    â”œâ”€â”€ env.ts
    â”œâ”€â”€ firebase.ts
    â””â”€â”€ sentry.ts
ğŸ—ºï¸ OPENSTREETMAP DARK THEME INTEGRATION
Map Configuration
typescript
// /src/config/osm.config.ts

export const OSM_CONFIG = {
  // Tile Servers (Dark Theme)
  tileServers: {
    primary: {
      // CartoDB Dark Matter (Best for delivery apps)
      url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      attribution: 'Â© OpenStreetMap contributors Â© CARTO',
      subdomains: ['a', 'b', 'c', 'd'],
      maxZoom: 19,
      minZoom: 3,
    },
    
    alternative: {
      // Mapbox Dark (Self-hosted or via Mapbox token)
      url: 'https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token={accessToken}',
      attribution: 'Â© Mapbox Â© OpenStreetMap',
      maxZoom: 22,
      minZoom: 0,
    },
    
    custom: {
      // Self-hosted tiles with custom dark styling
      url: 'https://tiles.qscrap.qa/dark/{z}/{x}/{y}.png',
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19,
    },
  },

  // Routing Services
  routing: {
    osrm: {
      url: 'https://router.project-osrm.org/route/v1',
      // Or self-hosted: 'https://osrm.qscrap.qa/route/v1'
      profile: 'driving',
    },
    
    graphhopper: {
      url: 'https://graphhopper.com/api/1/route',
      // Or self-hosted: 'https://routing.qscrap.qa/route'
      apiKey: process.env.GRAPHHOPPER_API_KEY,
      vehicle: 'car',
    },
  },

  // Geocoding (Address search)
  geocoding: {
    nominatim: {
      url: 'https://nominatim.openstreetmap.org/search',
      // Or self-hosted: 'https://geocode.qscrap.qa/search'
      format: 'json',
      countryCode: 'qa', // Qatar only
    },
  },

  // Reverse Geocoding
  reverseGeocoding: {
    url: 'https://nominatim.openstreetmap.org/reverse',
    format: 'json',
  },

  // Default map settings
  defaultCenter: {
    latitude: 25.2854, // Doha, Qatar
    longitude: 51.5310,
  },
  
  defaultZoom: 13,
  
  // Qatar bounding box for restricting map
  qatarBounds: {
    north: 26.1543,
    south: 24.4707,
    east: 51.6369,
    west: 50.7439,
  },
};
Dark Theme Map Styles
typescript
// /src/config/map-styles.ts

export const DARK_MAP_STYLE = {
  version: 8,
  name: 'QScrap Dark',
  
  sources: {
    'osm-tiles': {
      type: 'raster',
      tiles: [
        'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
        'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
        'https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
      ],
      tileSize: 256,
      attribution: 'Â© OpenStreetMap, Â© CARTO',
    },
  },
  
  layers: [
    {
      id: 'background',
      type: 'background',
      paint: {
        'background-color': '#0F1419', // Deep dark blue-gray
      },
    },
    {
      id: 'osm-tiles-layer',
      type: 'raster',
      source: 'osm-tiles',
      paint: {
        'raster-opacity': 1,
        'raster-brightness-min': 0,
        'raster-brightness-max': 1,
        'raster-contrast': 0.1,
        'raster-saturation': -0.2,
      },
    },
  ],
};

// Custom overlay colors for dark theme
export const MAP_OVERLAY_COLORS = {
  // Route colors
  activeRoute: '#10B981', // Emerald green
  alternativeRoute: '#6B7280', // Gray
  completedRoute: '#3B82F6', // Blue
  
  // Marker colors
  driverMarker: '#F59E0B', // Amber
  pickupMarker: '#8B5CF6', // Purple
  deliveryMarker: '#EF4444', // Red
  
  // Geofence
  geofenceStroke: '#10B981',
  geofenceFill: 'rgba(16, 185, 129, 0.1)',
  
  // Traffic
  trafficGreen: '#10B981',
  trafficYellow: '#F59E0B',
  trafficRed: '#EF4444',
  
  // Heatmap
  heatmapLow: '#3B82F6',
  heatmapMedium: '#F59E0B',
  heatmapHigh: '#EF4444',
  
  // UI elements
  controlBackground: 'rgba(31, 41, 55, 0.95)', // Dark gray with transparency
  controlBorder: '#374151',
  controlText: '#F9FAFB',
};

// Animation configurations
export const MAP_ANIMATIONS = {
  markerPulse: {
    duration: 2000,
    scale: [1, 1.2, 1],
    opacity: [1, 0.6, 1],
  },
  
  routeDrawing: {
    duration: 1500,
    easing: 'ease-in-out',
  },
  
  markerDrop: {
    duration: 600,
    easing: 'bounce',
  },
};
Custom Dark Map Component
typescript
// /src/components/map/DarkOSMap.tsx

import React, { useRef, useEffect, useState } from 'react';
import { StyleSheet, View, Platform } from 'react-native';
import MapView, { Marker, Polyline, Circle, PROVIDER_DEFAULT } from 'react-native-maps';
import { OSM_CONFIG, DARK_MAP_STYLE, MAP_OVERLAY_COLORS } from '@/config';

interface DarkOSMapProps {
  initialRegion?: Region;
  showsUserLocation?: boolean;
  followsUserLocation?: boolean;
  routes?: Route[];
  markers?: MapMarker[];
  onRegionChange?: (region: Region) => void;
  onMarkerPress?: (marker: MapMarker) => void;
  darkMode?: boolean;
}

export const DarkOSMap: React.FC<DarkOSMapProps> = ({
  initialRegion,
  showsUserLocation = true,
  followsUserLocation = false,
  routes = [],
  markers = [],
  onRegionChange,
  onMarkerPress,
  darkMode = true,
}) => {
  const mapRef = useRef<MapView>(null);
  const [currentRegion, setCurrentRegion] = useState(initialRegion);

  // Custom dark map style for react-native-maps
  const customMapStyle = [
    {
      elementType: 'geometry',
      stylers: [{ color: '#1a1a1a' }],
    },
    {
      elementType: 'labels.text.stroke',
      stylers: [{ color: '#0a0a0a' }],
    },
    {
      elementType: 'labels.text.fill',
      stylers: [{ color: '#8a8a8a' }],
    },
    {
      featureType: 'road',
      elementType: 'geometry',
      stylers: [{ color: '#2c2c2c' }],
    },
    {
      featureType: 'road',
      elementType: 'geometry.stroke',
      stylers: [{ color: '#212121' }],
    },
    {
      featureType: 'road.highway',
      elementType: 'geometry',
      stylers: [{ color: '#3c3c3c' }],
    },
    {
      featureType: 'water',
      elementType: 'geometry',
      stylers: [{ color: '#0f1419' }],
    },
    {
      featureType: 'poi',
      elementType: 'geometry',
      stylers: [{ color: '#1f1f1f' }],
    },
    {
      featureType: 'poi.park',
      elementType: 'geometry',
      stylers: [{ color: '#1a2e1a' }],
    },
  ];

  const handleRegionChangeComplete = (region: Region) => {
    setCurrentRegion(region);
    onRegionChange?.(region);
  };

  return (
    <View style={styles.container}>
      <MapView
        ref={mapRef}
        provider={PROVIDER_DEFAULT}
        style={styles.map}
        initialRegion={initialRegion || {
          latitude: OSM_CONFIG.defaultCenter.latitude,
          longitude: OSM_CONFIG.defaultCenter.longitude,
          latitudeDelta: 0.0922,
          longitudeDelta: 0.0421,
        }}
        customMapStyle={darkMode ? customMapStyle : []}
        showsUserLocation={showsUserLocation}
        showsMyLocationButton={false}
        showsCompass={false}
        showsScale={false}
        followsUserLocation={followsUserLocation}
        onRegionChangeComplete={handleRegionChangeComplete}
        rotateEnabled={true}
        pitchEnabled={true}
        loadingEnabled={true}
        loadingIndicatorColor={MAP_OVERLAY_COLORS.activeRoute}
        loadingBackgroundColor="#0F1419"
      >
        {/* Render routes */}
        {routes.map((route, index) => (
          <Polyline
            key={`route-${index}`}
            coordinates={route.coordinates}
            strokeColor={route.isActive ? MAP_OVERLAY_COLORS.activeRoute : MAP_OVERLAY_COLORS.alternativeRoute}
            strokeWidth={route.isActive ? 5 : 3}
            lineDashPattern={route.isActive ? [] : [10, 5]}
          />
        ))}

        {/* Render markers */}
        {markers.map((marker) => (
          <Marker
            key={marker.id}
            coordinate={marker.coordinate}
            title={marker.title}
            description={marker.description}
            onPress={() => onMarkerPress?.(marker)}
          >
            {marker.customIcon}
          </Marker>
        ))}
      </MapView>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#0F1419',
  },
  map: {
    ...StyleSheet.absoluteFillObject,
  },
});
Routing Service with OSRM
typescript
// /src/services/routing.service.ts

import { OSM_CONFIG } from '@/config';
import polyline from '@mapbox/polyline';

interface RoutePoint {
  latitude: number;
  longitude: number;
}

interface RouteResponse {
  coordinates: RoutePoint[];
  distance: number; // in meters
  duration: number; // in seconds
  geometry: string;
  instructions: TurnInstruction[];
}

class RoutingService {
  private baseUrl: string;

  constructor() {
    this.baseUrl = OSM_CONFIG.routing.osrm.url;
  }

  /**
   * Calculate route between multiple points using OSRM
   */
  async calculateRoute(
    waypoints: RoutePoint[],
    options: {
      alternatives?: boolean;
      steps?: boolean;
      overview?: 'full' | 'simplified' | 'false';
      geometries?: 'polyline' | 'geojson';
    } = {}
  ): Promise<RouteResponse> {
    try {
      const coordinates = waypoints
        .map((wp) => `${wp.longitude},${wp.latitude}`)
        .join(';');

      const params = new URLSearchParams({
        alternatives: String(options.alternatives ?? false),
        steps: String(options.steps ?? true),
        overview: options.overview ?? 'full',
        geometries: options.geometries ?? 'polyline',
      });

      const url = `${this.baseUrl}/driving/${coordinates}?${params}`;
      
      const response = await fetch(url);
      const data = await response.json();

      if (data.code !== 'Ok') {
        throw new Error(`OSRM Error: ${data.message}`);
      }

      const route = data.routes[0];
      
      // Decode polyline to coordinates
      const decodedCoords = polyline.decode(route.geometry);
      const coordinates = decodedCoords.map(([lat, lng]) => ({
        latitude: lat,
        longitude: lng,
      }));

      // Extract turn-by-turn instructions
      const instructions: TurnInstruction[] = route.legs[0].steps.map((step: any) => ({
        instruction: step.maneuver.instruction,
        distance: step.distance,
        duration: step.duration,
        type: step.maneuver.type,
        modifier: step.maneuver.modifier,
        location: {
          latitude: step.maneuver.location[1],
          longitude: step.maneuver.location[0],
        },
      }));

      return {
        coordinates,
        distance: route.distance,
        duration: route.duration,
        geometry: route.geometry,
        instructions,
      };
    } catch (error) {
      console.error('Routing error:', error);
      throw error;
    }
  }

  /**
   * Optimize route for multiple deliveries
   */
  async optimizeMultipleStops(
    start: RoutePoint,
    stops: RoutePoint[],
    end: RoutePoint
  ): Promise<RouteResponse> {
    const allPoints = [start, ...stops, end];
    
    // Use OSRM Trip service for optimization
    const coordinates = allPoints
      .map((pt) => `${pt.longitude},${pt.latitude}`)
      .join(';');

    const url = `${this.baseUrl.replace('/route/', '/trip/')}/driving/${coordinates}?source=first&destination=last&roundtrip=false&steps=true&overview=full&geometries=polyline`;
    
    const response = await fetch(url);
    const data = await response.json();

    if (data.code !== 'Ok') {
      throw new Error(`OSRM Trip Error: ${data.message}`);
    }

    const trip = data.trips[0];
    const decodedCoords = polyline.decode(trip.geometry);
    const coordinates = decodedCoords.map(([lat, lng]) => ({
      latitude: lat,
      longitude: lng,
    }));

    return {
      coordinates,
      distance: trip.distance,
      duration: trip.duration,
      geometry: trip.geometry,
      instructions: [],
    };
  }

  /**
   * Calculate ETA based on current location and destination
   */
  async calculateETA(
    from: RoutePoint,
    to: RoutePoint,
    considerTraffic: boolean = true
  ): Promise<{ duration: number; distance: number; eta: Date }> {
    const route = await this.calculateRoute([from, to], {
      alternatives: false,
      steps: false,
      overview: 'false',
    });

    // Add traffic multiplier (simplified)
    const trafficMultiplier = considerTraffic ? 1.2 : 1;
    const adjustedDuration = route.duration * trafficMultiplier;

    const eta = new Date();
    eta.setSeconds(eta.getSeconds() + adjustedDuration);

    return {
      duration: adjustedDuration,
      distance: route.distance,
      eta,
    };
  }
}

export const routingService = new RoutingService();
Geocoding Service with Nominatim
typescript
// /src/services/geocoding.service.ts

import { OSM_CONFIG } from '@/config';

interface GeocodingResult {
  latitude: number;
  longitude: number;
  displayName: string;
  address: {
    road?: string;
    suburb?: string;
    city?: string;
Continue

5:58 PM
state?: string;
country?: string;
postcode?: string;
};
}

class GeocodingService {
private nominatimUrl: string;

constructor() {
this.nominatimUrl = OSM_CONFIG.geocoding.nominatim.url;
}

/**

Search for address/location (Forward Geocoding) */ async searchAddress(query: string): Promise<GeocodingResult[]> { try { const params = new URLSearchParams({ q: query, format: 'json', addressdetails: '1', countrycodes: 'qa', // Restrict to Qatar limit: '10', }); const response = await fetch(${this.nominatimUrl}?${params}, { headers: { 'User-Agent': 'QScrap-Driver-App/1.0', }, }); const data = await response.json(); return data.map((item: any) => ({ latitude: parseFloat(item.lat), longitude: parseFloat(item.lon), displayName: item.display_name, address: { road: item.address.road, suburb: item.address.suburb, city: item.address.city || item.address.town, state: item.address.state, country: item.address.country, postcode: item.address.postcode, }, })); } catch (error) { console.error('Geocoding error:', error); return []; } }
/**

Reverse geocoding (coordinates to address) */ async reverseGeocode( latitude: number, longitude: number ): Promise<GeocodingResult | null> { try { const params = new URLSearchParams({ lat: latitude.toString(), lon: longitude.toString(), format: 'json', addressdetails: '1', }); const url = OSM_CONFIG.reverseGeocoding.url; const response = await fetch(${url}?${params}, { headers: { 'User-Agent': 'QScrap-Driver-App/1.0', }, }); const data = await response.json(); if (!data || data.error) { return null; } return { latitude: parseFloat(data.lat), longitude: parseFloat(data.lon), displayName: data.display_name, address: { road: data.address.road, suburb: data.address.suburb, city: data.address.city || data.address.town, state: data.address.state, country: data.address.country, postcode: data.address.postcode, }, }; } catch (error) { console.error('Reverse geocoding error:', error); return null; } } }
export const geocodingService = new GeocodingService();


---

## ğŸ”§ BACKEND ARCHITECTURE

### **Technology Stack**
Node.js 20+ LTS
â”œâ”€â”€ Fastify 4.x (High-performance API)
â”œâ”€â”€ TypeScript 5.3+
â”œâ”€â”€ PostgreSQL 16 with PostGIS (Geospatial data)
â”œâ”€â”€ Redis 7+ (Cache & Real-time)
â”œâ”€â”€ MongoDB 7 (Logs & Analytics)
â”œâ”€â”€ RabbitMQ (Message Queue)
â”œâ”€â”€ Socket.io (WebSocket)
â”œâ”€â”€ Docker + Kubernetes (Orchestration)
â””â”€â”€ Nginx (Reverse Proxy & Load Balancer)


### **Microservices Architecture**
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           API Gateway (Kong/Nginx)              â”‚
â”‚         SSL/TLS, Rate Limiting, Auth            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚  Auth   â”‚   â”‚ Driver â”‚   â”‚ Order  â”‚
â”‚ Service â”‚   â”‚Service â”‚   â”‚Service â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚      PostgreSQL 16 + PostGIS        â”‚
â”‚      (Primary Database)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


### **Backend Services Detail**
/backend
â”œâ”€â”€ /services
â”‚   â”‚
â”‚   â”œâ”€â”€ /auth-service (Port: 3001)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ otp.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ biometric.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ otp.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sms.service.ts (Twilio)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ hash.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /middleware
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ validate.middleware.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ rateLimit.middleware.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ session.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ device.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.routes.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /utils
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ errors.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validators.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ /driver-service (Port: 3002)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ driver.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ document.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ vehicle.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ status.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ driver.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ verification.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ s3.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ocr.service.ts (AWS Textract)
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ driver.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ document.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ vehicle.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ performance.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ driver.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â”œâ”€â”€ /order-service (Port: 3003)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ order.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ assignment.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ availability.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ order.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ assignment.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ matching.algorithm.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ notification.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ order.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ assignment.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ rejection.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ order.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â”œâ”€â”€ /delivery-service (Port: 3004)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ delivery.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pickup.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pod.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ issue.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ delivery.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ verification.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sla.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ workflow.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ delivery.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ timeline.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pod.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ issue.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ delivery.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â”œâ”€â”€ /location-service (Port: 3005)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ location.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tracking.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ geofence.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ location.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ geospatial.service.ts (PostGIS)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ eta.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ history.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ location.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tracking.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ geofence.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ location.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â”œâ”€â”€ /routing-service (Port: 3006) [NEW - OSM ROUTING]
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ routing.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ optimization.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ geocoding.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ osrm.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ graphhopper.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ nominatim.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ optimization.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ cache.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /algorithms
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dijkstra.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tsp-solver.ts (Traveling Salesman)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ multi-stop-optimizer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ route.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ waypoint.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ routing.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â”œâ”€â”€ /earnings-service (Port: 3007)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ earnings.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ payout.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ invoice.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ calculation.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ bonus.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ payout.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ payment-gateway.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tax.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ earnings.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ payout.model.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ transaction.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ invoice.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ earnings.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â”œâ”€â”€ /notification-service (Port: 3008)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notification.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ preference.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ push.service.ts (FCM)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sms.service.ts (Twilio)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ email.service.ts (SendGrid)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ whatsapp.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ template.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notification.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ preference.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ notification.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â”œâ”€â”€ /analytics-service (Port: 3009)
â”‚   â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”‚   â”œâ”€â”€ /controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ analytics.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ reporting.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ metrics.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ aggregation.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ml.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ export.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ metric.model.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ report.model.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ analytics.routes.ts
â”‚   â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â””â”€â”€ /communication-service (Port: 3010)
â”‚       â”œâ”€â”€ /src
â”‚       â”‚   â”œâ”€â”€ /controllers
â”‚       â”‚   â”‚   â”œâ”€â”€ chat.controller.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ call.controller.ts
â”‚       â”‚   â”‚   â””â”€â”€ support.controller.ts
â”‚       â”‚   â”œâ”€â”€ /services
â”‚       â”‚   â”‚   â”œâ”€â”€ chat.service.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ call-masking.service.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ ticket.service.ts
â”‚       â”‚   â”‚   â””â”€â”€ socket.service.ts
â”‚       â”‚   â”œâ”€â”€ /models
â”‚       â”‚   â”‚   â”œâ”€â”€ message.model.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ call.model.ts
â”‚       â”‚   â”‚   â””â”€â”€ ticket.model.ts
â”‚       â”‚   â”œâ”€â”€ /routes
â”‚       â”‚   â”‚   â””â”€â”€ communication.routes.ts
â”‚       â”‚   â””â”€â”€ server.ts
â”‚       â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ /api-gateway (Port: 3000)
â”‚   â”œâ”€â”€ /src
â”‚   â”‚   â”œâ”€â”€ /middleware
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ rateLimit.middleware.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ cors.middleware.ts
â”‚   â”‚   â”‚   â””â”€â”€ logger.middleware.ts
â”‚   â”‚   â”œâ”€â”€ /routes
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ /config
â”‚   â”‚   â”‚   â”œâ”€â”€ services.config.ts
â”‚   â”‚   â”‚   â””â”€â”€ proxy.config.ts
â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ /shared
â”‚   â”œâ”€â”€ /types
â”‚   â”‚   â”œâ”€â”€ common.types.ts
â”‚   â”‚   â”œâ”€â”€ api.types.ts
â”‚   â”‚   â””â”€â”€ events.types.ts
â”‚   â”œâ”€â”€ /utils
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â”œâ”€â”€ errors.ts
â”‚   â”‚   â””â”€â”€ validators.ts
â”‚   â”œâ”€â”€ /constants
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ /database
â”‚       â”œâ”€â”€ /migrations
â”‚       â”œâ”€â”€ /seeds
â”‚       â””â”€â”€ connection.ts
â”‚
â”œâ”€â”€ /infrastructure
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”œâ”€â”€ docker-compose.dev.yml
â”‚   â”œâ”€â”€ /kubernetes
â”‚   â”‚   â”œâ”€â”€ /deployments
â”‚   â”‚   â”œâ”€â”€ /services
â”‚   â”‚   â”œâ”€â”€ /configmaps
â”‚   â”‚   â””â”€â”€ /secrets
â”‚   â”œâ”€â”€ /terraform
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â””â”€â”€ /nginx
â”‚       â””â”€â”€ nginx.conf
â”‚
â””â”€â”€ /scripts
â”œâ”€â”€ setup.sh
â”œâ”€â”€ deploy.sh
â””â”€â”€ backup.sh


---

## ğŸ”„ COMPLETE BUSINESS FLOW WITH OSM

### **1. DRIVER ONBOARDING & AUTHENTICATION**
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Driver Registration                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (React Native):                        â”‚
â”‚ â†’ Screen: LoginScreen.tsx                       â”‚
â”‚ â†’ Driver enters Qatar phone number (+974)       â”‚
â”‚ â†’ Validates format: /^974\d{8}$/                â”‚
â”‚ â†’ Dispatches: authApi.register()                â”‚
â”‚                                                 â”‚
â”‚ Backend (Auth Service):                         â”‚
â”‚ â†’ POST /api/v1/auth/register                    â”‚
â”‚   Request Body: {                               â”‚
â”‚     phone: "+97431234567",                      â”‚
â”‚     countryCode: "QA"                           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Controller: auth.controller.ts                â”‚
â”‚   1. Validates phone number                     â”‚
â”‚   2. Checks if driver exists                    â”‚
â”‚   3. Generates 6-digit OTP                      â”‚
â”‚   4. Stores in Redis:                           â”‚
â”‚      Key: otp:{phone}                           â”‚
â”‚      Value: {code, attempts: 0, expiresAt}     â”‚
â”‚      TTL: 300 seconds (5 minutes)              â”‚
â”‚   5. Sends SMS via Twilio                       â”‚
â”‚                                                 â”‚
â”‚ â†’ Response: {                                   â”‚
â”‚     success: true,                              â”‚
â”‚     message: "OTP sent to +974****4567",        â”‚
â”‚     sessionId: "uuid-v4"                        â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ Frontend:                                       â”‚
â”‚ â†’ Navigates to: OTPVerificationScreen          â”‚
â”‚ â†’ Shows 6-digit input boxes                     â”‚
â”‚ â†’ Auto-focuses and auto-submits                 â”‚
â”‚ â†’ 60-second resend countdown                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. OTP Verification                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Driver enters OTP: "123456"                   â”‚
â”‚ â†’ Dispatches: authApi.verifyOTP()               â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/auth/verify-otp                  â”‚
â”‚   Body: { phone, otp, sessionId }              â”‚
â”‚                                                 â”‚
â”‚ â†’ Verification Logic:                           â”‚
â”‚   1. Retrieve OTP from Redis                    â”‚
â”‚   2. Check expiration                           â”‚
â”‚   3. Verify code matches                        â”‚
â”‚   4. Check attempts (max 3)                     â”‚
â”‚   5. If valid:                                  â”‚
â”‚      â€¢ Delete OTP from Redis                    â”‚
â”‚      â€¢ Check if driver exists in PostgreSQL     â”‚
â”‚      â€¢ If new: Create driver record             â”‚
â”‚        INSERT INTO drivers (                    â”‚
â”‚          phone, status, created_at              â”‚
â”‚        ) VALUES (                               â”‚
â”‚          '+97431234567', 'PENDING', NOW()       â”‚
â”‚        )                                        â”‚
â”‚      â€¢ Generate JWT tokens:                     â”‚
â”‚        accessToken: expires 1 hour              â”‚
â”‚        refreshToken: expires 30 days            â”‚
â”‚      â€¢ Store refresh token in Redis             â”‚
â”‚                                                 â”‚
â”‚ â†’ Response: {                                   â”‚
â”‚     accessToken: "eyJhbGc...",                  â”‚
â”‚     refreshToken: "eyJhbGc...",                 â”‚
â”‚     driver: {                                   â”‚
â”‚       id: "uuid",                               â”‚
â”‚       phone: "+97431234567",                    â”‚
â”‚       status: "PENDING",                        â”‚
â”‚       isProfileComplete: false                  â”‚
â”‚     }                                           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ Frontend:                                       â”‚
â”‚ â†’ Stores tokens in Keychain                     â”‚
â”‚ â†’ Updates Redux store                           â”‚
â”‚ â†’ Navigates based on status:                    â”‚
â”‚   â€¢ PENDING â†’ DocumentUploadScreen              â”‚
â”‚   â€¢ APPROVED â†’ DashboardScreen                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 3. Profile Completion â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend (ProfileScreen.tsx): â”‚ â”‚ â†’ Form fields: â”‚ â”‚ â€¢ Full Name (English & Arabic) â”‚ â”‚ â€¢ Email â”‚ â”‚ â€¢ Date of Birth â”‚ â”‚ â€¢ Profile Photo (Camera/Gallery) â”‚ â”‚ â”‚ â”‚ â†’ Dispatches: driverApi.updateProfile() â”‚ â”‚ â”‚ â”‚ Backend (Driver Service): â”‚ â”‚ â†’ PUT /api/v1/driver/profile â”‚ â”‚ Body: { â”‚ â”‚ fullName: "Ahmed Al-Said", â”‚ â”‚ fullNameAr: "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø³Ø¹ÙŠØ¯", â”‚ â”‚ email: "ahmed@example.com", â”‚ â”‚ dateOfBirth: "1995-05-15", â”‚ â”‚ profilePhoto: base64/url â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ â†’ Processing: â”‚ â”‚ 1. Validates all fields â”‚ â”‚ 2. Uploads photo to S3: â”‚ â”‚ Bucket: qscrap-driver-profiles â”‚ â”‚ Key: drivers/{id}/profile.jpg â”‚ â”‚ 3. Updates PostgreSQL: â”‚ â”‚ UPDATE drivers SET â”‚ â”‚ full_name = 'Ahmed Al-Said', â”‚ â”‚ email = 'ahmed@example.com', â”‚ â”‚ profile_photo_url = 's3://...', â”‚ â”‚ updated_at = NOW() â”‚ â”‚ WHERE id = '{driver_id}' â”‚ â”‚ â”‚ â”‚ â†’ Response: { success: true, driver: {...} } â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Document Upload & Verification               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (DocumentUploadScreen.tsx):            â”‚
â”‚ â†’ Required documents:                           â”‚
â”‚   1. Qatar ID (QID) - Front & Back             â”‚
â”‚   2. Driving License - Front & Back            â”‚
â”‚   3. Vehicle Registration (Istimara)           â”‚
â”‚   4. Vehicle Insurance                          â”‚
â”‚                                                 â”‚
â”‚ â†’ For each document:                            â”‚
â”‚   â€¢ Camera opens (Vision Camera)                â”‚
â”‚   â€¢ Auto-capture when document detected         â”‚
â”‚   â€¢ Quality check (blur, lighting)             â”‚
â”‚   â€¢ Crop and optimize                           â”‚
â”‚   â€¢ Upload immediately                          â”‚
â”‚                                                 â”‚
â”‚ â†’ Component: DocumentScanner.tsx                â”‚
â”‚   Uses react-native-vision-camera with          â”‚
â”‚   ML Kit for document detection                 â”‚
â”‚                                                 â”‚
â”‚ Backend (Driver Service):                       â”‚
â”‚ â†’ POST /api/v1/driver/documents                 â”‚
â”‚   Content-Type: multipart/form-data             â”‚
â”‚   Body: {                                       â”‚
â”‚     documentType: "QID_FRONT",                  â”‚
â”‚     file: binary,                               â”‚
â”‚     metadata: {                                 â”‚
â”‚       capturedAt: timestamp,                    â”‚
â”‚       deviceInfo: {...}                         â”‚
â”‚     }                                           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Processing Flow:                              â”‚
â”‚   1. Validate file size (max 10MB)              â”‚
â”‚   2. Validate mime type (image/jpeg, image/png) â”‚
â”‚   3. Generate unique filename                   â”‚
â”‚   4. Upload to S3:                              â”‚
â”‚      Bucket: qscrap-driver-documents            â”‚
â”‚      Key: drivers/{id}/docs/{type}-{timestamp}.jpgâ”‚
â”‚   5. Extract text using AWS Textract:          â”‚
â”‚      â€¢ QID Number                               â”‚
â”‚      â€¢ Name                                     â”‚
â”‚      â€¢ Expiry Date                              â”‚
â”‚      â€¢ License Number                           â”‚
â”‚   6. Store in PostgreSQL:                       â”‚
â”‚      INSERT INTO driver_documents (             â”‚
â”‚        driver_id, type, file_url,               â”‚
â”‚        extracted_data, status,                  â”‚
â”‚        uploaded_at                              â”‚
â”‚      ) VALUES (...)                             â”‚
â”‚   7. Update driver verification status          â”‚
â”‚   8. Create admin review task                   â”‚
â”‚                                                 â”‚
â”‚ â†’ Auto-Verification Logic:                      â”‚
â”‚   â€¢ Compare extracted name with profile         â”‚
â”‚   â€¢ Validate QID format: /^\d{11}$/            â”‚
â”‚   â€¢ Check expiry dates (must be > 6 months)    â”‚
â”‚   â€¢ Verify age (must be 21+)                    â”‚
â”‚   â€¢ Face matching (profile photo vs QID)       â”‚
â”‚                                                 â”‚
â”‚ â†’ If all checks pass:                           â”‚
â”‚   UPDATE drivers SET status = 'APPROVED'        â”‚
â”‚ â†’ If any fail:                                  â”‚
â”‚   Create manual_review_task                     â”‚
â”‚                                                 â”‚
â”‚ â†’ WebSocket notification to driver:             â”‚
â”‚   socket.emit('verification_status', {          â”‚
â”‚     status: 'UNDER_REVIEW',                     â”‚
â”‚     estimatedTime: '24-48 hours'                â”‚
â”‚   })                                            â”‚
â”‚                                                 â”‚
â”‚ Frontend:                                       â”‚
â”‚ â†’ Shows upload progress                         â”‚
â”‚ â†’ Real-time status updates                      â”‚
â”‚ â†’ Success animation on completion               â”‚
â”‚ â†’ Navigates to: WaitingApprovalScreen           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Vehicle Information                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (VehicleInfoScreen.tsx):               â”‚
â”‚ â†’ Form fields:                                  â”‚
â”‚   â€¢ Vehicle Type (Car/Motorcycle/Van)          â”‚
â”‚   â€¢ Make & Model (Dropdown)                     â”‚
â”‚   â€¢ Year                                        â”‚
â”‚   â€¢ Color                                       â”‚
â”‚   â€¢ License Plate Number                        â”‚
â”‚   â€¢ Vehicle Photos (4 angles)                   â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/driver/vehicle                   â”‚
â”‚   Body: {                                       â”‚
â”‚     type: "CAR",                                â”‚
â”‚     make: "Toyota",                             â”‚
â”‚     model: "Camry",                             â”‚
â”‚     year: 2020,                                 â”‚
â”‚     color: "White",                             â”‚
â”‚     plateNumber: "123456",                      â”‚
â”‚     photos: [url1, url2, url3, url4]           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Stores in vehicle table with PostGIS:         â”‚
â”‚   CREATE TABLE vehicles (                       â”‚
â”‚     id UUID PRIMARY KEY,                        â”‚
â”‚     driver_id UUID REFERENCES drivers(id),      â”‚
â”‚     type vehicle_type,                          â”‚
â”‚     make VARCHAR(50),                           â”‚
â”‚     model VARCHAR(50),                          â”‚
â”‚     capacity_weight DECIMAL,                    â”‚
â”‚     capacity_volume DECIMAL,                    â”‚
â”‚     current_location GEOGRAPHY(POINT),          â”‚
â”‚     created_at TIMESTAMP                        â”‚
â”‚   )                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Biometric Setup                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (BiometricSetupScreen.tsx):            â”‚
â”‚ â†’ Checks device capability:                     â”‚
â”‚   const { available, biometryType } =           â”‚
â”‚     await ReactNativeBiometrics.isSensorAvailable()â”‚
â”‚                                                 â”‚
â”‚ â†’ Shows appropriate UI:                         â”‚
â”‚   â€¢ Face ID (iOS)                               â”‚
â”‚   â€¢ Touch ID (iOS)                              â”‚
â”‚   â€¢ Fingerprint (Android)                       â”‚
â”‚                                                 â”‚
â”‚ â†’ On enable:                                    â”‚
â”‚   1. Creates biometric keys                     â”‚
â”‚   2. Tests authentication                       â”‚
â”‚   3. Stores preference locally                  â”‚
â”‚   4. Notifies backend                           â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/driver/biometric/enable          â”‚
â”‚   Body: {                                       â”‚
â”‚     deviceId: "unique-device-id",               â”‚
â”‚     biometryType: "FACE_ID",                    â”‚
â”‚     publicKey: "..." // For verification        â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Stores in devices table:                      â”‚
â”‚   INSERT INTO driver_devices (                  â”‚
â”‚     driver_id, device_id, biometric_enabled,    â”‚
â”‚     device_info, registere

Continue

6:00 PM
d_at                â”‚
â”‚   ) VALUES (...)                                â”‚
â”‚                                                 â”‚
â”‚ â†’ Response: { success: true }                   â”‚
â”‚                                                 â”‚
â”‚ Frontend:                                       â”‚
â”‚ â†’ Shows success message                         â”‚
â”‚ â†’ Navigates to: DashboardScreen                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


### **2. GOING ONLINE & ORDER DISCOVERY WITH OSM**
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 1. Driver Goes Online â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend (DashboardScreen.tsx): â”‚ â”‚ â†’ Component: OnlineToggle.tsx â”‚ â”‚ â†’ Driver taps "GO ONLINE" switch â”‚ â”‚ â”‚ â”‚ â†’ Pre-flight checks: â”‚ â”‚ 1. Location permission granted? â”‚ â”‚ 2. Internet connected? â”‚ â”‚ 3. Battery > 20%? â”‚ â”‚ 4. All documents valid? â”‚ â”‚ â”‚ â”‚ â†’ Start location tracking: â”‚ â”‚ await BackgroundGeolocation.start({ â”‚ â”‚ distanceFilter: 50, // meters â”‚ â”‚ stopTimeout: 5, // minutes â”‚ â”‚ desiredAccuracy: BackgroundGeolocation â”‚ â”‚ .HIGH_ACCURACY, â”‚ â”‚ stationaryRadius: 25, â”‚ â”‚ activityType: 'AutomotiveNavigation', â”‚ â”‚ preventSuspend: true, â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ â†’ Get current location: â”‚ â”‚ const position = await â”‚ â”‚ Geolocation.getCurrentPosition() â”‚ â”‚ â”‚ â”‚ â†’ Connect WebSocket: â”‚ â”‚ socket.connect() â”‚ â”‚ socket.emit('driver:online', { â”‚ â”‚ driverId, â”‚ â”‚ location: { â”‚ â”‚ lat: position.coords.latitude, â”‚ â”‚ lng: position.coords.longitude â”‚ â”‚ } â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ â†’ API call: â”‚ â”‚ POST /api/v1/driver/status/online â”‚ â”‚ Body: { â”‚ â”‚ location: { lat: 25.2854, lng: 51.5310 }, â”‚ â”‚ heading: 45, â”‚ â”‚ speed: 0, â”‚ â”‚ accuracy: 5 â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Backend (Driver Service): â”‚ â”‚ â†’ Controller: status.controller.ts â”‚ â”‚ 1. Validate driver is approved â”‚ â”‚ 2. Update driver status in PostgreSQL: â”‚ â”‚ UPDATE drivers SET â”‚ â”‚ status = 'ONLINE', â”‚ â”‚ last_online_at = NOW(), â”‚ â”‚ current_location = ST_SetSRID( â”‚ â”‚ ST_MakePoint(51.5310, 25.2854), â”‚ â”‚ 4326 â”‚ â”‚ ) â”‚ â”‚ WHERE id = '{driver_id}' â”‚ â”‚ â”‚ â”‚ 3. Store in Redis (fast access): â”‚ â”‚ HSET driver:{id} status ONLINE â”‚ â”‚ GEOADD qatar:drivers 51.5310 25.2854 â”‚ â”‚ {driver_id} â”‚ â”‚ SET driver:{id}:online_since {timestamp} â”‚ â”‚ â”‚ â”‚ 4. Publish event to RabbitMQ: â”‚ â”‚ Exchange: driver.events â”‚ â”‚ Routing Key: driver.online â”‚ â”‚ Message: { â”‚ â”‚ driverId, timestamp, location â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ 5. Start periodic location updates (every 10s)â”‚ â”‚ 6. Subscribe driver to order channels â”‚ â”‚ 7. Send pending order offers if any â”‚ â”‚ â”‚ â”‚ â†’ WebSocket broadcasts: â”‚ â”‚ â€¢ To Order Assignment Service: â”‚ â”‚ "New driver available" â”‚ â”‚ â€¢ To Analytics Service: â”‚ â”‚ "Driver went online" â”‚ â”‚ â”‚ â”‚ Frontend: â”‚ â”‚ â†’ Updates UI: â”‚ â”‚ â€¢ Toggle shows "ONLINE" (green) â”‚ â”‚ â€¢ Shows live timer "Online: 00:00:05" â”‚ â”‚ â€¢ Displays current location on OSM map â”‚ â”‚ â€¢ Shows earnings counter: "Today: 0 QAR" â”‚ â”‚ â€¢ Enables "Available Orders" tab â”‚ â”‚ â”‚ â”‚ â†’ Starts periodic heartbeat (every 30s): â”‚ â”‚ setInterval(() => { â”‚ â”‚ socket.emit('heartbeat', { driverId }) â”‚ â”‚ }, 30000) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 2. Real-time Location Tracking with OSM â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend (Location Service): â”‚ â”‚ â†’ Background location listener: â”‚ â”‚ BackgroundGeolocation.onLocation( â”‚ â”‚ async (location) => { â”‚ â”‚ const { latitude, longitude, heading, â”‚ â”‚ speed, accuracy } = location.coords â”‚ â”‚ â”‚ â”‚ // Batch updates (every 10 seconds) â”‚ â”‚ locationBuffer.push({ â”‚ â”‚ lat: latitude, â”‚ â”‚ lng: longitude, â”‚ â”‚ heading, â”‚ â”‚ speed, â”‚ â”‚ accuracy, â”‚ â”‚ timestamp: Date.now() â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ if (locationBuffer.length >= 5 || â”‚ â”‚ Date.now() - lastUpdate > 10000) { â”‚ â”‚ await sendLocationBatch() â”‚ â”‚ } â”‚ â”‚ } â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ â†’ Send location batch: â”‚ â”‚ POST /api/v1/driver/location/batch â”‚ â”‚ Body: { â”‚ â”‚ locations: [ â”‚ â”‚ { â”‚ â”‚ lat: 25.2854, â”‚ â”‚ lng: 51.5310, â”‚ â”‚ heading: 90, â”‚ â”‚ speed: 15.5, // m/s â”‚ â”‚ accuracy: 5, â”‚ â”‚ timestamp: 1704902400000 â”‚ â”‚ }, â”‚ â”‚ // ... more locations â”‚ â”‚ ] â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Backend (Location Service): â”‚ â”‚ â†’ Controller: location.controller.ts â”‚ â”‚ â”‚ â”‚ â†’ Processing each location: â”‚ â”‚ FOR EACH location IN batch: â”‚ â”‚ 1. Validate coordinates are in Qatar: â”‚ â”‚ IF NOT ST_Contains( â”‚ â”‚ qatar_boundary_polygon, â”‚ â”‚ ST_Point(lng, lat) â”‚ â”‚ ) THEN reject â”‚ â”‚ â”‚ â”‚ 2. Update Redis (real-time): â”‚ â”‚ GEOADD qatar:drivers lng lat driver_id â”‚ â”‚ HSET driver:{id}:location â”‚ â”‚ lat {lat} â”‚ â”‚ lng {lng} â”‚ â”‚ heading {heading} â”‚ â”‚ speed {speed} â”‚ â”‚ updated_at {timestamp} â”‚ â”‚ EXPIRE driver:{id}:location 300 â”‚ â”‚ â”‚ â”‚ 3. Store in TimescaleDB (history): â”‚ â”‚ INSERT INTO location_history ( â”‚ â”‚ driver_id, location, heading, â”‚ â”‚ speed, accuracy, recorded_at â”‚ â”‚ ) VALUES ( â”‚ â”‚ '{driver_id}', â”‚ â”‚ ST_SetSRID( â”‚ â”‚ ST_MakePoint(lng, lat), 4326 â”‚ â”‚ ), â”‚ â”‚ heading, speed, accuracy, timestamp â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ 4. Check geofences: â”‚ â”‚ SELECT gf.* FROM geofences gf â”‚ â”‚ WHERE ST_DWithin( â”‚ â”‚ gf.boundary, â”‚ â”‚ ST_Point(lng, lat)::geography, â”‚ â”‚ gf.radius â”‚ â”‚ ) AND gf.driver_id = '{driver_id}' â”‚ â”‚ â”‚ â”‚ IF geofence entered/exited: â”‚ â”‚ â€¢ Trigger geofence event â”‚ â”‚ â€¢ Notify relevant services â”‚ â”‚ â”‚ â”‚ 5. Update active delivery ETA: â”‚ â”‚ IF driver has active delivery: â”‚ â”‚ â€¢ Calculate distance to destination â”‚ â”‚ â€¢ Call OSRM for ETA update: â”‚ â”‚ GET /route/v1/driving/{current}; â”‚ â”‚ {destination} â”‚ â”‚ â€¢ Broadcast ETA to customer: â”‚ â”‚ socket.to(customer_id) â”‚ â”‚ .emit('driver:eta', {eta}) â”‚ â”‚ â”‚ â”‚ 6. Publish to Redis Pub/Sub: â”‚ â”‚ PUBLISH channel:driver:{id}:location â”‚ â”‚ JSON.stringify({lat, lng, heading}) â”‚ â”‚ â”‚ â”‚ â†’ Response: { â”‚ â”‚ success: true, â”‚ â”‚ processed: 5 â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ â†’ Subscribers receive location updates: â”‚ â”‚ â€¢ Customer tracking their order â”‚ â”‚ â€¢ Operations dashboard â”‚ â”‚ â€¢ Analytics service â”‚ â”‚ â”‚ â”‚ Frontend Map Update: â”‚ â”‚ â†’ Updates driver marker on OSM map: â”‚ â”‚ <Marker â”‚ â”‚ coordinate={{ â”‚ â”‚ latitude: location.lat, â”‚ â”‚ longitude: location.lng â”‚ â”‚ }} â”‚ â”‚ rotation={location.heading} â”‚ â”‚ anchor={{ x: 0.5, y: 0.5 }} â”‚ â”‚ > â”‚ â”‚ <DriverMarkerIcon /> â”‚ â”‚ </Marker> â”‚ â”‚ â”‚ â”‚ â†’ Smooth animation: â”‚ â”‚ marker.animateMarkerToCoordinate( â”‚ â”‚ newCoordinate, â”‚ â”‚ 500 // ms â”‚ â”‚ ) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 3. Available Orders Feed with OSM â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend (AvailableOrdersScreen.tsx): â”‚ â”‚ â†’ Auto-refreshing list (every 5 seconds) â”‚ â”‚ â†’ Pull-to-refresh enabled â”‚ â”‚ â”‚ â”‚ â†’ API call: â”‚ â”‚ GET /api/v1/orders/available â”‚ â”‚ Query params: { â”‚ â”‚ lat: 25.2854, â”‚ â”‚ lng: 51.5310, â”‚ â”‚ radius: 10000, // meters â”‚ â”‚ limit: 20 â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Backend (Order Service): â”‚ â”‚ â†’ Controller: availability.controller.ts â”‚ â”‚ â”‚ â”‚ â†’ Query orders with PostGIS: â”‚ â”‚ SELECT â”‚ â”‚ o.id, o.order_number, â”‚ â”‚ o.pickup_address, o.delivery_address, â”‚ â”‚ o.customer_id, o.garage_id, â”‚ â”‚ o.items_count, o.estimated_weight, â”‚ â”‚ o.special_instructions, â”‚ â”‚ o.created_at, â”‚ â”‚ â”‚ â”‚ -- Pickup location â”‚ â”‚ ST_Y(o.pickup_location::geometry) as â”‚ â”‚ pickup_lat, â”‚ â”‚ ST_X(o.pickup_location::geometry) as â”‚ â”‚ pickup_lng, â”‚ â”‚ â”‚ â”‚ -- Delivery location â”‚ â”‚ ST_Y(o.delivery_location::geometry) as â”‚ â”‚ delivery_lat, â”‚ â”‚ ST_X(o.delivery_location::geometry) as â”‚ â”‚ delivery_lng, â”‚ â”‚ â”‚ â”‚ -- Distance to pickup (in meters) â”‚ â”‚ ST_Distance( â”‚ â”‚ o.pickup_location, â”‚ â”‚ ST_SetSRID(ST_MakePoint($2, $1), 4326) â”‚ â”‚ ::geography â”‚ â”‚ ) as distance_to_pickup, â”‚ â”‚ â”‚ â”‚ -- Total delivery distance â”‚ â”‚ ST_Distance( â”‚ â”‚ o.pickup_location, â”‚ â”‚ o.delivery_location â”‚ â”‚ ) as delivery_distance, â”‚ â”‚ â”‚ â”‚ -- Customer rating â”‚ â”‚ c.rating as customer_rating, â”‚ â”‚ c.total_orders as customer_order_count, â”‚ â”‚ â”‚ â”‚ -- Garage info â”‚ â”‚ g.name as garage_name, â”‚ â”‚ g.phone as garage_phone â”‚ â”‚ â”‚ â”‚ FROM orders o â”‚ â”‚ JOIN customers c ON o.customer_id = c.id â”‚ â”‚ JOIN garages g ON o.garage_id = g.id â”‚ â”‚ â”‚ â”‚ WHERE â”‚ â”‚ o.status = 'READY_FOR_PICKUP' â”‚ â”‚ AND o.assigned_driver_id IS NULL â”‚ â”‚ â”‚ â”‚ -- Within radius of driver â”‚ â”‚ AND ST_DWithin( â”‚ â”‚ o.pickup_location, â”‚ â”‚ ST_SetSRID(ST_MakePoint($2, $1), 4326) â”‚ â”‚ ::geography, â”‚ â”‚ $3 -- radius parameter â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ -- Match vehicle type â”‚ â”‚ AND o.required_vehicle_type IN ( â”‚ â”‚ SELECT vehicle_type â”‚ â”‚ FROM driver_vehicles â”‚ â”‚ WHERE driver_id = $4 â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ -- Not previously rejected by this driver â”‚ â”‚ AND NOT EXISTS ( â”‚ â”‚ SELECT 1 FROM order_rejections â”‚ â”‚ WHERE order_id = o.id â”‚ â”‚ AND driver_id = $4 â”‚ â”‚ AND rejected_at > NOW() - INTERVAL '1 hour'â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ ORDER BY â”‚ â”‚ distance_to_pickup ASC, â”‚ â”‚ o.priority DESC, â”‚ â”‚ o.created_at ASC â”‚ â”‚ â”‚ â”‚ LIMIT $5 â”‚ â”‚ â”‚ â”‚ â†’ For each order, calculate earnings: â”‚ â”‚ earnings = calculateOrderEarnings({ â”‚ â”‚ pickupDistance: distance_to_pickup, â”‚ â”‚ deliveryDistance: delivery_distance, â”‚ â”‚ itemsCount: items_count, â”‚ â”‚ weight: estimated_weight, â”‚ â”‚ timeOfDay: current_hour, â”‚ â”‚ isExpress: order.is_express â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ â†’ Get route preview from OSRM: â”‚ â”‚ For top 5 orders: â”‚ â”‚ route = await osrmService.calculateRoute([ â”‚ â”‚ { lat: driver_lat, lng: driver_lng }, â”‚ â”‚ { lat: pickup_lat, lng: pickup_lng }, â”‚ â”‚ { lat: delivery_lat, lng: delivery_lng } â”‚ â”‚ ]) â”‚ â”‚ â”‚ â”‚ â†’ Response: { â”‚ â”‚ orders: [ â”‚ â”‚ { â”‚ â”‚ id: "uuid", â”‚ â”‚ orderNumber: "QS-2026-0001", â”‚ â”‚ pickup: { â”‚ â”‚ address: "Al Sadd Auto Parts", â”‚ â”‚ location: { lat: 25.28, lng: 51.53 }, â”‚ â”‚ distance: 1200, // meters from driver â”‚ â”‚ eta: 180 // seconds â”‚ â”‚ }, â”‚ â”‚ delivery: { â”‚ â”‚ address: "Building 15, Zone 41", â”‚ â”‚ location: { lat: 25.30, lng: 51.55 }, â”‚ â”‚ distance: 3500, // from pickup â”‚ â”‚ eta: 420 â”‚ â”‚ }, â”‚ â”‚ items: { â”‚ â”‚ count: 3, â”‚ â”‚ weight: 12.5, // kg â”‚ â”‚ types: ["Engine Parts", "Filters"] â”‚ â”‚ }, â”‚ â”‚ earnings: { â”‚ â”‚ base: 25, â”‚ â”‚ distance: 15, â”‚ â”‚ surge: 0, â”‚ â”‚ total: 40 // QAR â”‚ â”‚ }, â”‚ â”‚ customer: { â”‚ â”‚ rating: 4.8, â”‚ â”‚ orderCount: 15 â”‚ â”‚ }, â”‚ â”‚ garage: { â”‚ â”‚ name: "Al Sadd Auto Parts", â”‚ â”‚ phone: "+97444123456" â”‚ â”‚ }, â”‚ â”‚ routePreview: { â”‚ â”‚ coordinates: [...], // For map â”‚ â”‚ totalDistance: 4700, â”‚ â”‚ totalDuration: 600 â”‚ â”‚ }, â”‚ â”‚ priority: "NORMAL", // or "HIGH" â”‚ â”‚ createdAt: "2026-01-10T10:30:00Z" â”‚ â”‚ }, â”‚ â”‚ // ... more orders â”‚ â”‚ ], â”‚ â”‚ total: 15, â”‚ â”‚ hasMore: true â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Frontend Rendering: â”‚ â”‚ â†’ Component: OrderCard.tsx â”‚ â”‚ â€¢ Shows mini OSM map with route â”‚ â”‚ â€¢ Pickup marker (purple) â”‚ â”‚ â€¢ Delivery marker (red) â”‚ â”‚ â€¢ Driver location (amber) â”‚ â”‚ â€¢ Route polyline (green) â”‚ â”‚ â”‚ â”‚ â†’ List item displays: â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ [Map Preview with Route] â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ ğŸ“ Pickup: Al Sadd Auto Parts â”‚ â”‚ â”‚ â”‚ 1.2 km away â€¢ ~3 min â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ ğŸ“ Delivery: Building 15, Zone 41 â”‚ â”‚ â”‚ â”‚ 3.5 km from pickup â€¢ ~7 min â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ ğŸ“¦ 3 items â€¢ 12.5 kg â”‚ â”‚ â”‚ â”‚ â­ Customer: 4.8 (15 orders) â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ ğŸ’° Estimated Earnings: 40 QAR â”‚ â”‚ â”‚ â”‚ Base: 25 â€¢ Distance: 15 â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ [VIEW DETAILS] â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â†’ On tap: Navigate to OrderDetailsScreen â”‚ â”‚ with full map view â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


### **3. ORDER ASSIGNMENT & ACCEPTANCE WITH OSM**
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 1. Smart Order Assignment (Push) â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Trigger: New order created OR driver goes onlineâ”‚ â”‚ â”‚ â”‚ Backend (Order Assignment Service): â”‚ â”‚ â†’ Service: assignment.service.ts â”‚ â”‚ â”‚ â”‚ â†’ Algorithm: matching.algorithm.ts â”‚ â”‚ INPUT: order_id â”‚ â”‚ â”‚ â”‚ STEP 1: Find nearby drivers â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ nearbyDrivers = GEORADIUS â”‚ â”‚ qatar:drivers â”‚ â”‚ {order.pickup_lng} â”‚ â”‚ {order.pickup_lng} â”‚ â”‚ 5 KM â”‚ â”‚ WITHDIST ASC â”‚ â”‚ â”‚ â”‚ STEP 2: Filter eligible drivers â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ FOR EACH driver IN nearbyDrivers: â”‚ â”‚ â€¢ status == 'ONLINE' â”‚ â”‚ â€¢ vehicle_type matches order â”‚ â”‚ â€¢ NOT in active delivery â”‚ â”‚ â€¢ NOT rejected this order recently â”‚ â”‚ â€¢ Available capacity â”‚ â”‚ â”‚ â”‚ STEP 3: Score each driver â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ FOR EACH eligible_driver: â”‚ â”‚ score = 0 â”‚ â”‚ â”‚ â”‚ // Distance score (40% weight) â”‚ â”‚ distanceScore = (1 - distance/5000) * 40 â”‚ â”‚ score += distanceScore â”‚ â”‚ â”‚ â”‚ // Acceptance rate (20% weight) â”‚ â”‚ acceptanceScore = acceptance_rate * 20 â”‚ â”‚ score += acceptanceScore â”‚ â”‚ â”‚ â”‚ // Customer satisfaction (20% weight) â”‚ â”‚ ratingScore = (avg_rating / 5) * 20 â”‚ â”‚ score += ratingScore â”‚ â”‚ â”‚ â”‚ // Current load (10% weight) â”‚ â”‚ loadScore = (1 - active_orders/3) * 10 â”‚ â”‚ score += loadScore â”‚ â”‚ â”‚ â”‚ // Completion rate (10% weight) â”‚ â”‚ completionScore = completion_rate * 10 â”‚ â”‚ score += completionScore â”‚ â”‚ â”‚ â”‚ // Bonus for top performers â”‚ â”‚ IF driver.tier == 'PLATINUM': â”‚ â”‚ score += 5 â”‚ â”‚ â”‚ â”‚ STEP 4: Sort by score â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ rankedDrivers = sort(drivers, by: score DESC) â”‚ â”‚ topDrivers = rankedDrivers.slice(0, 5) â”‚ â”‚ â”‚ â”‚ STEP 5: Sequential offering â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ FOR index, driver IN topDrivers: â”‚ â”‚ 1. Create offer lock in Redis: â”‚ â”‚ SETEX order:{id}:offered_to â”‚ â”‚ 30 {driver.id} â”‚ â”‚ â”‚ â”‚ 2. Store offer in database: â”‚ â”‚ INSERT INTO order_offers ( â”‚ â”‚ order_id, driver_id, offer_rank, â”‚ â”‚ offered_at, expires_at â”‚ â”‚ ) VALUES ( â”‚ â”‚ order_id, driver.id, index + 1, â”‚ â”‚ NOW(), NOW() + INTERVAL '30 seconds' â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ 3. Calculate route for driver: â”‚ â”‚ route = await osrmService.calculateRoute([â”‚ â”‚ driver.current_location, â”‚ â”‚ order.pickup_location, â”‚ â”‚ order.delivery_location â”‚ â”‚ ]) â”‚ â”‚ â”‚ â”‚ 4. Send WebSocket notification: â”‚ â”‚ socket.to(driver.socket_id) â”‚ â”‚ .emit('order:offer', { â”‚ â”‚ orderId: order.id, â”‚ â”‚ orderNumber: order.number, â”‚ â”‚ pickup: {...}, â”‚ â”‚ delivery: {...}, â”‚ â”‚ items: {...}, â”‚ â”‚ earnings: {...}, â”‚ â”‚ route: { â”‚ â”‚ coordinates: route.coordinates, â”‚ â”‚ distance: route.distance, â”‚ â”‚ duration: route.duration â”‚ â”‚ }, â”‚ â”‚ expiresIn: 30 // seconds â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ 5. Wait for response (30 seconds): â”‚ â”‚ response = await waitForResponse( â”‚ â”‚ driver.id, order.id, 30000 â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ IF response == 'ACCEPTED': â”‚ â”‚ â€¢ Assign order to driver â”‚ â”‚ â€¢ Notify other drivers (offer expired) â”‚ â”‚ â€¢ BREAK loop â”‚ â”‚ â”‚ â”‚ ELSE IF response == 'REJECTED': â”‚ â”‚ â€¢ Log rejection â”‚ â”‚ â€¢ Update driver acceptance rate â”‚ â”‚ â€¢ CONTINUE to next driver â”‚ â”‚ â”‚ â”‚ ELSE IF timeout: â”‚ â”‚ â€¢ Mark as no response â”‚ â”‚ â€¢ Penalize acceptance rate slightly â”‚ â”‚ â€¢ CONTINUE to next driver â”‚ â”‚ â”‚ â”‚ IF no driver accepted after top 5: â”‚ â”‚ â€¢ Increase offer radius to 10 KM â”‚ â”‚ â€¢ Increase earnings (surge pricing) â”‚ â”‚ â€¢ Try next batch of drivers â”‚ â”‚ â€¢ After 3 attempts: Manual assignment â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 2. Driver Receives Offer (Frontend) â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend WebSocket Listener: â”‚ â”‚ â†’ socket.on('order:offer', (offer) => { â”‚ â”‚ // Play sound alert â”‚ â”‚ SoundPlayer.play('order_notification.mp3') â”‚ â”‚ â”‚ â”‚ // Vibrate device â”‚ â”‚ Vibration.vibrate([0, 500, 200, 500]) â”‚ â”‚ â”‚ â”‚ // Show full-screen modal â”‚ â”‚ navigation.navigate('OrderOfferModal', { â”‚ â”‚ offer â”‚ â”‚ }) â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ Component: OrderOfferModal.tsx â”‚ â”‚ â†’ Full-screen overlay â”‚ â”‚ â†’ Cannot be dismissed (must accept/reject) â”‚ â”‚ â”‚ â”‚ â†’ Layout: â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â±ï¸ 30 seconds to respond â”‚ â”‚ â”‚ â”‚ [Circular countdown timer] â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ [FULL OSM MAP WITH ROUTE] â”‚ â”‚ â”‚ â”‚ â€¢ Driver marker (current loc) â”‚ â”‚ â”‚ â”‚ â€¢ Pickup marker (garage) â”‚ â”‚ â”‚ â”‚ â€¢ Delivery marker (customer) â”‚ â”‚ â”‚ â”‚ â€¢ Animated route polyline â”‚ â”‚ â”‚ â”‚ â€¢ Distance labels â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ ğŸ“ PICKUP â”‚ â”‚ â”‚ â”‚ Al Sadd Auto Parts â”‚ â”‚ â”‚ â”‚ Al Sadd Street, Doha â”‚ â”‚ â”‚ â”‚ 1.2 km away â€¢ ~3 min drive â”‚ â”‚ â”‚ â”‚ [ğŸ“ Call Garage] â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ ğŸ“ DELIVERY â”‚ â”‚ â”‚ â”‚ Building 15, Zone 41, Al Dafna â”‚ â”‚ â”‚ â”‚ 3.5 km from pickup â€¢ ~7 min â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ ğŸ“¦ ITEMS â”‚ â”‚ â”‚ â”‚ â€¢ 3 items â€¢ Total weight: 12.5 kg â”‚ â”‚ â”‚ â”‚ â€¢ Engine Oil Filter â”‚ â”‚ â”‚ â”‚ â€¢ Brake Pads Set â”‚ â”‚ â”‚ â”‚ â€¢ Air Filter â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â­ CUSTOMER â”‚ â”‚ â”‚ â”‚ Rating: 4.8 (15 orders) â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ ğŸ’° EARNINGS â”‚ â”‚ â”‚ â”‚ Total: 40 QAR â”‚ â”‚ â”‚ â”‚ Base fare: 25 QAR â”‚ â”‚ â”‚ â”‚ Distance: 15 QAR â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ [ REJECT ] [ ACCEPT ] â”‚ â”‚ â”‚ â”‚ (Gray) (Green) â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â†’ Map Implementation (DarkOSMap): â”‚ â”‚ <DarkOSMap â”‚ â”‚ initialRegion={{ â”‚ â”‚ // Center between pickup and delivery â”‚ â”‚ latitude: (pickup.lat + delivery.lat) / 2,â”‚ â”‚ longitude: (pickup.lng + delivery.lng) / 2â”‚ â”‚ }} â”‚ â”‚ markers={[ â”‚ â”‚ { â”‚ â”‚ id: 'driver', â”‚ â”‚ coordinate: driverLocation, â”‚ â”‚ customIcon: <DriverMarkerIcon /> â”‚ â”‚ }, â”‚ â”‚ { â”‚ â”‚ id: 'pickup', â”‚ â”‚ coordinate: pickup.location, â”‚ â”‚ customIcon: <PickupMarkerIcon /> â”‚ â”‚ }, â”‚ â”‚ { â”‚ â”‚ id: 'delivery', â”‚ â”‚ coordinate: delivery.location, â”‚ â”‚ customIcon: <DeliveryMarkerIcon /> â”‚ â”‚ } â”‚ â”‚ ]} â”‚ â”‚ routes={[ â”‚ â”‚ { â”‚ â”‚ coordinates: offer.route.coordinates, â”‚ â”‚ isActive: true â”‚ â”‚ } â”‚ â”‚ ]} â”‚ â”‚ /> â”‚ â”‚ â”‚ â”‚ â†’ Countdown timer: â”‚ â”‚ useEffect(() => { â”‚ â”‚ const interval = setInterval

Continue

6:04 PM
(() => {        â”‚
â”‚       setTimeLeft(prev => {                     â”‚
â”‚         if (prev <= 1) {                        â”‚
â”‚           // Auto-reject on timeout             â”‚
â”‚           handleReject('TIMEOUT')               â”‚
â”‚           return 0                              â”‚
â”‚         }                                       â”‚
â”‚         return prev - 1                         â”‚
â”‚       })                                        â”‚
â”‚     }, 1000)                                    â”‚
â”‚                                                 â”‚
â”‚     return () => clearInterval(interval)        â”‚
â”‚   }, [])                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 3. Driver Accepts Order â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend: â”‚ â”‚ â†’ Driver taps "ACCEPT" button â”‚ â”‚ â†’ Shows loading spinner â”‚ â”‚ â†’ Disables both buttons â”‚ â”‚ â”‚ â”‚ â†’ API call: â”‚ â”‚ POST /api/v1/orders/{orderId}/accept â”‚ â”‚ Body: { â”‚ â”‚ acceptedAt: Date.now(), â”‚ â”‚ driverLocation: { â”‚ â”‚ lat: 25.2854, â”‚ â”‚ lng: 51.5310 â”‚ â”‚ } â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Backend (Order Service): â”‚ â”‚ â†’ Controller: order.controller.ts â”‚ â”‚ â”‚ â”‚ â†’ Validation: â”‚ â”‚ 1. Check order still available â”‚ â”‚ SELECT status FROM orders â”‚ â”‚ WHERE id = $1 FOR UPDATE â”‚ â”‚ â”‚ â”‚ IF status != 'READY_FOR_PICKUP': â”‚ â”‚ RETURN error "Order no longer available" â”‚ â”‚ â”‚ â”‚ 2. Check offer is still valid â”‚ â”‚ offer = GET order:{id}:offered_to â”‚ â”‚ IF offer != driver_id OR expired: â”‚ â”‚ RETURN error "Offer expired" â”‚ â”‚ â”‚ â”‚ 3. Check driver is still online â”‚ â”‚ driver_status = HGET driver:{id} status â”‚ â”‚ IF driver_status != 'ONLINE': â”‚ â”‚ RETURN error "Driver not available" â”‚ â”‚ â”‚ â”‚ â†’ Transaction: â”‚ â”‚ BEGIN TRANSACTION â”‚ â”‚ â”‚ â”‚ -- Update order â”‚ â”‚ UPDATE orders SET â”‚ â”‚ status = 'ASSIGNED', â”‚ â”‚ assigned_driver_id = $1, â”‚ â”‚ assigned_at = NOW(), â”‚ â”‚ expected_pickup_at = NOW() + â”‚ â”‚ INTERVAL '{eta_to_pickup} seconds' â”‚ â”‚ WHERE id = $2 â”‚ â”‚ RETURNING * â”‚ â”‚ â”‚ â”‚ -- Create delivery record â”‚ â”‚ INSERT INTO deliveries ( â”‚ â”‚ order_id, driver_id, status, â”‚ â”‚ pickup_location, delivery_location, â”‚ â”‚ created_at â”‚ â”‚ ) VALUES ( â”‚ â”‚ $2, $1, 'HEADING_TO_PICKUP', â”‚ â”‚ order.pickup_location, â”‚ â”‚ order.delivery_location, â”‚ â”‚ NOW() â”‚ â”‚ ) RETURNING id â”‚ â”‚ â”‚ â”‚ -- Record acceptance â”‚ â”‚ INSERT INTO order_offers ( â”‚ â”‚ order_id, driver_id, status, â”‚ â”‚ accepted_at â”‚ â”‚ ) VALUES ( â”‚ â”‚ $2, $1, 'ACCEPTED', NOW() â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ -- Update driver stats â”‚ â”‚ UPDATE driver_statistics SET â”‚ â”‚ total_accepted = total_accepted + 1, â”‚ â”‚ acceptance_rate = ( â”‚ â”‚ total_accepted::FLOAT / â”‚ â”‚ total_offered::FLOAT â”‚ â”‚ ) * 100, â”‚ â”‚ active_deliveries = active_deliveries + 1 â”‚ â”‚ WHERE driver_id = $1 â”‚ â”‚ â”‚ â”‚ COMMIT TRANSACTION â”‚ â”‚ â”‚ â”‚ â†’ Redis Updates: â”‚ â”‚ -- Remove order from available queue â”‚ â”‚ DEL order:{id}:offered_to â”‚ â”‚ SREM available_orders {order_id} â”‚ â”‚ â”‚ â”‚ -- Mark driver as busy â”‚ â”‚ HSET driver:{id} active_order {order_id} â”‚ â”‚ HSET driver:{id} status BUSY â”‚ â”‚ â”‚ â”‚ â†’ Notifications: â”‚ â”‚ 1. Customer notification: â”‚ â”‚ socket.to(customer.socket_id) â”‚ â”‚ .emit('driver:assigned', { â”‚ â”‚ driverId, â”‚ â”‚ driverName, â”‚ â”‚ driverPhoto, â”‚ â”‚ driverRating, â”‚ â”‚ vehicleInfo, â”‚ â”‚ eta: route.duration â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ 2. Garage notification: â”‚ â”‚ SMS to garage: "Driver on the way for â”‚ â”‚ order QS-2026-0001. ETA: 3 minutes" â”‚ â”‚ â”‚ â”‚ 3. Reject offers for other drivers: â”‚ â”‚ FOR EACH other_driver IN offered_drivers: â”‚ â”‚ socket.to(other_driver.socket_id) â”‚ â”‚ .emit('order:no_longer_available', { â”‚ â”‚ orderId â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ â†’ Start SLA timers: â”‚ â”‚ -- Pickup SLA (30 minutes) â”‚ â”‚ SET order:{id}:pickup_sla_expires â”‚ â”‚ {timestamp + 1800} â”‚ â”‚ â”‚ â”‚ -- Delivery SLA (60 minutes from pickup) â”‚ â”‚ -- Will be set after pickup confirmation â”‚ â”‚ â”‚ â”‚ â†’ Response: { â”‚ â”‚ success: true, â”‚ â”‚ delivery: { â”‚ â”‚ id: "uuid", â”‚ â”‚ orderId: "uuid", â”‚ â”‚ status: "HEADING_TO_PICKUP", â”‚ â”‚ pickup: {...}, â”‚ â”‚ delivery: {...}, â”‚ â”‚ route: {...} â”‚ â”‚ } â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Frontend: â”‚ â”‚ â†’ Closes modal â”‚ â”‚ â†’ Shows success toast: "Order accepted!" â”‚ â”‚ â†’ Navigates to: ActiveDeliveryScreen â”‚ â”‚ â†’ Starts navigation to pickup location â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 4. Driver Rejects Order â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend: â”‚ â”‚ â†’ Driver taps "REJECT" button â”‚ â”‚ â†’ Shows rejection reason modal: â”‚ â”‚ â€¢ Too far â”‚ â”‚ â€¢ Low earnings â”‚ â”‚ â€¢ Heading in different direction â”‚ â”‚ â€¢ Taking a break â”‚ â”‚ â€¢ Other (text input) â”‚ â”‚ â”‚ â”‚ â†’ API call: â”‚ â”‚ POST /api/v1/orders/{orderId}/reject â”‚ â”‚ Body: { â”‚ â”‚ reason: "TOO_FAR", â”‚ â”‚ customReason: null â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Backend: â”‚ â”‚ â†’ Record rejection: â”‚ â”‚ INSERT INTO order_rejections ( â”‚ â”‚ order_id, driver_id, reason, â”‚ â”‚ rejected_at â”‚ â”‚ ) VALUES (...) â”‚ â”‚ â”‚ â”‚ â†’ Update driver stats: â”‚ â”‚ UPDATE driver_statistics SET â”‚ â”‚ total_rejected = total_rejected + 1, â”‚ â”‚ acceptance_rate = ( â”‚ â”‚ total_accepted::FLOAT / â”‚ â”‚ (total_accepted + total_rejected)::FLOAT â”‚ â”‚ ) * 100 â”‚ â”‚ WHERE driver_id = $1 â”‚ â”‚ â”‚ â”‚ â†’ Release offer lock: â”‚ â”‚ DEL order:{id}:offered_to â”‚ â”‚ â”‚ â”‚ â†’ Trigger assignment to next driver: â”‚ â”‚ assignToNextDriver(order_id) â”‚ â”‚ â”‚ â”‚ â†’ Response: { success: true } â”‚ â”‚ â”‚ â”‚ Frontend: â”‚ â”‚ â†’ Closes modal â”‚ â”‚ â†’ Returns to: AvailableOrdersScreen â”‚ â”‚ â†’ Shows brief message: "Order declined" â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


### **4. PICKUP JOURNEY WITH OSM NAVIGATION**
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 1. Navigate to Pickup Location â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend (ActiveDeliveryScreen.tsx): â”‚ â”‚ â†’ Automatic navigation starts â”‚ â”‚ â”‚ â”‚ â†’ Layout: â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ [FULL-SCREEN OSM DARK MAP] â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â€¢ Driver marker (animated) â”‚ â”‚ â”‚ â”‚ â€¢ Pickup marker with pulse â”‚ â”‚ â”‚ â”‚ â€¢ Route polyline (green) â”‚ â”‚ â”‚ â”‚ â€¢ Turn-by-turn indicators â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ In 200m, turn rightâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ onto Al Sadd St â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ [Bottom Sheet - Swipeable] â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ ğŸ“ HEADING TO PICKUP â”‚ â”‚ â”‚ â”‚ Al Sadd Auto Parts â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â±ï¸ ETA: 3 min â€¢ 1.2 km remaining â”‚ â”‚ â”‚ â”‚ [Progress bar â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘] â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ ğŸ“¦ 3 items to collect â”‚ â”‚ â”‚ â”‚ ğŸ“ [Call Garage] â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ [Report Issue] [Open in Maps] â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â†’ Navigation Component: â”‚ â”‚ Component: LiveTrackingScreen.tsx â”‚ â”‚ â”‚ â”‚ â†’ Get route from OSRM: â”‚ â”‚ const route = await routingService â”‚ â”‚ .calculateRoute( â”‚ â”‚ [driverLocation, pickupLocation], â”‚ â”‚ { steps: true, overview: 'full' } â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ â†’ Render route on OSM map: â”‚ â”‚ <Polyline â”‚ â”‚ coordinates={route.coordinates} â”‚ â”‚ strokeColor={MAP_OVERLAY_COLORS.activeRoute}â”‚ â”‚ strokeWidth={5} â”‚ â”‚ lineCap="round" â”‚ â”‚ lineJoin="round" â”‚ â”‚ /> â”‚ â”‚ â”‚ â”‚ â†’ Turn-by-turn navigation: â”‚ â”‚ useEffect(() => { â”‚ â”‚ // Find next instruction â”‚ â”‚ const nextInstruction = route.instructions â”‚ â”‚ .find(inst => â”‚ â”‚ inst.distance > 0 && â”‚ â”‚ !inst.completed â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ if (nextInstruction) { â”‚ â”‚ setCurrentInstruction({ â”‚ â”‚ text: nextInstruction.instruction, â”‚ â”‚ distance: nextInstruction.distance, â”‚ â”‚ icon: getDirectionIcon( â”‚ â”‚ nextInstruction.type, â”‚ â”‚ nextInstruction.modifier â”‚ â”‚ ) â”‚ â”‚ }) â”‚ â”‚ â”‚ â”‚ // Voice guidance â”‚ â”‚ if (nextInstruction.distance < 100) { â”‚ â”‚ speakInstruction(nextInstruction) â”‚ â”‚ } â”‚ â”‚ } â”‚ â”‚ }, [driverLocation]) â”‚ â”‚ â”‚ â”‚ â†’ Real-time ETA updates: â”‚ â”‚ useEffect(() => { â”‚ â”‚ const updateETA = async () => { â”‚ â”‚ const { duration, distance, eta } = â”‚ â”‚ await routingService.calculateETA( â”‚ â”‚ driverLocation, â”‚ â”‚ pickupLocation, â”‚ â”‚ true // consider traffic â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ setETA(eta) â”‚ â”‚ setRemainingDistance(distance) â”‚ â”‚ setRemainingDuration(duration) â”‚ â”‚ â”‚ â”‚ // Broadcast to customer â”‚ â”‚ socket.emit('driver:eta_update', { â”‚ â”‚ orderId, â”‚ â”‚ eta, â”‚ â”‚ distance â”‚ â”‚ }) â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ const interval = setInterval(updateETA, 15000)â”‚ â”‚ return () => clearInterval(interval) â”‚ â”‚ }, [driverLocation]) â”‚ â”‚ â”‚ â”‚ â†’ Geofence detection (100m radius): â”‚ â”‚ useEffect(() => { â”‚ â”‚ const distanceToPickup = calculateDistance( â”‚ â”‚ driverLocation, â”‚ â”‚ pickupLocation â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ if (distanceToPickup <= 100) { â”‚ â”‚ // Enable "I'VE ARRIVED" button â”‚ â”‚ setCanMarkArrived(true) â”‚ â”‚ â”‚ â”‚ // Show notification â”‚ â”‚ showNotification( â”‚ â”‚ "You're near the pickup location" â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ // Notify garage â”‚ â”‚ socket.emit('driver:approaching', { â”‚ â”‚ orderId, â”‚ â”‚ eta: 60 // seconds â”‚ â”‚ }) â”‚ â”‚ } â”‚ â”‚ }, [driverLocation]) â”‚ â”‚ â”‚ â”‚ â†’ "Open in Maps" button: â”‚ â”‚ Opens external navigation: â”‚ â”‚ â€¢ Google Maps (if installed) â”‚ â”‚ â€¢ Waze (if installed) â”‚ â”‚ â€¢ Apple Maps (iOS) â”‚ â”‚ â€¢ Default browser with OSM directions â”‚ â”‚ â”‚ â”‚ const openExternalMaps = () => { â”‚ â”‚ const url = â”‚ â”‚ https://www.google.com/maps/dir/?api=1& +â”‚ â”‚ destination=${pickup.lat},${pickup.lng} â”‚ â”‚ â”‚ â”‚ Linking.openURL(url) â”‚ â”‚ } â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 2. Arrive at Garage â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend: â”‚ â”‚ â†’ "I'VE ARRIVED" button becomes enabled â”‚ â”‚ â†’ Driver taps button â”‚ â”‚ â”‚ â”‚ â†’ API call: â”‚ â”‚ POST /api/v1/orders/{orderId}/arrived-pickup â”‚ â”‚ Body: { â”‚ â”‚ arrivedAt: Date.now(), â”‚ â”‚ location: { â”‚ â”‚ lat: 25.2854, â”‚ â”‚ lng: 51.5310, â”‚ â”‚ accuracy: 5 â”‚ â”‚ } â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ Backend (Delivery Service): â”‚ â”‚ â†’ Controller: pickup.controller.ts â”‚ â”‚ â”‚ â”‚ â†’ Validation: â”‚ â”‚ -- Verify driver is within geofence â”‚ â”‚ SELECT ST_DWithin( â”‚ â”‚ ST_Point($1, $2)::geography, â”‚ â”‚ pickup_location, â”‚ â”‚ 150 -- meters â”‚ â”‚ ) as is_at_location â”‚ â”‚ FROM orders â”‚ â”‚ WHERE id = $3 â”‚ â”‚ â”‚ â”‚ IF NOT is_at_location: â”‚ â”‚ RETURN error "Not at pickup location" â”‚ â”‚ â”‚ â”‚ â†’ Update delivery status: â”‚ â”‚ UPDATE deliveries SET â”‚ â”‚ status = 'AT_PICKUP', â”‚ â”‚ arrived_at_pickup = NOW(), â”‚ â”‚ pickup_arrival_location = ST_Point($1, $2) â”‚ â”‚ WHERE order_id = $3 â”‚ â”‚ RETURNING * â”‚ â”‚ â”‚ â”‚ â†’ Record timeline event: â”‚ â”‚ INSERT INTO delivery_timeline ( â”‚ â”‚ delivery_id, event_type, event_time, â”‚ â”‚ location, metadata â”‚ â”‚ ) VALUES ( â”‚ â”‚ $1, 'ARRIVED_AT_PICKUP', NOW(), â”‚ â”‚ ST_Point($2, $3), â”‚ â”‚ jsonb_build_object( â”‚ â”‚ 'travel_time', extract(epoch from â”‚ â”‚ (NOW() - assigned_at)), â”‚ â”‚ 'distance_traveled', $4 â”‚ â”‚ ) â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ â†’ Notifications: â”‚ â”‚ 1. Garage SMS/WhatsApp: â”‚ â”‚ "Driver has arrived for order QS-2026-0001"â”‚ â”‚ â”‚ â”‚ 2. Customer notification: â”‚ â”‚ socket.to(customer_id).emit( â”‚ â”‚ 'driver:at_pickup', â”‚ â”‚ { orderId, timestamp: NOW() } â”‚ â”‚ ) â”‚ â”‚ â”‚ â”‚ â†’ Start pickup timer: â”‚ â”‚ SET order:{id}:pickup_started {timestamp} â”‚ â”‚ â”‚ â”‚ Frontend: â”‚ â”‚ â†’ Haptic feedback â”‚ â”‚ â†’ Updates bottom sheet: â”‚ â”‚ "ğŸ“ AT PICKUP LOCATION" â”‚ â”‚ â†’ Shows item checklist â”‚ â”‚ â†’ Navigates to: ItemVerificationScreen â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Verify & Collect Items                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (ItemVerificationScreen.tsx):          â”‚
â”‚                                                 â”‚
â”‚ â†’ Layout:                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ VERIFY ITEMS                        â”‚       â”‚
â”‚   â”‚ Scan or check each item             â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ â˜ Engine Oil Filter                 â”‚       â”‚
â”‚   â”‚   Code: QS-123456                   â”‚       â”‚
â”‚   â”‚   [ğŸ“· Scan] [âœ“ Manual Check]        â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ â˜ Brake Pads Set                    â”‚       â”‚
â”‚   â”‚   Code: QS-789012                   â”‚       â”‚
â”‚   â”‚   [ğŸ“· Scan] [âœ“ Manual Check]        â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ â˜ Air Filter                        â”‚       â”‚
â”‚   â”‚   Code: QS-345678                   â”‚       â”‚
â”‚   â”‚   [ğŸ“· Scan] [âœ“ Manual Check]        â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚ Progress: 0/3 items verified        â”‚       â”‚
â”‚   â”‚ [â–±â–±â–±â–±â–±â–±â–±â–±â–±â–±]                        â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [Report Issue]                      â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [CONFIRM PICKUP] (disabled)         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚
â”‚ â†’ Barcode Scanner:                              â”‚
â”‚   Component: BarcodeScanner.tsx                 â”‚
â”‚   Uses: vision-camera-code-scanner              â”‚
â”‚                                                 â”‚
â”‚   const onBarcodeScan = (codes) => {            â”‚
â”‚     const code = codes[0].value                 â”‚
â”‚                                                 â”‚
â”‚     // Find matching item                       â”‚
â”‚     const item = items.find(i =>                â”‚
â”‚       i.code === code                           â”‚
â”‚     )                                           â”‚
â”‚                                                 â”‚
â”‚     if (item) {                                 â”‚
â”‚       // Mark as verified                       â”‚
â”‚       markItemVerified(item.id, 'SCANNED')      â”‚
â”‚                                                 â”‚
â”‚       // Haptic feedback                        â”‚
â”‚       Vibration.vibrate(100)                    â”‚
â”‚                                                 â”‚
â”‚       // Success sound                          â”‚
â”‚       SoundPlayer.play('scan_success.mp3')      â”‚
â”‚                                                 â”‚
â”‚       // Optional: Take photo                   â”‚
â”‚       if (requiresPhoto) {                      â”‚
â”‚         openCamera(item.id)                     â”‚
â”‚       }                                         â”‚
â”‚     } else {                                    â”‚
â”‚       // Error feedback                         â”‚
â”‚       Alert.alert(                              â”‚
â”‚         'Item Not Found',                       â”‚
â”‚         'This item is not in the order'         â”‚
â”‚       )                                         â”‚
â”‚     }                                           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Manual check:                                 â”‚
â”‚   Requires confirmation dialog:                 â”‚
â”‚   "Confirm you collected: Engine Oil Filter?"   â”‚
â”‚                                                 â”‚
â”‚ â†’ Photo capture (optional):                     â”‚
â”‚   const captureItemPhoto = async (itemId) => {  â”‚
â”‚     const photo = await camera.takePhoto({      â”‚
â”‚       quality: 0.8,                             â”‚
â”‚       skipMetadata: false                       â”‚
â”‚     })                                          â”‚
â”‚                                                 â”‚
â”‚     // Compress                                 â”‚
â”‚     const compressed = await                    â”‚
â”‚       ImageResizer.createResizedImage(          â”‚
â”‚         photo.path, 1024, 1024, 'JPEG', 80      â”‚
â”‚       )                                         â”‚
â”‚                                                 â”‚
â”‚     // Upload                                   â”‚
â”‚     await uploadItemPhoto(itemId, compressed)   â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Enable "CONFIRM PICKUP" when all verified:    â”‚
â”‚   useEffect(() => {                             â”‚
â”‚     const allVerified = items.every(            â”‚
â”‚       i => i.verified                           â”‚
â”‚     )                                           â”‚
â”‚     setCanConfirm(allVerified)                  â”‚
â”‚   }, [items])                                   â”‚
â”‚                                                 â”‚
â”‚ â†’ Confirm pickup:                               â”‚
â”‚   onConfirmPickup = async () => {               â”‚
â”‚     // Show signature pad                       â”‚
â”‚     const signature = await                     â”‚
â”‚       showSignaturePad(                         â”‚
â”‚         'Garage Staff Signature'                â”‚
â”‚       )                                         â”‚
â”‚                                                 â”‚
â”‚     // Collect additional info                  â”‚
â”‚     const notes = await showNotesDialog()       â”‚
â”‚                                                 â”‚
â”‚     // API call                                 â”‚
â”‚     await deliveryApi.confirmPickup({           â”‚
â”‚       orderId,                                  â”‚
â”‚       items: verifiedItems,                     â”‚
â”‚       signature,                                â”‚
â”‚       notes,                                    â”‚
â”‚       timestamp: Date.now()                     â”‚
â”‚     })                                          â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ Backend:                                        â”‚
â”‚ â†’ POST /api/v1/orders/{orderId}/confirm-pickup  â”‚
â”‚   Body: {                                       â”‚
â”‚     items: [                                    â”‚
â”‚       {                                         â”‚
â”‚         itemId: "uuid",                         â”‚
â”‚         verified: true,                         â”‚
â”‚         verificationMethod: "SCANNED",          â”‚
â”‚         photoUrl: "s3://..."                    â”‚
â”‚       },                                        â”‚
â”‚       ...                                       â”‚
â”‚     ],                                          â”‚
â”‚     signatureUrl: "s3://...",                   â”‚
â”‚     notes: "All items in good condition",       â”‚
â”‚     pickedUpAt: timestamp                       â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Transaction:                                  â”‚
â”‚   BEGIN TRANSACTION                             â”‚
â”‚                                                 â”‚
â”‚   -- Update delivery status                     â”‚
â”‚   UPDATE deliveries SET                         â”‚
â”‚     status = 'PICKED_UP',                       â”‚
â”‚     picked_up_at = NOW(),                       â”‚
â”‚     pickup_signature_url = $1,                  â”‚
â”‚     pickup_notes = $2                           â”‚
â”‚   WHERE order_id = $3                           â”‚
â”‚                                                 â”‚
â”‚   -- Update order status                        â”‚
â”‚   UPDATE orders SET                             â”‚
â”‚     status = 'IN_TRANSIT'                       â”‚
â”‚   WHERE id = $3                                 â”‚
â”‚                                                 â”‚
â”‚   -- Record item verifications                  â”‚
â”‚   INSERT INTO item_verifications (              â”‚
â”‚     delivery_id, item_id, verified_at,          â”‚
â”‚     method, photo_url                           â”‚
â”‚   ) VALUES ...                                  â”‚
â”‚                                                 â”‚
â”‚   -- Timeline event                             â”‚
â”‚   INSERT INTO delivery_timeline (               â”‚
â”‚     delivery_id, event_type, event_time         â”‚
â”‚   ) VALUES (                                    â”‚
â”‚     $4, 'ITEMS_PICKED_UP', NOW()                â”‚
â”‚   )                                             â”‚
â”‚                                                 â”‚
â”‚   COMMIT TRANSACTION                            â”‚
â”‚                                                 â”‚
â”‚ â†’ Notifications:                                â”‚
â”‚   1. Customer:                                  â”‚
â”‚      "Driver collected your parts and is        â”‚
â”‚       heading to you. ETA: 7 minutes"           â”‚
â”‚                                                 â”‚
â”‚   2. Garage:                                    â”‚
â”‚      "Order QS-2026-0001 picked up successfully"â”‚
â”‚                                                 â”‚
â”‚ Frontend:                                       â”‚
â”‚ â†’ Success animation                             â”‚
â”‚ â†’ Navigates to: NavigationScreen                â”‚
â”‚   (Now heading to delivery location)            â”‚
â”‚ â†’ Starts navigation to customer                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 4. Issue Handling at Pickup â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Frontend: â”‚ â”‚ â†’ "REPORT ISSUE" button â”‚ â”‚ â†’ Shows issue selection modal: â”‚ â”‚ â€¢ Items not ready â”‚ â”‚ â€¢ Missing items â”‚ â”‚ â€¢ Wrong items â”‚ â”‚ â€¢ Damaged items â”‚ â”‚ â€¢ Garage closed â”‚ â”‚ â€¢ Cannot access location â”‚ â”‚ â€¢ Other â”‚ â”‚ â”‚ â”‚ â†’ For each issue type: â”‚ â”‚ â€¢ Photo required â”‚ â”‚ â€¢ Notes field â”‚ â”‚ â€¢ Option to call support â”‚ â”‚ â”‚ â”‚ Backend: â”‚ â”‚ â†’ POST /api/v1/orders/{orderId}/report-issue â”‚ â”‚ Body: { â”‚ â”‚ issueType: "ITEMS_NOT_READY", â”‚ â”‚ description: "...", â”‚ â”‚ photos: ["s3://...", "s3://..."], â”‚ â”‚ location: { lat, lng }, â”‚ â”‚ reportedAt: timestamp â”‚ â”‚ } â”‚ â”‚ â”‚ â”‚ â†’ Creates support ticket: â”‚ â”‚ INSERT INTO support_tickets ( â”‚ â”‚ order_id, driver_id, type, status, â”‚ â”‚ description, priority, created_at â”‚ â”‚ ) VALUES ( â”‚ â”‚ $1, $2, $3, 'OPEN', $4, 'HIGH', NOW() â”‚ â”‚ ) RETURNING id â”‚ â”‚ â”‚ â”‚ â†’ Pauses SLA timer: â”‚ â”‚ SET order:{id}:sla_paused true â”‚ â”‚ â”‚ â”‚ â†’ Notifies operations team: â”‚ â”‚ â€¢ Push notification to ops dashboard â”‚ â”‚ â€¢ SMS to on-call manager â”‚ â”‚ â€¢ Email alert â”‚ â”‚ â”‚ â”‚ â†’ Resolution workflow: â”‚ â”‚ IF issue == 'ITEMS_NOT_READY': â”‚ â”‚ â€¢ Contact garage â”‚ â”‚ â€¢ Get new ETA â”‚ â”‚ â€¢ Update customer â”‚ â”‚ â”‚ â”‚ IF issue == 'MISSING_ITEMS': â”‚ â”‚ â€¢ Partial delivery option â”‚ â”‚ â€¢ OR wait for items â”‚ â”‚ â€¢ OR cancel order â”‚ â”‚ â”‚ â”‚ IF issue == 'GARAGE_CLOSED': â”‚ â”‚ â€¢ Reschedule delivery â”‚ â”‚ â€¢ Compensate driver wait time â”‚ â”‚ â”‚ â”‚ Frontend: â”‚ â”‚ â†’ Shows "Issue reported" confirmation â”‚ â”‚ â†’ Displays support contact options â”‚ â”‚ â†’ Estimated resolution time â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Due to length constraints, I'll continue with the remaining sections (Delivery Journey, Earnings & Payouts, Additional Features) in the next part. Would you like me to continue with the complete flow?
complete flow

6:06 PM
COMPLETE FLOW CONTINUATION
5. DELIVERY JOURNEY WITH OSM NAVIGATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Navigate to Customer Location                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (NavigationScreen.tsx):                â”‚
â”‚ â†’ Automatically starts after pickup confirmed   â”‚
â”‚                                                 â”‚
â”‚ â†’ Full-screen OSM dark map with route:          â”‚
â”‚   <DarkOSMap                                    â”‚
â”‚     initialRegion={calculateMidpoint(           â”‚
â”‚       driverLocation,                           â”‚
â”‚       deliveryLocation                          â”‚
â”‚     )}                                          â”‚
â”‚     markers={[                                  â”‚
â”‚       {                                         â”‚
â”‚         id: 'driver',                           â”‚
â”‚         coordinate: driverLocation,             â”‚
â”‚         customIcon: (                           â”‚
â”‚           <DriverMarkerIcon                     â”‚
â”‚             rotation={heading}                  â”‚
â”‚             isMoving={speed > 1}                â”‚
â”‚           />                                    â”‚
â”‚         )                                       â”‚
â”‚       },                                        â”‚
â”‚       {                                         â”‚
â”‚         id: 'delivery',                         â”‚
â”‚         coordinate: deliveryLocation,           â”‚
â”‚         customIcon: (                           â”‚
â”‚           <DeliveryMarkerIcon                   â”‚
â”‚             withPulse={true}                    â”‚
â”‚           />                                    â”‚
â”‚         )                                       â”‚
â”‚       }                                         â”‚
â”‚     ]}                                          â”‚
â”‚     routes={[{                                  â”‚
â”‚       coordinates: routeCoordinates,            â”‚
â”‚       isActive: true                            â”‚
â”‚     }]}                                         â”‚
â”‚     followsUserLocation={true}                  â”‚
â”‚     showsTraffic={true}                         â”‚
â”‚   />                                            â”‚
â”‚                                                 â”‚
â”‚ â†’ Calculate optimal route with OSRM:            â”‚
â”‚   useEffect(() => {                             â”‚
â”‚     const fetchRoute = async () => {            â”‚
â”‚       const route = await routingService        â”‚
â”‚         .calculateRoute(                        â”‚
â”‚           [driverLocation, deliveryLocation],   â”‚
â”‚           {                                     â”‚
â”‚             alternatives: true, // Get 2 routes â”‚
â”‚             steps: true,                        â”‚
â”‚             overview: 'full',                   â”‚
â”‚             geometries: 'polyline'              â”‚
â”‚           }                                     â”‚
â”‚         )                                       â”‚
â”‚                                                 â”‚
â”‚       setMainRoute(route)                       â”‚
â”‚       setRouteCoordinates(route.coordinates)    â”‚
â”‚       setInstructions(route.instructions)       â”‚
â”‚       setETA(route.duration)                    â”‚
â”‚     }                                           â”‚
â”‚                                                 â”‚
â”‚     fetchRoute()                                â”‚
â”‚     const interval = setInterval(fetchRoute, 60000)â”‚
â”‚     return () => clearInterval(interval)        â”‚
â”‚   }, [driverLocation])                          â”‚
â”‚                                                 â”‚
â”‚ â†’ Bottom sheet with delivery info:              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ ğŸ“¦ IN TRANSIT TO CUSTOMER            â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ â±ï¸  ETA: 7 min â€¢ 3.5 km remaining    â”‚       â”‚
â”‚   â”‚ [Progress â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘]               â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ ğŸ“ Building 15, Zone 41, Al Dafna   â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ ğŸ‘¤ Customer: Ahmed K.               â”‚       â”‚
â”‚   â”‚    Rating: 4.8 (15 orders)          â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ ğŸ“ Instructions:                     â”‚       â”‚
â”‚   â”‚    "Please call when you arrive"    â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [ğŸ“ Call Customer] [ğŸ’¬ Chat]         â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ ğŸ“¦ Items: 3 â€¢ Weight: 12.5 kg       â”‚       â”‚
â”‚   â”‚ [View Items]                        â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [Report Issue] [Open in Maps]       â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚
â”‚ â†’ Turn-by-turn voice guidance:                  â”‚
â”‚   const speakInstruction = (instruction) => {   â”‚
â”‚     const text = formatInstruction(instruction) â”‚
â”‚                                                 â”‚
â”‚     // iOS: AVSpeechSynthesizer                 â”‚
â”‚     // Android: TextToSpeech                    â”‚
â”‚     Tts.speak(text, {                           â”‚
â”‚       language: 'en-US',                        â”‚
â”‚       rate: 0.9,                                â”‚
â”‚       pitch: 1.0                                â”‚
â”‚     })                                          â”‚
â”‚                                                 â”‚
â”‚     // Also show visual banner                  â”‚
â”‚     showInstructionBanner(instruction)          â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Real-time location broadcast:                 â”‚
â”‚   useEffect(() => {                             â”‚
â”‚     const broadcastLocation = () => {           â”‚
â”‚       // Send to customer via WebSocket         â”‚
â”‚       socket.emit('driver:location_update', {   â”‚
â”‚         orderId,                                â”‚
â”‚         location: {                             â”‚
â”‚           lat: driverLocation.latitude,         â”‚
â”‚           lng: driverLocation.longitude,        â”‚
â”‚           heading,                              â”‚
â”‚           speed                                 â”‚
â”‚         },                                      â”‚
â”‚         eta: calculateETA(),                    â”‚
â”‚         distance: calculateRemainingDistance()  â”‚
â”‚       })                                        â”‚
â”‚                                                 â”‚
â”‚       // Update backend                         â”‚
â”‚       locationService.updateLocation({          â”‚
â”‚         orderId,                                â”‚
â”‚         location: driverLocation                â”‚
â”‚       })                                        â”‚
â”‚     }                                           â”‚
â”‚                                                 â”‚
â”‚     const interval = setInterval(               â”‚
â”‚       broadcastLocation,                        â”‚
â”‚       10000 // Every 10 seconds                 â”‚
â”‚     )                                           â”‚
â”‚     return () => clearInterval(interval)        â”‚
â”‚   }, [driverLocation])                          â”‚
â”‚                                                 â”‚
â”‚ â†’ Backend receives location updates:            â”‚
â”‚   socket.on('driver:location_update', (data) => {â”‚
â”‚     // Update Redis for real-time tracking      â”‚
â”‚     redis.geoadd(                               â”‚
â”‚       'qatar:drivers',                          â”‚
â”‚       data.location.lng,                        â”‚
â”‚       data.location.lat,                        â”‚
â”‚       data.driverId                             â”‚
â”‚     )                                           â”‚
â”‚                                                 â”‚
â”‚     // Broadcast to customer                    â”‚
â”‚     io.to(`customer:${data.customerId}`)        â”‚
â”‚       .emit('driver:location', {                â”‚
â”‚         location: data.location,                â”‚
â”‚         eta: data.eta,                          â”‚
â”‚         distance: data.distance                 â”‚
â”‚       })                                        â”‚
â”‚                                                 â”‚
â”‚     // Store in TimescaleDB                     â”‚
â”‚     await db.query(`                            â”‚
â”‚       INSERT INTO location_tracking (           â”‚
â”‚         delivery_id, location, heading,         â”‚
â”‚         speed, recorded_at                      â”‚
â”‚       ) VALUES (                                â”‚
â”‚         $1,                                     â”‚
â”‚         ST_SetSRID(ST_MakePoint($2, $3), 4326), â”‚
â”‚         $4, $5, NOW()                           â”‚
â”‚       )                                         â”‚
â”‚     `, [deliveryId, lng, lat, heading, speed])  â”‚
â”‚   })                                            â”‚
â”‚                                                 â”‚
â”‚ â†’ Traffic-aware routing:                        â”‚
â”‚   // Re-route if traffic detected               â”‚
â”‚   useEffect(() => {                             â”‚
â”‚     const checkTraffic = async () => {          â”‚
â”‚       const currentRoute = await routingService â”‚
â”‚         .calculateRoute(                        â”‚
â”‚           [driverLocation, deliveryLocation],   â”‚
â”‚           { considerTraffic: true }             â”‚
â”‚         )                                       â”‚
â”‚                                                 â”‚
â”‚       // If new route is 5+ min faster          â”‚
â”‚       if (currentRoute.duration <               â”‚
â”‚           mainRoute.duration - 300) {           â”‚
â”‚         Alert.alert(                            â”‚
â”‚           'Faster Route Available',             â”‚
â”‚           `Save ${formatDuration(              â”‚
â”‚             mainRoute.duration -                â”‚
â”‚             currentRoute.duration               â”‚
â”‚           )}`,                                  â”‚
â”‚           [                                     â”‚
â”‚             { text: 'Keep Current' },           â”‚
â”‚             {                                   â”‚
â”‚               text: 'Use New Route',            â”‚
â”‚               onPress: () => {                  â”‚
â”‚                 setMainRoute(currentRoute)      â”‚
â”‚                 setRouteCoordinates(            â”‚
â”‚                   currentRoute.coordinates      â”‚
â”‚                 )                               â”‚
â”‚               }                                 â”‚
â”‚             }                                   â”‚
â”‚           ]                                     â”‚
â”‚         )                                       â”‚
â”‚       }                                         â”‚
â”‚     }                                           â”‚
â”‚                                                 â”‚
â”‚     const interval = setInterval(checkTraffic, 120000)â”‚
â”‚     return () => clearInterval(interval)        â”‚
â”‚   }, [driverLocation])                          â”‚
â”‚                                                 â”‚
â”‚ â†’ Customer communication:                       â”‚
â”‚   // Call with number masking                   â”‚
â”‚   const callCustomer = async () => {            â”‚
â”‚     const maskedNumber = await                  â”‚
â”‚       communicationService.getMaskedNumber(     â”‚
â”‚         orderId                                 â”‚
â”‚       )                                         â”‚
â”‚                                                 â”‚
â”‚     Linking.openURL(`tel:${maskedNumber}`)      â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚   // In-app chat                                â”‚
â”‚   const openChat = () => {                      â”‚
â”‚     navigation.navigate('ChatScreen', {         â”‚
â”‚       orderId,                                  â”‚
â”‚       recipientId: customerId,                  â”‚
â”‚       recipientName: customerName               â”‚
â”‚     })                                          â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ Approaching notification (5 min away):        â”‚
â”‚   useEffect(() => {                             â”‚
â”‚     const eta = calculateETA()                  â”‚
â”‚                                                 â”‚
â”‚     if (eta <= 300 && !notifiedApproaching) {   â”‚
â”‚       // Notify customer                        â”‚
â”‚       socket.emit('driver:approaching', {       â”‚
â”‚         orderId,                                â”‚
â”‚         eta: 300                                â”‚
â”‚       })                                        â”‚
â”‚                                                 â”‚
â”‚       setNotifiedApproaching(true)              â”‚
â”‚     }                                           â”‚
â”‚   }, [driverLocation])                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Arrive at Delivery Location                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                       â”‚
â”‚ â†’ Geofence detection (100m radius):             â”‚
â”‚   useEffect(() => {                             â”‚
â”‚     const distance = calculateDistance(         â”‚
â”‚       driverLocation,                           â”‚
â”‚       deliveryLocation                          â”‚
â”‚     )                                           â”‚
â”‚                                                 â”‚
â”‚     if (distance <= 100 && !arrivedAtDelivery) {â”‚
â”‚       setArrivedAtDelivery(true)                â”‚
â”‚       setCanMarkArrived(true)                   â”‚
â”‚                                                 â”‚
â”‚       // Haptic feedback                        â”‚
â”‚       Vibration.vibrate([0, 200, 100, 200])     â”‚
â”‚                                                 â”‚
â”‚       // Show notification                      â”‚
â”‚       showNotification(                         â”‚
â”‚         "You've arrived at delivery location"   â”‚
â”‚       )                                         â”‚
â”‚     }                                           â”‚
â”‚   }, [driverLocation])                          â”‚
â”‚                                                 â”‚
â”‚ â†’ Driver taps "I'VE ARRIVED" button             â”‚
â”‚                                                 â”‚
â”‚ â†’ API call:                                     â”‚
â”‚   POST /api/v1/orders/{orderId}/arrived-deliveryâ”‚
â”‚   Body: {                                       â”‚
â”‚     arrivedAt: Date.now(),                      â”‚
â”‚     location: {                                 â”‚
â”‚       lat: 25.3012,                             â”‚
â”‚       lng: 51.5523,                             â”‚
â”‚       accuracy: 5                               â”‚
â”‚     }                                           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ Backend (Delivery Service):                     â”‚
â”‚ â†’ Controller: delivery.controller.ts            â”‚
â”‚                                                 â”‚
â”‚ â†’ Validation:                                   â”‚
â”‚   -- Check driver within geofence               â”‚
â”‚   SELECT                                        â”‚
â”‚     ST_DWithin(                                 â”‚
â”‚       ST_Point($1, $2)::geography,              â”‚
â”‚       delivery_location,                        â”‚
â”‚       150 -- meters                             â”‚
â”‚     ) as is_at_location                         â”‚
â”‚   FROM orders                                   â”‚
â”‚   WHERE id = $3                                 â”‚
â”‚                                                 â”‚
â”‚   IF NOT is_at_location:                        â”‚
â”‚     RETURN {                                    â”‚
â”‚       error: "Not at delivery location",        â”‚
â”‚       distance: actual_distance                 â”‚
â”‚     }                                           â”‚
â”‚                                                 â”‚
â”‚ â†’ Update delivery status:                       â”‚
â”‚   BEGIN TRANSACTION                             â”‚
â”‚                                                 â”‚
â”‚   UPDATE deliveries SET                         â”‚
â”‚     status = 'AT_DELIVERY',                     â”‚
â”‚     arrived_at_delivery = NOW(),                â”‚
â”‚     delivery_arrival_location =                 â”‚
â”‚       ST_Point($1, $2)                          â”‚
â”‚   WHERE order_id = $3                           â”‚
â”‚   RETURNING *                                   â”‚
â”‚                                                 â”‚
â”‚   -- Calculate total travel time                â”‚
â”‚   UPDATE deliveries SET                         â”‚
â”‚     total_travel_time = EXTRACT(EPOCH FROM      â”‚
â”‚       (arrived_at_delivery - picked_up_at)      â”‚
â”‚     )                                           â”‚
â”‚   WHERE order_id = $3                           â”‚
â”‚                                                 â”‚
â”‚   -- Timeline event                             â”‚
â”‚   INSERT INTO delivery_timeline (               â”‚
â”‚     delivery_id, event_type, event_time,        â”‚
â”‚     location, metadata                          â”‚
â”‚   ) VALUES (                                    â”‚
â”‚     $4, 'ARRIVED_AT_DELIVERY', NOW(),           â”‚
â”‚     ST_Point($1, $2),                           â”‚
â”‚     jsonb_build_object(                         â”‚
â”‚       'travel_time', $5,                        â”‚
â”‚       'distance_traveled', $6                   â”‚
â”‚     )                                           â”‚
â”‚   )                                             â”‚
â”‚                                                 â”‚
â”‚   COMMIT TRANSACTION                            â”‚
â”‚                                                 â”‚
â”‚ â†’ Notifications:                                â”‚
â”‚   1. Customer SMS/Push:                         â”‚
â”‚      "Your driver has arrived! ğŸ“¦"              â”‚
â”‚                                                 â”‚
â”‚   2. WebSocket to customer app:                 â”‚
â”‚      socket.to(customer_id).emit(               â”‚
â”‚        'driver:arrived',                        â”‚
â”‚        {                                        â”‚
â”‚          orderId,                               â”‚
â”‚          driverName,                            â”‚
â”‚          vehicleInfo,                           â”‚
â”‚          arrivedAt: timestamp                   â”‚
â”‚        }                                        â”‚
â”‚      )                                          â”‚
â”‚                                                 â”‚
â”‚ â†’ Start delivery completion timer (10 min):     â”‚
â”‚   SET order:{id}:delivery_completion_timer      â”‚
â”‚     {timestamp}                                 â”‚
â”‚   EXPIRE order:{id}:delivery_completion_timer   â”‚
â”‚     600 // 10 minutes                           â”‚
â”‚                                                 â”‚
â”‚ Frontend:                                       â”‚
â”‚ â†’ Success feedback                              â”‚
â”‚ â†’ Bottom sheet updates:                         â”‚
â”‚   "ğŸ“ AT DELIVERY LOCATION"                     â”‚
â”‚ â†’ Shows options:                                â”‚
â”‚   â€¢ Call Customer                               â”‚
â”‚   â€¢ Start Delivery Process                      â”‚
â”‚   â€¢ Report Issue                                â”‚
â”‚ â†’ Navigates to: ProofOfDeliveryScreen           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Proof of Delivery (POD) - Multi-Step         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (ProofOfDeliveryScreen.tsx):           â”‚
â”‚                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚ STEP 1: VERIFY ITEMS WITH CUSTOMER              â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚                                                 â”‚
â”‚ â†’ Layout:                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ VERIFY ITEMS WITH CUSTOMER          â”‚       â”‚
â”‚   â”‚ Step 1 of 4                         â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Show each item to customer:         â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ âœ“ Engine Oil Filter                 â”‚       â”‚
â”‚   â”‚   Code: QS-123456                   â”‚       â”‚
â”‚   â”‚   Status: âœ“ Verified by customer    â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ âš  Brake Pads Set                    â”‚       â”‚
â”‚   â”‚   Code: QS-789012                   â”‚       â”‚
â”‚   â”‚   [âœ“ Confirm] [âœ— Issue]             â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ â˜ Air Filter                        â”‚       â”‚
â”‚   â”‚   Code: QS-345678                   â”‚       â”‚
â”‚   â”‚   [âœ“ Confirm] [âœ— Issue]             â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚ Progress: 1/3 items verified        â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [NEXT STEP] (disabled until all âœ“)  â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚
â”‚ â†’ If customer reports issue with item:          â”‚
â”‚   Shows dialog:                                 â”‚
â”‚   â€¢ Wrong item                                  â”‚
â”‚   â€¢ Damaged                                     â”‚
â”‚   â€¢ Missing parts                               â”‚
â”‚   â†’ Take photo of issue                         â”‚
â”‚   â†’ Add notes                                   â”‚
â”‚   â†’ Contact support                             â”‚
â”‚                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚ STEP 2: CAPTURE DELIVERY PHOTOS                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚                                                 â”‚
â”‚ â†’ Layout:                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ TAKE DELIVERY PHOTOS                â”‚       â”‚
â”‚   â”‚ Step 2 of 4                         â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [CAMERA VIEWFINDER]                 â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Take clear photos of:               â”‚       â”‚
â”‚   â”‚ â€¢ All items together                â”‚       â”‚
â”‚   â”‚ â€¢ Any special packaging             â”‚       â”‚
â”‚   â”‚ â€¢ Delivery location                 â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [ ğŸ“· Capture Photo ]                 â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Photos taken: 2/3                   â”‚       â”‚
â”‚   â”‚ [Photo 1] [Photo 2] [+Add]          â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [NEXT STEP]                         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚
â”‚ â†’ Photo capture implementation:                 â”‚
â”‚   const captureDeliveryPhoto = async () => {    â”‚
â”‚     const photo = await camera.takePhoto({      â”‚
â”‚       quality: 0.85,                            â”‚
â”‚       flash: 'auto',                            â”‚
â”‚       enableAutoStabilization: true             â”‚
â”‚     })                                          â”‚
â”‚                                                 â”‚
â”‚     // Add watermark with timestamp & location  â”‚
â”‚     const watermarked = await addWatermark(     â”‚
â”‚       photo,                                    â”‚
â”‚       {                                         â”‚
â”‚         timestamp: new Date(),                  â”‚
â”‚         location: driverLocation,               â”‚
â”‚         orderId: orderNumber                    â”‚
â”‚       }                                         â”‚
â”‚     )                                           â”‚
â”‚                                                 â”‚
â”‚     // Compress                                 â”‚
â”‚     const compressed = await                    â”‚
â”‚       ImageCompressor.compress(                 â”‚
â”‚         watermarked,                            â”‚
â”‚         { quality: 0.8, maxWidth: 1920 }        â”‚
â”‚       )                                         â”‚
â”‚                                                 â”‚
â”‚     // Upload to S3                             â”‚
â”‚     const url = await uploadPhoto(              â”‚
â”‚       compressed,                               â”‚
â”‚       `deliveries/${orderId}/pod-${index}.jpg`  â”‚
â”‚     )                                           â”‚
â”‚                                                 â”‚
â”‚     setPhotos(prev => [...prev, url])           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚ STEP 3: COLLECT SIGNATURE                       â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚                                                 â”‚
â”‚ â†’ Layout:                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ CUSTOMER SIGNATURE                  â”‚       â”‚
â”‚   â”‚ Step 3 of 4                         â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Delivery method:                    â”‚       â”‚
â”‚   â”‚ â—‹ Hand-to-customer (signature)      â”‚       â”‚
â”‚   â”‚ â—‹ Contactless (OTP)                 â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ IF hand-to-customer:                â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [SIGNATURE PAD]                     â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Please sign here                    â”‚       â”‚
â”‚   â”‚ ___________________________         â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [Clear] [Confirm Signature]         â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ OR                                  â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ IF contactless:                     â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Enter OTP sent to customer:         â”‚       â”‚
â”‚   â”‚ [_] [_] [_] [_] [_] [_]            â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [Resend OTP]                        â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [NEXT STEP]                         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚
â”‚ â†’ Signature capture:                            â”‚
â”‚   Component: SignaturePad.tsx                   â”‚
â”‚   Uses: react-native-signature-canvas           â”‚
â”‚                                                 â”‚
â”‚   const onSignatureEnd = async (signature) => { â”‚
â”‚     // Convert to image                         â”‚
â”‚     const imageData = await                     â”‚
â”‚       signaturePad.toDataURL()                  â”‚
â”‚                                                 â”‚
â”‚     // Upload to S3                             â”‚
â”‚     const url = await uploadSignature(          â”‚
â”‚       imageData,                                â”‚
â”‚       `deliveries/${orderId}/signature.png`     â”‚
â”‚     )                                           â”‚
â”‚                                                 â”‚
â”‚     setSignatureUrl(url)                        â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â†’ OTP verification:                             â”‚
â”‚   const verifyOTP = async (otp) => {            â”‚
â”‚     const response = await                      â”‚
â”‚       deliveryApi.verifyDeliveryOTP({           â”‚
â”‚         orderId,                                â”‚
â”‚         otp                                     â”‚
â”‚       })                                        â”‚
â”‚                                                 â”‚
â”‚     if (response.valid) {                       â”‚
â”‚       setOtpVerified(true)                      â”‚
â”‚       proceedToNextStep()                       â”‚
â”‚     } else {                                    â”‚
â”‚       Alert.alert('Invalid OTP', 'Try again')   â”‚
â”‚     }                                           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚ STEP 4: PAYMENT & COMPLETION                    â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚                                                 â”‚
â”‚ â†’ Layout:                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ PAYMENT & COMPLETION                â”‚       â”‚
â”‚   â”‚ Step 4 of 4                         â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Payment Method:                     â”‚       â”‚
â”‚   â”‚ â€¢ Online (Already Paid) âœ“           â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ OR (if Cash on Delivery):           â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Order Amount: 450 QAR               â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Amount Received:                    â”‚       â”‚
â”‚   â”‚ [___________] QAR                   â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Change to Return: 50 QAR            â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [Confirm Payment Received]          â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Additional Notes (Optional):        â”‚       â”‚
â”‚   â”‚ [____________________________]      â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ Customer Feedback (Optional):       â”‚       â”‚
â”‚   â”‚ "How was the delivery?"             â”‚       â”‚
â”‚   â”‚ [â­â­â­â­â­]                           â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ âœ“ 3 items verified                  â”‚       â”‚
â”‚   â”‚ âœ“ 2 photos captured                 â”‚       â”‚
â”‚   â”‚ âœ“ Signature collected               â”‚       â”‚
â”‚   â”‚ âœ“ Payment confirmed                 â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â”‚ [ğŸ‰ COMPLETE DELIVERY ğŸ‰]           â”‚       â”‚
â”‚   â”‚                                     â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚
â”‚ â†’ Complete delivery handler:                    â”‚
â”‚   const completeDelivery = async () => {        â”‚
â”‚     setLoading(true)                            â”‚
â”‚                                                 â”‚
â”‚     try {                                       â”‚
â”‚       // Prepare POD data                       â”‚
â”‚       const podData = {                         â”‚
â”‚         orderId,                                â”‚
â”‚         deliveredAt: Date.now(),                â”‚
â”‚         items: verifiedItems.map(item => ({     â”‚
â”‚           itemId: item.id,                      â”‚
â”‚           verified: item.verified,              â”‚
â”‚           condition: item.condition,            â”‚
â”‚           notes: item.notes                     â”‚
â”‚         })),                                    â”‚
â”‚         photos: photoUrls,                      â”‚
â”‚         signature: {                            â”‚
â”‚           type: signatureType, // 'DIGITAL' or 'OTP'â”‚
â”‚           url: signatureUrl,                    â”‚
â”‚           otp: otpValue,                        â”‚
â”‚           verifiedAt: Date.now()                â”‚
â”‚         },                                      â”‚
â”‚         payment: {                              â”‚
â”‚           method: paymentMethod,                â”‚
â”‚           amount: totalAmount,                  â”‚
â”‚           amountReceived: cashReceived,         â”‚
â”‚           changeReturned: changeAmount,         â”‚
â”‚           paidAt: Date.now()                    â”‚
â”‚         },                                      â”‚
â”‚         location: {                             â”‚
â”‚           lat: deliveryLocation.latitude,       â”‚
â”‚           lng: deliveryLocation.longitude,      â”‚
â”‚           accuracy: locationAccuracy            â”‚
â”‚         },                                      â”‚
â”‚         notes: deliveryNotes,                   â”‚
â”‚         customerFeedback: {                     â”‚
â”‚           rating: customerRating,               â”‚
â”‚           comment: customerComment              â”‚
â”‚         }                                       â”‚
â”‚       }                                         â”‚
â”‚                                                 â”‚
â”‚       // API call                               â”‚
â”‚       const response = await                    â”‚
â”‚         deliveryApi.completeDelivery(podData)   â”‚
â”‚                                                 â”‚
â”‚       if (response.success) {                   â”‚
â”‚         // Show success screen                  â”‚
â”‚         navigation.navigate('DeliveryCompleteScreen',â”‚
â”‚           {                                     â”‚
â”‚             earnings: response.earnings,        â”‚
â”‚             deliveryId: response.deliveryId,    â”‚
â”‚             rating: response.driverRating       â”‚
â”‚           }                                     â”‚
â”‚         )                                       â”‚
â”‚       }                                         â”‚
â”‚     } catch (error) {                           â”‚
â”‚       Alert.alert(                              â”‚
â”‚         'Error',                                â”‚
â”‚         'Failed to complete delivery. Try again'â”‚
â”‚       )                                         â”‚
â”‚     } finally {                                 â”‚
â”‚       setLoading(false)                         â”‚
â”‚     }                                           â”‚
â”‚   }                                             â”‚
â”‚                                                 â”‚
â”‚ Backend (Delivery Service):                     â”‚
â”‚ â†’ POST /api/v1/orders/{orderId}/complete        â”‚
â”‚                                                 â”‚
â”‚ â†’ Controller: delivery.controller.ts            â”‚
â”‚                                                 â”‚
â”‚ â†’ CRITICAL TRANSACTION:                         â”‚
â”‚   BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLEâ”‚
â”‚                                                 â”‚
â”‚   -- 1. Update delivery status                  â”‚
â”‚   UPDATE deliveries SET                         â”‚
â”‚     status = 'COMPLETED',                       â”‚
â”‚     completed_at = NOW(),                       â”‚
â”‚     delivery_duration = EXTRACT(EPOCH FROM      â”‚
â”‚       (NOW() - picked_up_at)                    â”‚
â”‚     ),                                          â”‚
â”‚     signature_type = $1,                        â”‚
â”‚     signature_url = $2,                         â”‚
â”‚     otp_verified = $3,                          â”‚
â”‚     delivery_notes = $4,                        â”‚
â”‚     customer_rating = $5                        â”‚
â”‚   WHERE order_id = $6                           â”‚
â”‚   RETURNING id, delivery_duration               â”‚
â”‚                                                 â”‚
â”‚   -- 2. Update order status                     â”‚
â”‚   UPDATE orders SET                             â”‚
â”‚     status = 'DELIVERED',                       â”‚
â”‚     delivered_at = NOW(),                       â”‚
â”‚     completion_time = EXTRACT(EPOCH FROM        â”‚
â”‚       (NOW() - created_at)                      â”‚
â”‚     )                                           â”‚
â”‚   WHERE id =


You are out of free messages until 10:00 PM
Upgrade
Continue


Claude is AI and can make mistakes. Please double-check responses.


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QScrap Garage Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Dark Theme (Default) */
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: rgba(30, 30, 50, 0.8);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.3);
            --input-bg: rgba(255, 255, 255, 0.05);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-card: rgba(255, 255, 255, 0.9);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.2);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(0, 0, 0, 0.03);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Smooth theme transition */
        body,
        .sidebar,
        .stat-card,
        .request-card,
        .bid-card,
        .order-card,
        .modal,
        .login-card {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-logo p {
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--accent-glow);
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .sidebar-subtitle {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 32px;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white;
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .btn-logout {
            width: 100%;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            color: var(--danger);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Theme Toggle Switch */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
        }

        .theme-toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .theme-toggle-label i {
            font-size: 18px;
            color: var(--accent);
        }

        .theme-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            transition: all 0.3s;
        }

        .theme-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] .theme-switch {
            background: var(--accent);
        }

        [data-theme="light"] .theme-switch::before {
            transform: translateX(24px);
        }

        .theme-icon {
            transition: transform 0.3s, opacity 0.3s;
        }

        /* Dark mode (default): Show moon, hide sun */
        .theme-icon-moon {
            opacity: 1;
        }

        .theme-icon-sun {
            display: none;
        }

        /* Light mode: Show sun, hide moon */
        [data-theme="light"] .theme-icon-moon {
            display: none;
        }

        [data-theme="light"] .theme-icon-sun {
            display: inline;
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 32px;
            min-height: 100vh;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--success);
            font-size: 14px;
            font-weight: 500;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-icon.blue {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent);
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .stat-icon.yellow {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .stat-icon.purple {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Content Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
        }

        /* Request Cards */
        .requests-grid {
            display: grid;
            gap: 16px;
        }

        .request-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border-left: 4px solid var(--accent);
        }

        .request-card:hover {
            transform: translateX(4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .request-card.new {
            border-left-color: var(--success);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .request-info h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .request-info p {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .request-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .request-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-bid {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-bid:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px var(--accent-glow);
        }

        /* Bid Cards */
        .bid-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .bid-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .bid-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
        }

        .bid-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .bid-status.pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .bid-status.accepted {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .bid-status.rejected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .bid-status.withdrawn {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-secondary);
        }

        .bid-status.expired {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-secondary);
        }

        /* Order Cards */
        .order-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .order-number {
            font-weight: 700;
            font-size: 18px;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .order-status.confirmed {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent);
        }

        .order-status.preparing {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .order-status.in_transit {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .order-status.delivered {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .btn-status {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-status:hover {
            opacity: 0.9;
        }

        .btn-status.next {
            background: var(--success);
            color: white;
        }

        .btn-cancel {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-cancel:hover {
            background: var(--danger);
            color: white;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        /* Thumbnails */
        .request-thumbnails {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .thumb {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            overflow: hidden;
            cursor: zoom-in;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .thumb:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: grab;
            overflow: hidden;
        }

        .lightbox-content:active {
            cursor: grabbing;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            transition: transform 0.1s ease-out;
            transform-origin: center;
            user-select: none;
            pointer-events: none;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 32px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2002;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-toolbar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 2002;
            backdrop-filter: blur(5px);
        }

        .lightbox-toolbar button {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .lightbox-toolbar button:hover {
            transform: scale(1.2);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2002;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-nav.prev {
            left: 20px;
        }

        .lightbox-nav.next {
            right: 20px;
        }

        .lightbox-can-drag-hint {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            pointer-events: none;
        }


        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h4 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* Bid Photo Upload */
        .bid-photo-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
        }

        .bid-photo-upload:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }

        .bid-photo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .bid-photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        .bid-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bid-photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Counter-Offer Respond Modal */
        .counter-respond-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .counter-respond-modal.active {
            display: flex;
        }

        .counter-respond-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }

        .counter-respond-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .counter-respond-header h3 {
            font-size: 18px;
            font-weight: 700;
        }

        .counter-respond-close {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
        }

        .counter-respond-body {
            padding: 24px;
        }

        .counter-price-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .counter-price-display .your-bid {
            text-align: left;
        }

        .counter-price-display .customer-offer {
            text-align: right;
        }

        .counter-price-display label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .counter-price-display .price {
            font-size: 22px;
            font-weight: 800;
        }

        .counter-price-display .your-bid .price {
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        .counter-price-display .customer-offer .price {
            color: var(--accent);
        }

        .counter-message-display {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 20px;
            font-style: italic;
            color: var(--text-secondary);
        }

        .counter-respond-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .counter-respond-btn {
            padding: 14px 8px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .counter-respond-btn.accept {
            background: var(--accent);
            color: white;
        }

        .counter-respond-btn.reject {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .counter-respond-btn.counter {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .counter-respond-btn i {
            font-size: 20px;
        }

        .counter-input-section {
            display: none;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .counter-input-section.active {
            display: block;
        }

        .counter-input-section label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .counter-input-row {
            display: flex;
            gap: 8px;
        }

        .counter-input-row input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 700;
        }

        .counter-input-row button {
            padding: 12px 20px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .counter-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Request Thumbnails */
        .request-thumbnails {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .request-thumbnails .thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            cursor: zoom-in;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .request-thumbnails .thumb:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .request-thumbnails .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Technical Specs */
        .tech-specs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }

        .tech-specs .spec-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .tech-specs .spec-item i {
            color: var(--accent);
        }

        .tech-specs .spec-item.vin {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            font-family: 'Courier New', monospace;
        }

        .tech-specs .spec-item.vin strong {
            letter-spacing: 1px;
        }

        .tech-specs .spec-item.condition {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            font-weight: 600;
        }

        /* Request Card Actions */
        .request-actions {
            display: flex;
            gap: 8px;
        }

        .btn-ignore {
            padding: 12px 20px;
            background: rgba(100, 116, 139, 0.2);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ignore:hover {
            background: rgba(100, 116, 139, 0.3);
        }

        .request-card.ignored {
            opacity: 0.5;
            border-left-color: var(--text-secondary);
        }

        .request-card.ignored .btn-bid,
        .request-card.ignored .btn-ignore {
            display: none;
        }

        .ignored-badge {
            padding: 8px 16px;
            background: rgba(100, 116, 139, 0.2);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Cancelled Items Styling */
        .order-card.cancelled,
        .bid-card.cancelled {
            opacity: 0.7;
            position: relative;
            border-left-color: var(--danger);
        }

        .order-card.cancelled::before,
        .bid-card.cancelled::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--danger), transparent);
            animation: cancelStrike 0.5s ease-out;
        }

        @keyframes cancelStrike {
            from {
                transform: scaleX(0);
            }

            to {
                transform: scaleX(1);
            }
        }

        .order-status.cancelled {
            background: rgba(239, 68, 68, 0.15) !important;
            color: var(--danger) !important;
        }

        .cancelled-overlay {
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 10px,
                    rgba(239, 68, 68, 0.03) 10px,
                    rgba(239, 68, 68, 0.03) 20px);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Bid Submitted Badge */
        .bid-submitted-badge {
            padding: 10px 20px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 10px;
            color: var(--success);
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .request-card.bidded {
            border-left-color: var(--success);
        }

        /* Bid Action Group */
        .bid-action-group {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .btn-update-bid {
            padding: 8px 16px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--accent);
            border-radius: 8px;
            color: var(--accent);
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-update-bid:hover {
            background: var(--accent);
            color: white;
        }

        .btn-dismiss {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-dismiss:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <h1>ðŸ”§ QScrap</h1>
                <p>Garage Partner Portal</p>
            </div>

            <div class="auth-tabs" style="display: flex; gap: 8px; margin-bottom: 24px;">
                <button class="auth-tab active" onclick="switchAuthTab('login')"
                    style="flex: 1; padding: 12px; border: 2px solid var(--border); background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); border-radius: 10px; font-weight: 600; color: white; cursor: pointer;">Sign
                    In</button>
                <button class="auth-tab" onclick="switchAuthTab('register')"
                    style="flex: 1; padding: 12px; border: 2px solid var(--border); background: rgba(255,255,255,0.05); border-radius: 10px; font-weight: 600; color: var(--text-secondary); cursor: pointer;">Register</button>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" class="form-control" id="loginPhone" placeholder="+974..." required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>

            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label>Garage Name</label>
                    <input type="text" class="form-control" id="regGarageName" placeholder="Your Garage Name" required>
                </div>
                <div class="form-group">
                    <label>Owner Name</label>
                    <input type="text" class="form-control" id="regOwnerName" placeholder="Owner Full Name" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" class="form-control" id="regPhone" placeholder="+974..." required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" class="form-control" id="regAddress" placeholder="Garage Location" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="regPassword" placeholder="Min 6 characters"
                        required>
                </div>
                <button type="submit" class="btn btn-primary">Create Partner Account</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">ðŸ”§ QScrap</div>
            <div class="sidebar-subtitle">Garage Partner Dashboard</div>

            <nav class="nav-menu">
                <a class="nav-item active" data-section="dashboard">
                    <i class="bi bi-grid-1x2-fill"></i>
                    Dashboard
                </a>
                <a class="nav-item" data-section="requests">
                    <i class="bi bi-inbox-fill"></i>
                    Live Requests
                    <span class="nav-badge" id="requestBadge">0</span>
                </a>
                <a class="nav-item" data-section="bids">
                    <i class="bi bi-tag-fill"></i>
                    My Bids
                </a>
                <a class="nav-item" data-section="orders">
                    <i class="bi bi-box-seam-fill"></i>
                    Orders
                    <span class="nav-badge dispute-badge" id="disputeBadge"
                        style="background: #f59e0b; display: none;">0</span>
                </a>
                <a class="nav-item" data-section="profile">
                    <i class="bi bi-person-fill"></i>
                    Profile
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">G</div>
                    <div>
                        <div class="user-name" id="userName">Garage Name</div>
                        <div class="user-role">Partner</div>
                    </div>
                </div>

                <!-- Theme Toggle -->
                <div class="theme-toggle" onclick="toggleTheme()">
                    <div class="theme-toggle-label">
                        <i class="bi bi-moon-stars-fill theme-icon theme-icon-moon"></i>
                        <i class="bi bi-sun-fill theme-icon theme-icon-sun"></i>
                        <span id="themeLabel">Dark Mode</span>
                    </div>
                    <div class="theme-switch"></div>
                </div>

                <button class="btn-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-left"></i> Sign Out
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section class="section active" id="sectionDashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        Connected
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="bi bi-tag"></i></div>
                        <div class="stat-value" id="statPendingBids">0</div>
                        <div class="stat-label">Pending Bids</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="bi bi-check-circle"></i></div>
                        <div class="stat-value" id="statAcceptedBids">0</div>
                        <div class="stat-label">Accepted This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow"><i class="bi bi-box-seam"></i></div>
                        <div class="stat-value" id="statActiveOrders">0</div>
                        <div class="stat-label">Active Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="bi bi-currency-dollar"></i></div>
                        <div class="stat-value" id="statRevenue">0</div>
                        <div class="stat-label">Revenue (QAR)</div>
                    </div>
                </div>

                <div class="section-header">
                    <h3 class="section-title">Recent Requests</h3>
                </div>
                <div id="dashboardRequests" class="requests-grid"></div>
            </section>

            <!-- Requests Section -->
            <section class="section" id="sectionRequests">
                <div class="page-header">
                    <h1 class="page-title">Live Requests</h1>
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        Real-time
                    </div>
                </div>
                <div id="requestsList" class="requests-grid"></div>
            </section>

            <!-- Bids Section -->
            <section class="section" id="sectionBids">
                <div class="page-header">
                    <h1 class="page-title">My Bids</h1>
                </div>
                <div id="bidsList"></div>
            </section>

            <!-- Orders Section -->
            <section class="section" id="sectionOrders">
                <div class="page-header">
                    <h1 class="page-title">Orders</h1>
                </div>
                <div id="ordersList"></div>
            </section>

            <!-- Profile Section -->
            <section class="section" id="sectionProfile">
                <div class="page-header">
                    <h1 class="page-title">Profile & Subscription</h1>
                </div>
                <div id="profileContent"></div>
            </section>
        </main>
    </div>

    <!-- Bid Modal -->
    <div class="modal-overlay" id="bidModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Submit Bid</h3>
                <button class="modal-close" onclick="closeBidModal()">&times;</button>
            </div>
            <form id="bidForm">
                <input type="hidden" id="bidRequestId">
                <p id="bidRequestInfo" style="color: var(--text-secondary); margin-bottom: 20px;"></p>

                <div class="form-group">
                    <label>Price (QAR) *</label>
                    <input type="number" class="form-control" id="bidAmount" required min="1"
                        placeholder="Enter your price">
                </div>
                <div class="form-group">
                    <label>Part Condition *</label>
                    <select class="form-control" id="bidCondition" required>
                        <option value="new">New</option>
                        <option value="used_excellent">Used - Excellent</option>
                        <option value="used_good" selected>Used - Good</option>
                        <option value="used_fair">Used - Fair</option>
                        <option value="refurbished">Refurbished</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Warranty (Days)</label>
                    <input type="number" class="form-control" id="bidWarranty" value="7" required min="0">
                </div>

                <!-- Photo Upload Section -->
                <div class="form-group">
                    <label><i class="bi bi-camera" style="color: var(--accent);"></i> Upload Part Photos
                        <span style="font-weight: 400; color: var(--text-muted);">(Max 10 images, 5MB
                            each)</span></label>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                        Show the customer the actual part you have. Better photos = higher acceptance rate!
                    </p>
                    <div class="bid-photo-upload" id="bidPhotoUpload"
                        onclick="document.getElementById('bidPhotoInput').click()">
                        <i class="bi bi-images" style="font-size: 32px; color: var(--accent); margin-bottom: 8px;"></i>
                        <span>Click to add photos</span>
                        <span id="photoCounter" style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">0 /
                            10 photos</span>
                    </div>
                    <input type="file" id="bidPhotoInput" accept="image/jpeg,image/png,image/webp,image/gif" multiple
                        style="display: none;">
                    <div class="bid-photo-grid" id="bidPhotoGrid"></div>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea class="form-control" id="bidNotes" rows="2"
                        placeholder="Part number, compatibility info, delivery estimate..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i> Submit Bid</button>
            </form>
        </div>
    </div>

    <!-- Counter-Offer Respond Modal -->
    <div class="counter-respond-modal" id="counterRespondModal">
        <div class="counter-respond-content">
            <div class="counter-respond-header">
                <h3>ðŸ’° Customer Counter-Offer</h3>
                <button class="counter-respond-close" onclick="closeCounterRespondModal()">Ã—</button>
            </div>
            <div class="counter-respond-body">
                <div class="counter-price-display">
                    <div class="your-bid">
                        <label>Your Bid</label>
                        <div class="price" id="respondYourBid">0 QAR</div>
                    </div>
                    <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--accent);"></i>
                    <div class="customer-offer">
                        <label>Customer Offers</label>
                        <div class="price" id="respondCustomerOffer">0 QAR</div>
                    </div>
                </div>

                <div class="counter-message-display" id="respondCustomerMessage" style="display: none;">
                    "Customer message here"
                </div>

                <div class="counter-respond-actions">
                    <button class="counter-respond-btn accept" onclick="respondToCounter('accept')">
                        <i class="bi bi-check-circle"></i>
                        Accept
                    </button>
                    <button class="counter-respond-btn reject" onclick="respondToCounter('reject')">
                        <i class="bi bi-x-circle"></i>
                        Decline
                    </button>
                    <button class="counter-respond-btn counter" onclick="showCounterInput()">
                        <i class="bi bi-arrow-repeat"></i>
                        Counter
                    </button>
                </div>

                <div class="counter-input-section" id="counterInputSection">
                    <label>Your Counter-Offer Price</label>
                    <div class="counter-input-row">
                        <input type="number" id="garageCounterAmount" placeholder="Enter amount">
                        <button onclick="respondToCounter('counter')">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dispute Response Modal -->
    <div class="counter-respond-modal" id="disputeRespondModal">
        <div class="counter-respond-content" style="max-width: 450px;">
            <div class="counter-respond-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h3>âš ï¸ Customer Dispute</h3>
                <button class="counter-respond-close" onclick="closeDisputeModal()">Ã—</button>
            </div>
            <div class="counter-respond-body">
                <div
                    style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 13px; color: var(--text-secondary);">Order</div>
                    <div id="disputeOrderNumber" style="font-size: 16px; font-weight: 700;"></div>
                </div>

                <div style="margin-bottom: 16px;">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Issue Reason</div>
                    <div id="disputeReason" style="font-size: 15px; font-weight: 600; color: var(--warning);"></div>
                </div>

                <div id="disputeDescription"
                    style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none;">
                </div>

                <div id="disputePhotos" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;"></div>

                <div
                    style="display: flex; justify-content: space-between; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; margin-bottom: 16px;">
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Refund Amount</div>
                        <div id="disputeRefundAmount" style="font-size: 18px; font-weight: 700; color: var(--danger);">0
                            QAR</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Restocking Fee</div>
                        <div id="disputeRestockingFee"
                            style="font-size: 18px; font-weight: 700; color: var(--success);">0 QAR</div>
                    </div>
                </div>

                <div class="counter-respond-actions">
                    <button class="counter-respond-btn accept" onclick="respondToDispute('accept')">
                        <i class="bi bi-check-circle"></i>
                        Accept Return
                    </button>
                    <button class="counter-respond-btn reject" onclick="showContestInput()">
                        <i class="bi bi-x-circle"></i>
                        Contest
                    </button>
                </div>

                <div class="counter-input-section" id="contestInputSection" style="display: none;">
                    <label>Explain why you contest this dispute</label>
                    <textarea class="form-control" id="contestReason" rows="3"
                        placeholder="Provide evidence or explanation..."></textarea>
                    <button class="btn btn-primary" onclick="respondToDispute('contest')"
                        style="width: 100%; margin-top: 12px;">
                        <i class="bi bi-send"></i> Submit Contest
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        const API_URL = '/api';
        let token = localStorage.getItem('token');
        let userId = localStorage.getItem('userId');
        let userType = localStorage.getItem('userType');

        // STRICT ROLE CHECK: If logged in as customer, force logout on garage dashboard
        if (token && userType && userType !== 'garage') {
            console.warn('Wrong user role for Garage Dashboard. Clearing session.');
            localStorage.clear();
            token = null;
            userId = null;
            userType = null;
        }

        let socket = null;
        let requests = [];
        let ignoredRequests = JSON.parse(localStorage.getItem('ignoredRequests') || '[]');
        let biddedRequests = []; // Track requests we've already bid on (pending)
        let rejectedRequests = []; // Track requests where our bid was rejected
        let bidStatusMap = {}; // Full status map: request_id -> {status, bid_id}
        let dismissedRequests = JSON.parse(localStorage.getItem('dismissedRequests') || '[]');
        let bidPhotos = [];
        let pendingCounterOffers = []; // Track counter-offers from customers
        let pendingDisputes = []; // Track disputes from customers

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Use saved theme, or system preference, or default to dark
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            setTheme(theme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            // Update label text
            const label = document.getElementById('themeLabel');
            if (label) {
                label.textContent = theme === 'light' ? 'Light Mode' : 'Dark Mode';
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // Initialize theme immediately (before DOM fully loads)
        initTheme();

        // Initialize app
        if (token) {
            showDashboard();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: phone, password })
                });
                const data = await res.json();

                if (data.token) {
                    if (data.userType !== 'garage') {
                        showToast('This portal is for garage partners only', 'error');
                        return;
                    }
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('userId', data.userId);
                    localStorage.setItem('userType', 'garage');
                    token = data.token;
                    userId = data.userId;
                    userType = 'garage';
                    showDashboard();
                } else {
                    showToast(data.error || 'Login failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        // Auth Tab Switching
        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs[0].style.background = tab === 'login' ? 'linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%)' : 'rgba(255,255,255,0.05)';
            tabs[0].style.color = tab === 'login' ? 'white' : 'var(--text-secondary)';
            tabs[1].style.background = tab === 'register' ? 'linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%)' : 'rgba(255,255,255,0.05)';
            tabs[1].style.color = tab === 'register' ? 'white' : 'var(--text-secondary)';

            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
        }

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const garageName = document.getElementById('regGarageName').value;
            const ownerName = document.getElementById('regOwnerName').value;
            const phone = document.getElementById('regPhone').value;
            const address = document.getElementById('regAddress').value;
            const password = document.getElementById('regPassword').value;

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: phone,
                        password,
                        full_name: ownerName,
                        user_type: 'garage',
                        garage_name: garageName,
                        address: address
                    })
                });
                const data = await res.json();

                if (data.userId) {
                    showToast('Account created! Please sign in.', 'success');
                    switchAuthTab('login');
                    document.getElementById('registerForm').reset();
                } else {
                    showToast(data.error || 'Registration failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // ===== NOTIFICATION SYSTEM =====
        var notificationSound = null;

        function initNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            notificationSound = (freq = 800, duration = 0.3) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            };
        }

        function playNotificationSound(type = 'default') {
            if (!notificationSound) return;
            try {
                if (type === 'newRequest') {
                    // Double beep for new requests
                    notificationSound(880, 0.15);
                    setTimeout(() => notificationSound(1100, 0.2), 200);
                } else if (type === 'success') {
                    notificationSound(1000, 0.3);
                } else if (type === 'warning') {
                    notificationSound(400, 0.4);
                } else {
                    notificationSound(800, 0.3);
                }
            } catch (e) { console.error('Sound error:', e); }
        }

        async function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');

            // Initialize notification sound
            initNotificationSound();

            // Connect Socket
            socket = io();
            socket.emit('join_garage_room', userId);

            socket.on('new_request', (data) => {
                playNotificationSound('newRequest');
                prependRequest(data);
                showToast('ðŸ”” New part request!', 'success');
                updateBadge();
            });

            socket.on('bid_accepted', (data) => {
                playNotificationSound('success');
                showToast(data.notification, 'success');
                loadBids();
                loadOrders();
                loadStats();
            });

            socket.on('bid_rejected', (data) => {
                playNotificationSound('warning');
                showToast(data.message || 'Your bid was not selected', 'warning');
                loadBids();
            });

            socket.on('request_cancelled', (data) => {
                playNotificationSound('warning');
                showToast('âš ï¸ Customer cancelled a request', 'warning');
                // Remove the cancelled request from local list
                requests = requests.filter(r => r.request_id !== data.request_id);
                renderRequests();
                loadBids();
                updateBadge();
            });

            // NEW: Counter-offer listeners
            socket.on('counter_offer_received', (data) => {
                playNotificationSound('newRequest'); // Use distinct sound
                showToast(data.notification || 'New counter-offer received!', 'info');
                loadPendingCounterOffers(); // Auto-fetch and open modal
                loadBids(); // Update list
            });

            socket.on('counter_offer_accepted', (data) => {
                playNotificationSound('success');
                showToast(data.notification, 'success');
                loadBids();
                loadStats();
            });

            socket.on('counter_offer_rejected', (data) => {
                playNotificationSound('warning');
                showToast(data.notification, 'warning');
                loadBids();
            });

            // Request expired notification
            socket.on('request_expired', (data) => {
                showToast(data.notification, 'warning');
                // Remove expired request from local list
                requests = requests.filter(r => r.request_id !== data.request_id);
                renderRequests();
                loadBids();
                updateBadge();
            });

            // Counter offer expired notification
            socket.on('counter_offer_expired', (data) => {
                showToast(data.notification, 'warning');
                loadBids();
            });

            socket.on('order_cancelled', (data) => {
                playNotificationSound('warning');
                showToast('âš ï¸ Order has been cancelled', 'warning');
                loadOrders();
                loadStats();
            });

            // Order completed - Customer confirmed delivery
            socket.on('order_completed', (data) => {
                playNotificationSound('success');
                showToast(data.notification, 'success');
                loadOrders();
                loadStats();
            });

            // Counter-offer handlers
            socket.on('counter_offer_received', (data) => {
                playNotificationSound('newRequest');
                showToast(data.notification, 'info');
                // Store for responding later
                pendingCounterOffers.push(data);
                loadBids();
                // Auto-open the respond modal
                setTimeout(() => {
                    openCounterRespondModal(
                        data.counter_offer_id,
                        parseFloat(data.original_amount),
                        parseFloat(data.proposed_amount),
                        data.message
                    );
                }, 500);
            });

            socket.on('counter_offer_accepted', (data) => {
                playNotificationSound('success');
                showToast(data.notification, 'success');
                loadBids();
            });

            socket.on('counter_offer_rejected', (data) => {
                playNotificationSound('warning');
                showToast(data.notification, 'warning');
                loadBids();
            });

            // Dispute handlers - Professional queue approach (no modal spam)
            socket.on('dispute_created', (data) => {
                playNotificationSound('warning');
                showToast(data.notification, 'warning');
                // Store in pending disputes queue
                pendingDisputes.push(data);
                // Update badge counter
                updateDisputeBadge();
                // Reload orders to show disputed status
                loadOrders();
            });

            socket.on('dispute_resolved', (data) => {
                playNotificationSound('warning');
                showToast(data.notification, 'info');
                loadOrders();
                loadStats();
            });

            // Load initial data
            await Promise.all([
                loadStats(),
                loadRequests(),
                loadBids(),
                loadOrders(),
                loadProfile()
            ]);

            // Check for pending counter-offers (after bids are loaded)
            loadPendingCounterOffers();

            // Check for pending disputes
            loadPendingDisputes();

            // Setup navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchSection(item.dataset.section));
            });
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/dashboard/garage/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                console.log('Dashboard stats response:', data);

                if (data.stats) {
                    document.getElementById('statPendingBids').textContent = data.stats.pending_bids;
                    document.getElementById('statAcceptedBids').textContent = data.stats.accepted_bids_month;
                    document.getElementById('statActiveOrders').textContent = data.stats.active_orders;
                    document.getElementById('statRevenue').textContent = data.stats.revenue_month.toLocaleString();
                }
                if (data.profile && data.profile.garage_name) {
                    document.getElementById('userName').textContent = data.profile.garage_name;
                    document.getElementById('userAvatar').textContent = data.profile.garage_name[0].toUpperCase();
                } else {
                    console.warn('No profile or garage_name found:', data.profile);
                }
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        async function loadRequests() {
            try {
                const res = await fetch(`${API_URL}/requests/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                requests = await res.json();
                renderRequests();
                updateBadge();
            } catch (err) {
                console.error('Failed to load requests:', err);
            }
        }

        function renderRequests() {
            const html = requests.length ? requests.map(r => createRequestCard(r)).join('') :
                '<div class="empty-state"><i class="bi bi-inbox"></i><h4>No requests yet</h4><p>New requests will appear here in real-time</p></div>';

            document.getElementById('requestsList').innerHTML = html;
            document.getElementById('dashboardRequests').innerHTML = requests.slice(0, 3).map(r => createRequestCard(r)).join('') ||
                '<div class="empty-state"><i class="bi bi-inbox"></i><h4>Waiting for requests...</h4></div>';
        }

        function createRequestCard(req, isNew = false) {
            const title = req.car_make ? `${req.car_make} ${req.car_model} ${req.car_year || ''}` :
                req.summary?.car || 'Vehicle';
            const desc = req.part_description || req.summary?.part || 'Part Request';
            const id = req.request_id;
            const age = req.created_at ? getTimeAgo(req.created_at) : 'Just now';
            const isIgnored = ignoredRequests.includes(id);
            const hasBid = biddedRequests.includes(id);

            let actionHtml = '';
            const bidInfo = bidStatusMap[id];
            const isDismissed = dismissedRequests.includes(id);

            if (isDismissed) {
                // Don't show dismissed requests at all
                return '';
            } else if (bidInfo) {
                // We have a bid on this request - show status based on bid lifecycle
                const statusConfig = {
                    pending: { class: 'pending', icon: 'hourglass-split', text: 'Bid Pending' },
                    accepted: { class: 'accepted', icon: 'check-circle-fill', text: 'Bid Accepted âœ“' },
                    rejected: { class: 'rejected', icon: 'x-circle-fill', text: 'Bid Rejected' },
                    withdrawn: { class: 'withdrawn', icon: 'arrow-counterclockwise', text: 'Withdrawn' },
                    expired: { class: 'expired', icon: 'clock-history', text: 'Expired' }
                };
                const config = statusConfig[bidInfo.status] || { class: 'pending', icon: 'question', text: bidInfo.status };

                let actionsBtn = '';
                if (bidInfo.status === 'pending') {
                    // Pending: Show Update Bid button
                    actionsBtn = `<button class="btn-update-bid" onclick="openUpdateBidModal('${bidInfo.bid_id}', '${title.replace(/'/g, "\\'")}')">
                        <i class="bi bi-pencil"></i> Update
                    </button>`;
                } else if (['rejected', 'expired', 'withdrawn'].includes(bidInfo.status)) {
                    // Rejected/Expired: Show Dismiss button
                    actionsBtn = `<button class="btn-dismiss" onclick="dismissRequest('${id}')">
                        <i class="bi bi-x-lg"></i> Dismiss
                    </button>`;
                }

                actionHtml = `<div class="bid-action-group">
                    <span class="bid-status ${config.class}"><i class="bi bi-${config.icon}"></i> ${config.text}</span>
                    ${actionsBtn}
                </div>`;
            } else if (isIgnored) {
                actionHtml = `<span class="ignored-badge"><i class="bi bi-eye-slash"></i> Ignored</span>`;
            } else {
                actionHtml = `<div class="request-actions">
                    <button class="btn-ignore" onclick="ignoreRequest('${id}')" title="Skip this request">
                        <i class="bi bi-x-lg"></i> Skip
                    </button>
                    <button class="btn-bid" onclick="openBidModal('${id}', '${title.replace(/'/g, "\\'")} - ${desc.replace(/'/g, "\\'")}')">
                        <i class="bi bi-tag-fill"></i> Bid Now
                    </button>
                </div>`;
            }

            // Safe image handling with URL normalization
            let imagesHtml = '';
            if (req.image_urls && req.image_urls.length > 0) {
                const normalizedUrls = req.image_urls.map(url => url.startsWith('/') ? url : '/' + url);
                imagesHtml = `<div class="request-thumbnails">
                    ${normalizedUrls.map((url, idx) => `
                        <div class="thumb" onclick="openRequestLightbox('${id}', ${idx})">
                            <img src="${url}" onerror="this.src='https://placehold.co/100?text=No+Image'">
                        </div>
                    `).join('')}
                 </div>`;
            }

            return `
                <div class="request-card ${isNew ? 'new' : ''} ${isIgnored ? 'ignored' : ''} ${hasBid ? 'bidded' : ''}" data-id="${id}">
                    <div class="request-info">
                        <h4>${title}</h4>
                        <p>${desc}</p>
                        
                        <!-- Technical Specs for Garage -->
                        <div class="tech-specs">
                            ${req.vin_number ? `<span class="spec-item vin"><i class="bi bi-upc-scan"></i> VIN: <strong>${req.vin_number}</strong></span>` : ''}
                            ${req.part_number ? `<span class="spec-item"><i class="bi bi-hash"></i> Part#: <strong>${req.part_number}</strong></span>` : ''}
                            ${req.part_category ? `<span class="spec-item"><i class="bi bi-folder"></i> ${req.part_category}</span>` : ''}
                            ${req.condition_required && req.condition_required !== 'any' ? `<span class="spec-item condition"><i class="bi bi-star-fill"></i> ${req.condition_required.toUpperCase()}</span>` : ''}
                        </div>
                        
                        ${imagesHtml}
                        <div class="request-meta">
                            <span><i class="bi bi-clock"></i> ${age}</span>
                            <span><i class="bi bi-tag"></i> ${req.bid_count || 0} bids</span>
                        </div>
                    </div>
                    ${actionHtml}
                </div>
            `;
        }

        function openRequestLightbox(id, index) {
            // Find request in the global list
            const req = requests.find(r => r.request_id === id);
            if (req && req.image_urls) {
                openLightbox(req.image_urls, index);
            }
        }

        function prependRequest(data) {
            const newReq = {
                request_id: data.request_id,
                car_make: data.summary?.car?.split(' ')[0],
                car_model: data.summary?.car?.split(' ').slice(1).join(' '),
                part_description: data.summary?.part,
                created_at: data.summary?.timestamp || new Date().toISOString(),
                image_urls: data.image_urls || [],
                bid_count: 0
            };
            requests.unshift(newReq);
            renderRequests();
        }

        async function loadBids() {
            try {
                const res = await fetch(`${API_URL}/bids/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bids = await res.json();

                // Build comprehensive bid status map
                bidStatusMap = {};
                bids.forEach(b => {
                    bidStatusMap[b.request_id] = { status: b.status, bid_id: b.bid_id };
                });

                // Legacy arrays for backward compatibility
                biddedRequests = bids.filter(b => b.status === 'pending').map(b => b.request_id);
                rejectedRequests = bids.filter(b => b.status === 'rejected').map(b => b.request_id);

                renderRequests(); // Re-render to show correct state
                updateBadge(); // Update badge after bidStatusMap is set

                const html = bids.length ? bids.map(b => {
                    const statusLabels = { pending: 'Pending', accepted: 'Accepted', rejected: 'Rejected', withdrawn: 'Withdrawn', expired: 'Expired' };
                    return `
                    <div class="bid-card ${b.status === 'rejected' ? 'rejected' : ''}">
                        <div class="bid-header">
                            <div>
                                <div class="bid-amount">${b.bid_amount} QAR</div>
                                <div style="color: var(--text-secondary); font-size: 14px;">
                                    ${b.car_summary || 'Vehicle'} - ${b.part_description || 'Part'}
                                </div>
                            </div>
                            <span class="bid-status ${b.status}">${statusLabels[b.status] || b.status}</span>
                        </div>
                        <div class="request-meta">
                            <span><i class="bi bi-calendar"></i> ${getTimeAgo(b.created_at)}</span>
                            <span><i class="bi bi-shield-check"></i> ${b.warranty_days} days warranty</span>
                        </div>
                    </div>
                `}).join('') : '<div class="empty-state"><i class="bi bi-tag"></i><h4>No bids yet</h4><p>Submit bids on part requests to see them here</p></div>';

                document.getElementById('bidsList').innerHTML = html;
            } catch (err) {
                console.error('Failed to load bids:', err);
            }
        }

        // Load pending counter-offers on page load
        async function loadPendingCounterOffers() {
            try {
                const res = await fetch(`${API_URL}/negotiations/pending-offers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.pending_offers && data.pending_offers.length > 0) {
                    // Store them and open modal for first one
                    pendingCounterOffers = data.pending_offers.map(co => ({
                        counter_offer_id: co.counter_offer_id,
                        bid_id: co.bid_id,
                        proposed_amount: co.proposed_amount,
                        original_amount: co.original_amount,
                        message: co.message,
                        car_summary: co.car_summary,
                        part_description: co.part_description
                    }));

                    // Show notification badge or auto-open modal
                    showToast(`ðŸ’° You have ${pendingCounterOffers.length} pending counter-offer(s)!`, 'info');

                    // Auto-open first pending one
                    setTimeout(() => {
                        const first = pendingCounterOffers[0];
                        openCounterRespondModal(
                            first.counter_offer_id,
                            parseFloat(first.original_amount),
                            parseFloat(first.proposed_amount),
                            first.message
                        );
                    }, 1000);
                }
            } catch (err) {
                console.error('Failed to load pending counter-offers:', err);
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/orders/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await res.json();

                const statusFlow = ['confirmed', 'preparing', 'ready_for_pickup', 'in_transit', 'delivered'];
                const statusLabels = {
                    confirmed: 'Confirmed',
                    preparing: 'Preparing',
                    ready_for_pickup: 'Ready',
                    in_transit: 'In Transit',
                    delivered: 'Delivered',
                    completed: 'Completed',
                    disputed: 'Disputed',
                    refunded: 'Refunded'
                };

                const html = orders.length ? orders.map(o => {
                    const currentIdx = statusFlow.indexOf(o.order_status);
                    const nextStatus = currentIdx >= 0 && currentIdx < statusFlow.length - 1 ? statusFlow[currentIdx + 1] : null;
                    const isCancelled = o.order_status.includes('cancelled');
                    const isDisputed = o.order_status === 'disputed';
                    const isRefunded = o.order_status === 'refunded';
                    const canUpdate = nextStatus && !isCancelled && !isDisputed && !isRefunded && o.order_status !== 'completed';
                    const statusLabel = isCancelled ? 'Cancelled' : (statusLabels[o.order_status] || o.order_status);
                    const statusClass = isCancelled ? 'cancelled' : (isDisputed ? 'disputed' : (isRefunded ? 'refunded' : o.order_status.replace('_', '-')));

                    // Determine action buttons based on status
                    let actionsHtml = '';
                    if (isDisputed) {
                        // Disputed orders - show Review Dispute button
                        actionsHtml = `
                            <div class="order-actions">
                                <button class="btn-status dispute" onclick="reviewDisputeForOrder('${o.order_id}')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    <i class="bi bi-exclamation-triangle"></i> Review Dispute
                                </button>
                            </div>
                        `;
                    } else if (canUpdate && !isCancelled) {
                        // Normal flow - show Cancel and Update buttons
                        actionsHtml = `
                            <div class="order-actions">
                                <button class="btn-cancel" onclick="openCancelOrderModal('${o.order_id}')" title="Cancel this order">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                                <button class="btn-status next" onclick="updateOrderStatus('${o.order_id}', '${nextStatus}')">
                                    Mark as ${statusLabels[nextStatus]}
                                </button>
                            </div>
                        `;
                    } else if (isRefunded) {
                        // Refunded orders - info only
                        actionsHtml = `<div class="order-actions"><span style="color: var(--danger);"><i class="bi bi-arrow-return-left"></i> Refunded to customer</span></div>`;
                    }

                    return `
                        <div class="order-card ${isCancelled ? 'cancelled' : ''} ${isDisputed ? 'disputed' : ''}">
                            ${isCancelled ? '<div class="cancelled-overlay"></div>' : ''}
                            <div class="order-header">
                                <div class="order-number">Order #${o.order_number || o.order_id.slice(0, 8)}</div>
                                <span class="order-status ${statusClass}">${statusLabel}</span>
                            </div>
                            <div style="color: var(--text-secondary);">
                                ${o.car_make} ${o.car_model} - ${o.part_description}<br>
                                <strong>${o.part_price} QAR</strong>
                            </div>
                            ${actionsHtml}
                        </div>
                    `;
                }).join('') : '<div class="empty-state"><i class="bi bi-box-seam"></i><h4>No orders yet</h4><p>When customers accept your bids, orders will appear here</p></div>';

                document.getElementById('ordersList').innerHTML = html;
            } catch (err) {
                console.error('Failed to load orders:', err);
            }
        }

        // Dismiss Request (hide rejected/expired from dashboard)
        function dismissRequest(reqId) {
            if (!dismissedRequests.includes(reqId)) {
                dismissedRequests.push(reqId);
                localStorage.setItem('dismissedRequests', JSON.stringify(dismissedRequests));
                renderRequests();
                updateBadge();
                showToast('Request dismissed', 'success');
            }
        }

        // Update Bid Modal - fetch existing bid data and open modal
        let currentEditBidId = null;
        async function openUpdateBidModal(bidId, title) {
            currentEditBidId = bidId;

            // Find bid info from our loaded bids
            try {
                const res = await fetch(`${API_URL}/bids/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bids = await res.json();
                const bid = bids.find(b => b.bid_id === bidId);

                if (bid) {
                    // Pre-fill modal with existing values
                    document.getElementById('bidRequestId').value = bid.request_id;
                    document.getElementById('bidRequestInfo').textContent = `Updating bid for: ${title}`;
                    document.getElementById('bidAmount').value = bid.bid_amount;
                    document.getElementById('bidCondition').value = bid.part_condition;
                    document.getElementById('bidWarranty').value = bid.warranty_days;
                    document.getElementById('bidNotes').value = bid.notes || '';

                    // Update button text
                    const submitBtn = document.querySelector('#bidForm button[type="submit"]');
                    submitBtn.innerHTML = '<i class="bi bi-pencil"></i> Update Bid';

                    document.getElementById('bidModal').classList.add('active');
                } else {
                    showToast('Bid not found', 'error');
                }
            } catch (err) {
                showToast('Failed to load bid data', 'error');
            }
        }

        // Cancel Order Logic
        let cancelOrderId = '';
        function openCancelOrderModal(id) {
            cancelOrderId = id;
            document.getElementById('cancelModal').classList.add('active');
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('active');
            cancelOrderId = '';
        }

        async function confirmCancelOrder() {
            const reason = document.getElementById('cancelReason').value;
            try {
                const res = await fetch(`${API_URL}/cancellations/orders/${cancelOrderId}/cancel/garage`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason_code: 'stock_out', reason_text: reason })
                });
                const data = await res.json();

                if (res.ok) {
                    showToast('Order cancelled successfully', 'success');
                    closeCancelModal();
                    loadOrders();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to cancel order', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        async function loadProfile() {
            try {
                const res = await fetch(`${API_URL}/dashboard/garage/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const profile = await res.json();

                document.getElementById('profileContent').innerHTML = `
                    <div class="stat-card" style="max-width: 600px;">
                        <h3 style="margin-bottom: 20px;">${profile.garage_name || 'Your Garage'}</h3>
                        <div style="display: grid; gap: 12px; font-size: 15px;">
                            <div><strong>Rating:</strong> ${profile.rating_average || 'N/A'} â­ (${profile.rating_count || 0} reviews)</div>
                            <div><strong>Transactions:</strong> ${profile.total_transactions || 0}</div>
                            <div><strong>Subscription:</strong> ${profile.plan_name || 'Free Trial'}</div>
                            <div><strong>Commission Rate:</strong> ${profile.commission_rate ? (profile.commission_rate * 100) + '%' : '15%'}</div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load profile:', err);
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const res = await fetch(`${API_URL}/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ order_status: newStatus })
                });
                const data = await res.json();

                if (res.ok) {
                    showToast('Order status updated!', 'success');
                    loadOrders();
                } else {
                    showToast(data.error || 'Failed to update', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        function switchSection(section) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');

            // Refresh data based on section
            if (section === 'requests') loadRequests();
            if (section === 'bids') loadBids();
            if (section === 'orders') loadOrders();
            if (section === 'dashboard') { loadStats(); loadRequests(); }
        }

        // Ignore/Skip request
        function ignoreRequest(reqId) {
            if (!ignoredRequests.includes(reqId)) {
                ignoredRequests.push(reqId);
                localStorage.setItem('ignoredRequests', JSON.stringify(ignoredRequests));
                renderRequests();
                showToast('Request skipped', 'success');
            }
        }

        function openBidModal(reqId, info) {
            document.getElementById('bidRequestId').value = reqId;
            document.getElementById('bidRequestInfo').textContent = info;
            bidPhotos = [];
            renderBidPhotos();
            document.getElementById('bidModal').classList.add('active');

            // Setup photo upload handler
            const MAX_PHOTOS = 10;
            const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

            document.getElementById('bidPhotoInput').onchange = (e) => {
                const files = Array.from(e.target.files);
                let addedCount = 0;
                let skippedSize = 0;

                files.forEach(file => {
                    if (bidPhotos.length < MAX_PHOTOS) {
                        if (file.size > MAX_FILE_SIZE) {
                            skippedSize++;
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            bidPhotos.push({ file, preview: e.target.result });
                            renderBidPhotos();
                            updatePhotoCounter();
                        };
                        reader.readAsDataURL(file);
                        addedCount++;
                    }
                });

                // Friendly feedback
                const remaining = MAX_PHOTOS - bidPhotos.length;
                if (remaining <= 0 && files.length > addedCount) {
                    showToast(`ðŸ“¸ Maximum ${MAX_PHOTOS} photos allowed. Extra photos were not added.`, 'info');
                }
                if (skippedSize > 0) {
                    showToast(`âš ï¸ ${skippedSize} file(s) exceeded 5MB limit and were skipped.`, 'warning');
                }
            };

            updatePhotoCounter();
        }

        function updatePhotoCounter() {
            const counter = document.getElementById('photoCounter');
            if (counter) {
                counter.textContent = `${bidPhotos.length} / 10 photos`;
            }
        }

        function closeBidModal() {
            document.getElementById('bidModal').classList.remove('active');
            document.getElementById('bidForm').reset();
            bidPhotos = [];
            renderBidPhotos();
            // Reset edit mode
            currentEditBidId = null;
            const submitBtn = document.querySelector('#bidForm button[type="submit"]');
            submitBtn.innerHTML = '<i class="bi bi-send"></i> Submit Bid';
        }

        function renderBidPhotos() {
            const grid = document.getElementById('bidPhotoGrid');
            grid.innerHTML = bidPhotos.map((img, i) => `
                <div class="bid-photo-item">
                    <img src="${img.preview}" alt="Part photo">
                    <button type="button" class="bid-photo-remove" onclick="removeBidPhoto(${i})">&times;</button>
                </div>
            `).join('');
        }

        function removeBidPhoto(index) {
            bidPhotos.splice(index, 1);
            renderBidPhotos();
        }

        document.getElementById('bidForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const reqId = document.getElementById('bidRequestId').value;
            const amount = document.getElementById('bidAmount').value;
            const condition = document.getElementById('bidCondition').value;
            const warranty = document.getElementById('bidWarranty').value;
            const notes = document.getElementById('bidNotes').value;

            try {
                let res, data;

                if (currentEditBidId) {
                    // UPDATE existing bid (PUT request, JSON body)
                    res = await fetch(`${API_URL}/bids/${currentEditBidId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            bid_amount: amount,
                            part_condition: condition,
                            warranty_days: warranty,
                            notes: notes
                        })
                    });
                    data = await res.json();

                    if (res.ok) {
                        showToast('Bid updated successfully!', 'success');
                        currentEditBidId = null; // Reset edit mode
                        closeBidModal();
                        loadBids();
                        renderRequests();
                    } else {
                        showToast(data.error || 'Failed to update bid', 'error');
                    }
                } else {
                    // NEW bid (POST request, FormData for file uploads)
                    const formData = new FormData();
                    formData.append('request_id', reqId);
                    formData.append('bid_amount', amount);
                    formData.append('part_condition', condition);
                    formData.append('warranty_days', warranty);
                    formData.append('notes', notes);

                    // Append photos
                    bidPhotos.forEach(photo => {
                        formData.append('images', photo.file);
                    });

                    res = await fetch(`${API_URL}/bids`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    data = await res.json();

                    if (data.bid_id) {
                        showToast('Bid submitted successfully!', 'success');
                        // Track this request as bidded and update UI
                        if (!biddedRequests.includes(reqId)) {
                            biddedRequests.push(reqId);
                        }
                        closeBidModal();
                        renderRequests(); // Update UI immediately
                        loadBids();
                        loadStats();
                    } else {
                        showToast(data.error || 'Failed to submit bid', 'error');
                    }
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        function updateBadge() {
            // Count only visible requests (exclude dismissed, ignored, and ones we've bid on)
            const visibleCount = requests.filter(r =>
                !dismissedRequests.includes(r.request_id) &&
                !ignoredRequests.includes(r.request_id) &&
                !bidStatusMap[r.request_id]
            ).length;
            document.getElementById('requestBadge').textContent = visibleCount;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // ===== COUNTER-OFFER RESPOND =====
        let currentCounterOfferId = null;
        let currentCounterBidId = null;

        function openCounterRespondModal(counterOfferId, originalBid, customerOffer, message) {
            currentCounterOfferId = counterOfferId;

            document.getElementById('respondYourBid').textContent = originalBid.toFixed(2) + ' QAR';
            document.getElementById('respondCustomerOffer').textContent = customerOffer.toFixed(2) + ' QAR';

            const msgDiv = document.getElementById('respondCustomerMessage');
            if (message) {
                msgDiv.textContent = `"${message}"`;
                msgDiv.style.display = 'block';
            } else {
                msgDiv.style.display = 'none';
            }

            // Reset counter input
            document.getElementById('counterInputSection').classList.remove('active');
            document.getElementById('garageCounterAmount').value = '';

            document.getElementById('counterRespondModal').classList.add('active');
        }

        function closeCounterRespondModal() {
            document.getElementById('counterRespondModal').classList.remove('active');
            currentCounterOfferId = null;
        }

        function showCounterInput() {
            document.getElementById('counterInputSection').classList.add('active');
        }

        async function respondToCounter(action) {
            if (!currentCounterOfferId) return;

            let body = { action };

            if (action === 'counter') {
                const amount = parseFloat(document.getElementById('garageCounterAmount').value);
                if (!amount || amount <= 0) {
                    showToast('Please enter a valid counter amount', 'error');
                    return;
                }
                body.counter_amount = amount;
            }

            try {
                const res = await fetch(`${API_URL}/negotiations/counter-offers/${currentCounterOfferId}/garage-respond`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (res.ok) {
                    if (action === 'accept') {
                        showToast('âœ… Counter-offer accepted! Bid updated.', 'success');
                    } else if (action === 'reject') {
                        showToast('Counter-offer declined', 'success');
                    } else {
                        showToast(`ðŸ”„ Counter-offer sent! (Round ${data.round})`, 'success');
                    }
                    closeCounterRespondModal();
                    loadBids();
                    // Remove from pending list
                    pendingCounterOffers = pendingCounterOffers.filter(co => co.counter_offer_id !== currentCounterOfferId);
                } else {
                    showToast(data.error || 'Failed to respond', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Check for pending counter-offers in bid list
        function checkPendingCounterOffers() {
            if (pendingCounterOffers.length > 0) {
                const latest = pendingCounterOffers[0];
                openCounterRespondModal(
                    latest.counter_offer_id,
                    parseFloat(latest.original_amount),
                    parseFloat(latest.proposed_amount),
                    latest.message
                );
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'exclamation-triangle'}"></i> ${message}`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
    <!-- Cancel Confirmation Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <div
                    style="width: 60px; height: 60px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 24px; color: var(--danger);"></i>
                </div>
                <h3 style="margin-bottom: 8px;">Cancel Order?</h3>
                <p style="color: var(--text-secondary);">This will process a full refund to the customer. This action
                    cannot be undone.</p>
            </div>

            <div class="form-group" style="text-align: left;">
                <label>Reason for cancellation</label>
                <textarea class="form-control" id="cancelReason" rows="2"
                    placeholder="e.g. Out of stock, Damaged part..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeCancelModal()"
                    style="border: 1px solid var(--border-color); background: transparent; color: var(--text-primary);">Keep
                    Order</button>
                <button class="btn-cancel" onclick="confirmCancelOrder()"
                    style="background: var(--danger); color: white;">Yes, Cancel Order</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Lightbox Modal -->
    <div id="proLightbox" class="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <div class="lightbox-toolbar">
            <button onclick="zoomBox(0.2)"><i class="bi bi-zoom-in"></i></button>
            <button onclick="zoomBox(-0.2)"><i class="bi bi-zoom-out"></i></button>
            <button onclick="resetZoom()"><i class="bi bi-arrows-fullscreen"></i></button>
        </div>
        <div class="lightbox-content" id="lightboxContent">
            <img id="lightboxImg" src="" alt="Full view" draggable="false">
        </div>
        <button class="lightbox-nav prev" id="lightboxPrev" onclick="changeSlide(-1)"><i
                class="bi bi-chevron-left"></i></button>
        <button class="lightbox-nav next" id="lightboxNext" onclick="changeSlide(1)"><i
                class="bi bi-chevron-right"></i></button>
        <div class="lightbox-can-drag-hint">Drag to pan â€¢ Scroll to zoom</div>
    </div>

    <script>
        // Lightbox Logic
        let currentLightboxImages = [];
        let currentLightboxIndex = 0;
        let currentScale = 1;
        let pannedX = 0;
        let pannedY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;

        function openLightbox(images, index) {
            currentLightboxImages = images;
            currentLightboxIndex = index;
            document.getElementById('proLightbox').classList.add('active');
            updateLightboxImage();

            // Add event listeners for drag/zoom
            const container = document.getElementById('lightboxContent');
            container.addEventListener('mousedown', startDrag);
            container.addEventListener('mousemove', drag);
            container.addEventListener('mouseup', endDrag);
            container.addEventListener('mouseleave', endDrag);
            container.addEventListener('wheel', handleWheel, { passive: false });
        }

        function closeLightbox() {
            document.getElementById('proLightbox').classList.remove('active');
            // Remove listeners
            const container = document.getElementById('lightboxContent');
            container.removeEventListener('mousedown', startDrag);
            container.removeEventListener('mousemove', drag);
            container.removeEventListener('mouseup', endDrag);
            container.removeEventListener('mouseleave', endDrag);
            container.removeEventListener('wheel', handleWheel);
        }

        function updateLightboxImage() {
            const img = document.getElementById('lightboxImg');

            // Fix URL format if needed (handle uploads/ vs /uploads/)
            let url = currentLightboxImages[currentLightboxIndex];
            if (url && !url.startsWith('http') && !url.startsWith('/')) {
                url = '/' + url;
            }

            img.src = url;
            resetZoom();

            // Nav buttons
            document.getElementById('lightboxPrev').style.display = currentLightboxIndex > 0 ? 'flex' : 'none';
            document.getElementById('lightboxNext').style.display = currentLightboxIndex < currentLightboxImages.length - 1 ? 'flex' : 'none';
        }

        function changeSlide(dir) {
            currentLightboxIndex += dir;
            if (currentLightboxIndex < 0) currentLightboxIndex = 0;
            if (currentLightboxIndex >= currentLightboxImages.length) currentLightboxIndex = currentLightboxImages.length - 1;
            updateLightboxImage();
        }

        function updateTransform() {
            const img = document.getElementById('lightboxImg');
            img.style.transform = `translate(${pannedX}px, ${pannedY}px) scale(${currentScale})`;
        }

        function zoomBox(amount) {
            currentScale += amount;
            if (currentScale < 0.5) currentScale = 0.5;
            if (currentScale > 5) currentScale = 5;
            updateTransform();
        }

        function resetZoom() {
            currentScale = 1;
            pannedX = 0;
            pannedY = 0;
            updateTransform();
        }

        function startDrag(e) {
            if (currentScale <= 1) return; // Only drag if zoomed
            isDragging = true;
            startX = e.clientX - pannedX;
            startY = e.clientY - pannedY;
            document.getElementById('lightboxContent').style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            pannedX = e.clientX - startX;
            pannedY = e.clientY - startY;
            updateTransform();
        }

        function endDrag() {
            isDragging = false;
            document.getElementById('lightboxContent').style.cursor = 'grab';
        }

        function handleWheel(e) {
            e.preventDefault();
            if (e.deltaY < 0) zoomBox(0.2);
            else zoomBox(-0.2);
        }

        // ===== DISPUTE MODAL =====
        let currentDisputeId = null;

        const REASON_LABELS = {
            wrong_part: 'Wrong Part Sent',
            doesnt_fit: "Doesn't Fit Car",
            damaged: 'Damaged in Transit',
            not_as_described: 'Not as Described',
            changed_mind: 'Changed Mind'
        };

        function openDisputeModal(data) {
            currentDisputeId = data.dispute_id;
            document.getElementById('disputeOrderNumber').textContent = 'Order #' + (data.order_number || 'N/A');
            document.getElementById('disputeReason').textContent = REASON_LABELS[data.reason] || data.reason;
            document.getElementById('disputeRefundAmount').textContent = (data.refund_amount || 0) + ' QAR';
            document.getElementById('disputeRestockingFee').textContent = (data.restocking_fee || 0) + ' QAR';
            document.getElementById('contestInputSection').style.display = 'none';
            document.getElementById('contestReason').value = '';

            // Show description if available
            const descEl = document.getElementById('disputeDescription');
            if (data.description) {
                descEl.textContent = '"' + data.description + '"';
                descEl.style.display = 'block';
            } else {
                descEl.style.display = 'none';
            }

            // Show photos if available
            const photosEl = document.getElementById('disputePhotos');
            if (data.photo_urls && data.photo_urls.length > 0) {
                photosEl.innerHTML = data.photo_urls.map(url => `
                    <img src="${url.startsWith('/') ? url : '/' + url}" 
                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                         onclick="window.open('${url.startsWith('/') ? url : '/' + url}', '_blank')">
                `).join('');
            } else {
                photosEl.innerHTML = '';
            }

            document.getElementById('disputeRespondModal').classList.add('active');
        }

        function closeDisputeModal() {
            document.getElementById('disputeRespondModal').classList.remove('active');
            currentDisputeId = null;
        }

        function showContestInput() {
            document.getElementById('contestInputSection').style.display = 'block';
        }

        async function respondToDispute(action) {
            if (!currentDisputeId) return;

            const contestReason = document.getElementById('contestReason').value;

            if (action === 'contest' && !contestReason.trim()) {
                showToast('Please explain why you contest this dispute', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/disputes/${currentDisputeId}/garage-respond`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        response_message: contestReason
                    })
                });
                const data = await res.json();

                if (res.ok) {
                    showToast(data.message, 'success');
                    removeFromDisputeQueue(currentDisputeId);
                    closeDisputeModal();
                    loadOrders();
                } else {
                    showToast(data.error || 'Failed to respond', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Load pending disputes on page load (queue-based approach)
        async function loadPendingDisputes() {
            try {
                const res = await fetch(`${API_URL}/disputes/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.disputes && data.disputes.length > 0) {
                    pendingDisputes = data.disputes.filter(d => d.status === 'pending');
                    updateDisputeBadge();
                    if (pendingDisputes.length > 0) {
                        showToast(`âš ï¸ ${pendingDisputes.length} pending dispute(s) - check Orders section`, 'warning');
                    }
                }
            } catch (err) {
                console.error('Failed to load disputes:', err);
            }
        }

        // Update dispute badge counter
        function updateDisputeBadge() {
            const badge = document.getElementById('disputeBadge');
            if (badge) {
                badge.textContent = pendingDisputes.length;
                badge.style.display = pendingDisputes.length > 0 ? 'flex' : 'none';
            }
        }

        // Review next pending dispute from queue
        function reviewNextDispute() {
            if (pendingDisputes.length === 0) {
                showToast('No pending disputes', 'info');
                return;
            }
            const next = pendingDisputes[0];
            openDisputeModal(next);
        }

        // Remove dispute from queue after handling
        function removeFromDisputeQueue(disputeId) {
            pendingDisputes = pendingDisputes.filter(d => d.dispute_id !== disputeId);
            updateDisputeBadge();
        }

        // Review dispute from order card (fetches dispute data by order_id)
        async function reviewDisputeForOrder(orderId) {
            // First check if we have it in pending queue
            const cached = pendingDisputes.find(d => d.order_id === orderId);
            if (cached) {
                openDisputeModal(cached);
                return;
            }

            // Otherwise fetch from API
            try {
                const res = await fetch(`${API_URL}/disputes/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.disputes) {
                    const dispute = data.disputes.find(d => d.order_id === orderId);
                    if (dispute) {
                        openDisputeModal(dispute);
                    } else {
                        showToast('Dispute not found', 'error');
                    }
                }
            } catch (err) {
                showToast('Failed to load dispute', 'error');
            }
        }
    </script>
</body>

</html>
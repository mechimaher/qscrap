<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QScrap Operations Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Leaflet Maps for Delivery Tracking -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ===== Layout ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 24px;
            overflow-y: auto;
        }

        /* ===== Sidebar ===== */
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .sidebar-logo .logo-text {
            font-size: 18px;
            font-weight: 700;
        }

        .sidebar-logo .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-menu {
            padding: 16px 12px;
            flex: 1;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            margin-bottom: 4px;
            text-decoration: none;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white;
        }

        .nav-item i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ===== Header ===== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 800;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 20px;
            font-size: 13px;
            color: var(--success);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* ===== Stats Grid ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border: none;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.blue {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .stat-icon.yellow {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .stat-icon.red {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-card.highlight .stat-label {
            color: rgba(255, 255, 255, 0.8);
        }

        /* ===== Content Sections ===== */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .content-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .content-title {
            font-size: 16px;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 8px 12px;
        }

        .search-box input {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            width: 200px;
        }

        .search-box i {
            color: var(--text-muted);
        }

        /* ===== Table ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* ===== Status Badges ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.confirmed {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .status-badge.preparing {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status-badge.ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-badge.in-transit {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .status-badge.delivered {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .status-badge.completed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status-badge.contested {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .status-badge.refunded {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .status-badge.disputed {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status-badge.resolved {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        /* ===== Buttons ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-logout {
            width: 100%;
            justify-content: center;
            margin-top: 12px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* ===== Tabs ===== */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--bg-secondary);
        }

        /* ===== Filters ===== */
        .filters-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        /* ===== Login Screen ===== */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .login-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 16px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-muted);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ===== Toast ===== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== Empty State ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h4 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        /* ===== Order Detail Modal ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 18px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .info-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
        }

        .info-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .info-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .info-card-icon.customer {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .info-card-icon.garage {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .info-card-title {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .info-card-name {
            font-size: 16px;
            font-weight: 600;
        }

        .info-card-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .part-details-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .part-vehicle {
            font-size: 18px;
            font-weight: 600;
        }

        .part-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--success);
        }

        .part-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .part-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .part-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .part-meta-item i {
            color: var(--accent);
        }

        .image-gallery {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-top: 12px;
        }

        .gallery-img {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .gallery-img:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }

        /* Timeline */
        .order-timeline {
            position: relative;
            padding-left: 28px;
        }

        .order-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 16px;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: -24px;
            top: 4px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 3px solid var(--border);
        }

        .timeline-item.active .timeline-dot {
            background: var(--success);
            border-color: var(--success);
        }

        .timeline-item.current .timeline-dot {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }

        .timeline-status {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .timeline-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Dispute Section */
        .dispute-card {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 16px;
        }

        .dispute-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .dispute-reason {
            font-size: 16px;
            font-weight: 600;
            color: var(--danger);
        }

        .dispute-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .dispute-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">üè≠</div>
                <h1 class="login-title">Operations Center</h1>
                <p class="login-subtitle">QScrap Internal Dashboard</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email / Phone</label>
                    <input type="text" class="form-control" id="loginEmail" placeholder="Enter your credentials"
                        required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-login">
                    <i class="bi bi-box-arrow-in-right"></i> Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="app" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon">üè≠</div>
                    <div>
                        <div class="logo-text">QScrap</div>
                        <div class="logo-subtitle">Operations</div>
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <a class="nav-item active" data-section="overview">
                        <i class="bi bi-grid-1x2-fill"></i>
                        Overview
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a class="nav-item" data-section="orders">
                        <i class="bi bi-box-seam-fill"></i>
                        Orders
                        <span class="nav-badge" id="ordersBadge" style="display: none;">0</span>
                    </a>
                    <a class="nav-item" data-section="disputes">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Disputes
                        <span class="nav-badge" id="disputesBadge" style="display: none;">0</span>
                    </a>
                    <a class="nav-item" data-section="delivery">
                        <i class="bi bi-truck"></i>
                        Delivery
                    </a>
                    <a class="nav-item" data-section="quality">
                        <i class="bi bi-patch-check-fill"></i>
                        Quality
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a class="nav-item" data-section="users">
                        <i class="bi bi-people-fill"></i>
                        Users
                    </a>
                    <a class="nav-item" data-section="finance">
                        <i class="bi bi-cash-stack"></i>
                        Finance
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">O</div>
                    <div>
                        <div class="user-name" id="userName">Operations</div>
                        <div class="user-role">Manager</div>
                    </div>
                </div>
                <button class="btn btn-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <section class="section active" id="sectionOverview">
                <div class="page-header">
                    <h1 class="page-title">Live Overview</h1>
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        Real-time
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-header">
                            <div class="stat-icon" style="background: rgba(255,255,255,0.2); color: white;">
                                <i class="bi bi-box-seam"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="statActiveOrders">0</div>
                        <div class="stat-label">Active Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon yellow"><i class="bi bi-exclamation-triangle"></i></div>
                        </div>
                        <div class="stat-value" id="statPendingDisputes">0</div>
                        <div class="stat-label">Pending Disputes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue"><i class="bi bi-truck"></i></div>
                        </div>
                        <div class="stat-value" id="statInTransit">0</div>
                        <div class="stat-label">In Transit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green"><i class="bi bi-currency-dollar"></i></div>
                        </div>
                        <div class="stat-value" id="statRevenueToday">0 QAR</div>
                        <div class="stat-label">Revenue Today</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green"><i class="bi bi-check-circle"></i></div>
                        </div>
                        <div class="stat-value" id="statReadyPickup">0</div>
                        <div class="stat-label">Ready for Pickup</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon red"><i class="bi bi-hourglass-split"></i></div>
                        </div>
                        <div class="stat-value" id="statContestedDisputes">0</div>
                        <div class="stat-label">Contested Disputes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue"><i class="bi bi-people"></i></div>
                        </div>
                        <div class="stat-value" id="statTotalCustomers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green"><i class="bi bi-shop"></i></div>
                        </div>
                        <div class="stat-value" id="statTotalGarages">0</div>
                        <div class="stat-label">Total Garages</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="content-card">
                    <div class="content-header">
                        <h3 class="content-title">Recent Orders</h3>
                        <button class="btn btn-ghost btn-sm" onclick="switchSection('orders')">View All</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Part</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                            <tr>
                                <td colspan="6" class="empty-state"><i class="bi bi-inbox"></i>
                                    <h4>Loading...</h4>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Orders Section -->
            <section class="section" id="sectionOrders">
                <div class="page-header">
                    <h1 class="page-title">Order Management</h1>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" placeholder="Search orders..." id="orderSearch" onkeyup="searchOrders()">
                    </div>
                </div>

                <div class="tabs" id="orderTabs">
                    <div class="tab active" data-status="all">All</div>
                    <div class="tab" data-status="confirmed">Confirmed</div>
                    <div class="tab" data-status="preparing">Preparing</div>
                    <div class="tab" data-status="in_transit">In Transit</div>
                    <div class="tab" data-status="delivered">Delivered</div>
                </div>

                <div class="content-card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Garage</th>
                                <th>Part</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Disputes Section -->
            <section class="section" id="sectionDisputes">
                <div class="page-header">
                    <h1 class="page-title">Dispute Center</h1>
                </div>

                <div class="tabs" id="disputeTabs">
                    <div class="tab active" data-status="pending">Pending</div>
                    <div class="tab" data-status="contested">Contested</div>
                    <div class="tab" data-status="all">All</div>
                </div>

                <div class="content-card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Refund</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disputesTable">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Delivery Section -->
            <section class="section" id="sectionDelivery">
                <div class="page-header">
                    <h1 class="page-title">Delivery Management</h1>
                    <button class="btn btn-primary" onclick="openAddDriverModal()">
                        <i class="bi bi-plus-lg"></i> Add Driver
                    </button>
                </div>

                <!-- Delivery Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="bi bi-person-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryAvailable">0</div>
                            <div class="stat-label">Available Drivers</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="bi bi-person-workspace"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryBusy">0</div>
                            <div class="stat-label">Busy Drivers</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryPending">0</div>
                            <div class="stat-label">Pending Pickup</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="bi bi-truck"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryInTransit">0</div>
                            <div class="stat-label">In Transit</div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Drivers List -->
                    <div class="content-card">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="bi bi-people"></i>
                            Drivers</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Vehicle</th>
                                    <th>Status</th>
                                    <th>Deliveries</th>
                                </tr>
                            </thead>
                            <tbody id="driversTable">
                                <tr>
                                    <td colspan="4" class="empty-state">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Orders Ready for Pickup -->
                    <div class="content-card">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="bi bi-box-arrow-up"></i>
                            Ready for Pickup</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Part</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="deliveryOrdersTable">
                                <tr>
                                    <td colspan="4" class="empty-state">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Delivery Section -->
            <section class="section" id="sectionDelivery">
                <div class="page-header">
                    <h1 class="page-title">Delivery Management</h1>
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        Live Tracking
                    </div>
                </div>

                <!-- Delivery Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            <i class="bi bi-truck"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryInTransit">0</div>
                            <div class="stat-label">In Transit</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="bi bi-person-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryAvailableDrivers">0</div>
                            <div class="stat-label">Available Drivers</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryPendingPickup">0</div>
                            <div class="stat-label">Pending Pickup</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="bi bi-check2-all"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="deliveryDeliveredToday">0</div>
                            <div class="stat-label">Delivered Today</div>
                        </div>
                    </div>
                </div>

                <!-- Live Delivery Map -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="bi bi-geo-alt"></i> Live Delivery Map</h3>
                        <button class="btn btn-sm" onclick="loadActiveDeliveries()"
                            style="padding: 6px 12px; font-size: 12px;">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div id="deliveryMapContainer"
                        style="height: 400px; border-radius: 8px; overflow: hidden; background: var(--bg-tertiary);">
                    </div>
                </div>

                <!-- Active Deliveries List -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="bi bi-list-ul"></i> Active Deliveries</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Driver</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activeDeliveriesTable">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <i class="bi bi-truck"></i>
                                        <p>No active deliveries</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Quality Section -->
            <section class="section" id="sectionQuality">
                <div class="page-header">
                    <h1 class="page-title">Quality Control</h1>
                </div>

                <!-- QC Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="qcPendingInspection">0</div>
                            <div class="stat-label">Pending Inspection</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="qcPassedToday">0</div>
                            <div class="stat-label">Passed Today</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="bi bi-x-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="qcFailedToday">0</div>
                            <div class="stat-label">Failed Today</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="bi bi-percent"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="qcPassRate">--%</div>
                            <div class="stat-label">Pass Rate (7d)</div>
                        </div>
                    </div>
                </div>

                <!-- Pending Inspections -->
                <div class="content-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="bi bi-clipboard-check"></i>
                        Pending Quality Inspections</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Part</th>
                                <th>Garage</th>
                                <th>Status</th>
                                <th>Since</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="qcPendingTable">
                        </tbody>
                    </table>
                </div>

                <!-- Recent Inspections -->
                <div class="content-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="bi bi-clock-history"></i>
                        Recent Inspections</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Part</th>
                                <th>Result</th>
                                <th>Inspector</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="qcRecentTable">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section class="section" id="sectionUsers">
                <div class="page-header">
                    <h1 class="page-title">User Management</h1>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" placeholder="Search users..." id="userSearch">
                    </div>
                </div>

                <div class="tabs" id="userTabs">
                    <div class="tab active" data-type="customer">Customers</div>
                    <div class="tab" data-type="garage">Garages</div>
                </div>

                <div class="content-card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Orders</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Finance Section -->
            <section class="section" id="sectionFinance">
                <div class="page-header">
                    <h1 class="page-title">Financial Overview</h1>
                    <div class="tabs" id="periodTabs">
                        <div class="tab active" data-period="7d">7 Days</div>
                        <div class="tab" data-period="30d">30 Days</div>
                        <div class="tab" data-period="90d">90 Days</div>
                    </div>
                </div>

                <!-- Revenue Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="analyticsTotalRevenue">0 QAR</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="bi bi-receipt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="analyticsNetRevenue">0 QAR</div>
                            <div class="stat-label">Net Revenue</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="analyticsTotalOrders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="analyticsCompleted">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>
                </div>

                <!-- Top Garages & Top Parts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div class="content-card">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="bi bi-trophy"></i> Top
                            Garages</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Garage</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="topGaragesTable">
                                <tr>
                                    <td colspan="3" class="empty-state">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="content-card">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="bi bi-gear"></i> Top
                            Parts Requested</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Part Description</th>
                                    <th>Requests</th>
                                </tr>
                            </thead>
                            <tbody id="topPartsTable">
                                <tr>
                                    <td colspan="2" class="empty-state">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Disputes Summary -->
                <div class="content-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i
                            class="bi bi-exclamation-triangle"></i> Dispute Summary</h3>
                    <div style="display: flex; gap: 30px;">
                        <div><strong>Total Disputes:</strong> <span id="analyticsDisputesTotal">0</span></div>
                        <div><strong>Pending:</strong> <span id="analyticsDisputesPending">0</span></div>
                        <div><strong>Resolved:</strong> <span id="analyticsDisputesResolved">0</span></div>
                        <div><strong>Refunds Approved:</strong> <span id="analyticsRefundsApproved">0</span></div>
                        <div><strong>Refunds Denied:</strong> <span id="analyticsRefundsDenied">0</span></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2><i class="bi bi-box-seam"></i> Order <span id="modalOrderNumber">#12345</span></h2>
                <button class="modal-close" onclick="closeOrderModal()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Customer & Garage Info -->
                <div class="modal-section">
                    <div class="modal-section-title"><i class="bi bi-people"></i> Parties</div>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon customer"><i class="bi bi-person-fill"></i></div>
                                <div>
                                    <div class="info-card-title">Customer</div>
                                    <div class="info-card-name" id="modalCustomerName">---</div>
                                </div>
                            </div>
                            <div class="info-card-detail"><i class="bi bi-telephone"></i> <span
                                    id="modalCustomerPhone">---</span></div>
                            <div class="info-card-detail"><i class="bi bi-envelope"></i> <span
                                    id="modalCustomerEmail">---</span></div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon garage"><i class="bi bi-shop"></i></div>
                                <div>
                                    <div class="info-card-title">Garage</div>
                                    <div class="info-card-name" id="modalGarageName">---</div>
                                </div>
                            </div>
                            <div class="info-card-detail"><i class="bi bi-telephone"></i> <span
                                    id="modalGaragePhone">---</span></div>
                            <div class="info-card-detail"><i class="bi bi-geo-alt"></i> <span
                                    id="modalGarageAddress">---</span></div>
                        </div>
                    </div>
                </div>

                <!-- Part Details -->
                <div class="modal-section">
                    <div class="modal-section-title"><i class="bi bi-gear"></i> Part Details</div>
                    <div class="part-details-card">
                        <div class="part-header">
                            <div>
                                <div class="part-vehicle" id="modalVehicle">---</div>
                                <span class="status-badge" id="modalStatusBadge">---</span>
                            </div>
                            <div class="part-price" id="modalPrice">0 QAR</div>
                        </div>
                        <div class="part-description" id="modalPartDesc">---</div>
                        <div class="part-meta">
                            <div class="part-meta-item"><i class="bi bi-award"></i> <span id="modalCondition">---</span>
                            </div>
                            <div class="part-meta-item"><i class="bi bi-shield-check"></i> <span
                                    id="modalWarranty">---</span> days warranty</div>
                            <div class="part-meta-item"><i class="bi bi-upc-scan"></i> VIN: <span
                                    id="modalVin">---</span></div>
                        </div>
                        <div class="image-gallery" id="modalImages"></div>
                    </div>
                </div>

                <!-- Order Timeline -->
                <div class="modal-section">
                    <div class="modal-section-title"><i class="bi bi-clock-history"></i> Order Timeline</div>
                    <div class="order-timeline" id="modalTimeline">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>

                <!-- Dispute Section (conditional) -->
                <div class="modal-section" id="modalDisputeSection" style="display: none;">
                    <div class="modal-section-title"><i class="bi bi-exclamation-triangle"></i> Dispute</div>
                    <div class="dispute-card">
                        <div class="dispute-header">
                            <div class="dispute-reason" id="modalDisputeReason">---</div>
                            <span class="status-badge" id="modalDisputeStatus">---</span>
                        </div>
                        <div class="dispute-description" id="modalDisputeDesc">---</div>
                        <div class="part-meta" style="margin-top: 12px;">
                            <div class="part-meta-item"><i class="bi bi-cash"></i> Refund: <strong
                                    id="modalRefundAmount">0 QAR</strong></div>
                        </div>
                        <div class="dispute-actions" id="modalDisputeActions">
                            <button class="btn btn-success" id="btnApproveRefund"><i class="bi bi-check-lg"></i> Approve
                                Refund</button>
                            <button class="btn btn-danger" id="btnDenyRefund"><i class="bi bi-x-lg"></i> Deny
                                Refund</button>
                        </div>
                    </div>
                </div>

                <!-- Bid Notes -->
                <div class="modal-section" id="modalNotesSection" style="display: none;">
                    <div class="modal-section-title"><i class="bi bi-chat-text"></i> Seller Notes</div>
                    <div class="info-card">
                        <p id="modalBidNotes" style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                            ---</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeOrderModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        const API_URL = '/api';
        let token = localStorage.getItem('opsToken');
        let socket = null;
        let currentOrderStatus = 'all';
        let currentDisputeStatus = 'pending';
        let currentUserType = 'customer';

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: email, password })
                });
                const data = await res.json();

                if (res.ok && data.token) {
                    token = data.token;
                    localStorage.setItem('opsToken', token);
                    showDashboard();
                } else {
                    showToast(data.error || 'Login failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        // Check auth on load
        if (token) {
            showDashboard();
        }

        async function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';

            // Connect socket
            socket = io();
            socket.emit('join_user_room', 'operations');

            // Socket listeners
            socket.on('order_status_updated', () => { loadStats(); loadOrders(); });
            socket.on('dispute_created', () => { loadStats(); loadDisputes(); });
            socket.on('new_order', () => { loadStats(); loadOrders(); });

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchSection(item.dataset.section));
            });

            // Order tabs
            document.querySelectorAll('#orderTabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#orderTabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentOrderStatus = tab.dataset.status;
                    loadOrders();
                });
            });

            // Dispute tabs
            document.querySelectorAll('#disputeTabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#disputeTabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentDisputeStatus = tab.dataset.status;
                    loadDisputes();
                });
            });

            // User tabs
            document.querySelectorAll('#userTabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#userTabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentUserType = tab.dataset.type;
                    loadUsers();
                });
            });

            // Load initial data
            await loadStats();
            await loadOrders();
        }

        function switchSection(section) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');

            // Load section data
            if (section === 'orders') loadOrders();
            if (section === 'disputes') loadDisputes();
            if (section === 'users') loadUsers();
            if (section === 'finance') loadAnalytics();
            if (section === 'quality') loadQualityStats();
            if (section === 'delivery') loadDeliveryData();
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/operations/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.stats) {
                    const s = data.stats;
                    document.getElementById('statActiveOrders').textContent = s.active_orders;
                    document.getElementById('statPendingDisputes').textContent = s.pending_disputes;
                    document.getElementById('statContestedDisputes').textContent = s.contested_disputes;
                    document.getElementById('statInTransit').textContent = s.in_transit;
                    document.getElementById('statRevenueToday').textContent = Math.round(s.revenue_today) + ' QAR';
                    document.getElementById('statReadyPickup').textContent = s.ready_for_pickup;
                    document.getElementById('statTotalCustomers').textContent = s.total_customers;
                    document.getElementById('statTotalGarages').textContent = s.total_garages;

                    // Update badges
                    updateBadge('disputesBadge', parseInt(s.pending_disputes) + parseInt(s.contested_disputes));
                    updateBadge('ordersBadge', s.active_orders);
                }
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        function updateBadge(id, count) {
            const badge = document.getElementById(id);
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-flex' : 'none';
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/operations/orders?status=${currentOrderStatus}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const statusLabels = {
                    confirmed: 'Confirmed',
                    preparing: 'Preparing',
                    ready_for_pickup: 'Ready',
                    in_transit: 'In Transit',
                    delivered: 'Delivered',
                    completed: 'Completed',
                    disputed: 'Disputed',
                    refunded: 'Refunded'
                };

                const statusClass = {
                    confirmed: 'confirmed',
                    preparing: 'preparing',
                    ready_for_pickup: 'ready',
                    in_transit: 'in-transit',
                    delivered: 'delivered',
                    completed: 'completed',
                    disputed: 'pending',
                    refunded: 'refunded'
                };

                if (data.orders && data.orders.length) {
                    // Orders table
                    document.getElementById('ordersTable').innerHTML = data.orders.map(o => `
                        <tr>
                            <td><strong>#${o.order_number || o.order_id.slice(0, 8)}</strong></td>
                            <td>${o.customer_name}<br><small style="color: var(--text-muted);">${o.customer_phone}</small></td>
                            <td>${o.garage_name}</td>
                            <td>${o.car_make} ${o.car_model}<br><small style="color: var(--text-muted);">${o.part_description?.slice(0, 30)}...</small></td>
                            <td><span class="status-badge ${statusClass[o.order_status] || ''}">${statusLabels[o.order_status] || o.order_status}</span></td>
                            <td><strong>${o.total_amount} QAR</strong></td>
                            <td><button class="btn btn-ghost btn-sm" onclick="viewOrder('${o.order_id}')"><i class="bi bi-eye"></i></button></td>
                        </tr>
                    `).join('');

                    // Recent orders on overview
                    document.getElementById('recentOrdersTable').innerHTML = data.orders.slice(0, 5).map(o => `
                        <tr>
                            <td><strong>#${o.order_number || o.order_id.slice(0, 8)}</strong></td>
                            <td>${o.customer_name}</td>
                            <td>${o.part_description?.slice(0, 25)}...</td>
                            <td><span class="status-badge ${statusClass[o.order_status] || ''}">${statusLabels[o.order_status] || o.order_status}</span></td>
                            <td>${o.total_amount} QAR</td>
                            <td><button class="btn btn-ghost btn-sm" onclick="viewOrder('${o.order_id}')"><i class="bi bi-eye"></i></button></td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('ordersTable').innerHTML = '<tr><td colspan="7" class="empty-state"><i class="bi bi-inbox"></i><h4>No orders found</h4></td></tr>';
                }
            } catch (err) {
                console.error('Failed to load orders:', err);
            }
        }

        async function loadDisputes() {
            try {
                const res = await fetch(`${API_URL}/operations/disputes?status=${currentDisputeStatus}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const reasonLabels = {
                    wrong_part: 'Wrong Part',
                    doesnt_fit: "Doesn't Fit",
                    damaged: 'Damaged',
                    not_as_described: 'Not as Described',
                    changed_mind: 'Changed Mind'
                };

                if (data.disputes && data.disputes.length) {
                    document.getElementById('disputesTable').innerHTML = data.disputes.map(d => {
                        // Determine action column based on status
                        let actionCol = '';
                        if (d.status === 'pending' || d.status === 'contested') {
                            actionCol = `
                                <button class="btn btn-success btn-sm" id="approveBtn-${d.dispute_id}" onclick="resolveDispute('${d.dispute_id}', 'refund_approved')">
                                    <i class="bi bi-check-lg"></i> Approve
                                </button>
                                <button class="btn btn-danger btn-sm" id="denyBtn-${d.dispute_id}" onclick="resolveDispute('${d.dispute_id}', 'refund_denied')" style="margin-left: 5px;">
                                    <i class="bi bi-x-lg"></i> Deny
                                </button>
                            `;
                        } else if (d.status === 'resolved') {
                            const resolutionBadge = d.resolution === 'refund_approved'
                                ? '<span class="status-badge completed"><i class="bi bi-check-circle"></i> Refund Approved</span>'
                                : '<span class="status-badge cancelled"><i class="bi bi-x-circle"></i> Refund Denied</span>';
                            actionCol = resolutionBadge;
                        } else {
                            actionCol = `<span class="status-badge ${d.status}">${d.status}</span>`;
                        }

                        return `
                            <tr id="dispute-row-${d.dispute_id}">
                                <td><strong>#${d.order_number}</strong></td>
                                <td>${d.customer_name}<br><small style="color: var(--text-muted);">${d.customer_phone}</small></td>
                                <td>${reasonLabels[d.reason] || d.reason}</td>
                                <td><span class="status-badge ${d.status}">${d.status}</span></td>
                                <td><strong>${d.refund_amount} QAR</strong></td>
                                <td>${actionCol}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('disputesTable').innerHTML = '<tr><td colspan="6" class="empty-state"><i class="bi bi-check-circle"></i><h4>No disputes</h4></td></tr>';
                }
            } catch (err) {
                console.error('Failed to load disputes:', err);
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/operations/users?type=${currentUserType}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.users && data.users.length) {
                    document.getElementById('usersTable').innerHTML = data.users.map(u => {
                        const userId = currentUserType === 'garage' ? u.garage_id : u.user_id;
                        const name = currentUserType === 'garage' ? u.garage_name : u.full_name;
                        const contact = u.phone || u.phone_number || u.email || 'N/A';
                        return `
                            <tr>
                                <td><strong>${name}</strong></td>
                                <td>${contact}</td>
                                <td>${u.total_orders || 0} orders</td>
                                <td>${new Date(u.created_at || u.user_created).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-ghost btn-sm" onclick="viewUser('${userId}', '${currentUserType}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('usersTable').innerHTML = '<tr><td colspan="5" class="empty-state"><i class="bi bi-people"></i><h4>No users found</h4></td></tr>';
                }
            } catch (err) {
                console.error('Failed to load users:', err);
            }
        }

        // View User Detail Modal
        async function viewUser(userId, userType) {
            try {
                const res = await fetch(`${API_URL}/operations/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (!res.ok) {
                    showToast(data.error || 'Failed to load user', 'error');
                    return;
                }

                const u = data.user;
                const isGarage = u.user_type === 'garage' || u.garage_name;
                const name = isGarage ? u.garage_name : u.full_name;
                const contact = u.phone || u.phone_number || 'N/A';
                const email = u.email || 'N/A';
                const suspended = u.is_suspended ? '<span class="status-badge cancelled">Suspended</span>' : '<span class="status-badge completed">Active</span>';

                // Build orders table
                let ordersHtml = '<p style="color: var(--text-muted);">No orders</p>';
                if (data.orders && data.orders.length) {
                    ordersHtml = data.orders.map(o => `
                        <div style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <strong>#${o.order_number}</strong> - ${o.part_description?.slice(0, 30)}...
                            <span class="status-badge ${o.order_status}" style="margin-left: 10px;">${o.order_status}</span>
                        </div>
                    `).join('');
                }

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'userDetailModal';
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal-container" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2><i class="bi bi-person"></i> ${name}</h2>
                            <button class="modal-close" onclick="document.getElementById('userDetailModal').remove()"><i class="bi bi-x-lg"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="info-card" style="margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <p style="color: var(--text-muted); margin-bottom: 5px;">Type</p>
                                        <p style="font-weight: 500;">${isGarage ? 'Garage' : 'Customer'}</p>
                                    </div>
                                    <div>
                                        <p style="color: var(--text-muted); margin-bottom: 5px;">Status</p>
                                        <p>${suspended}</p>
                                    </div>
                                    <div>
                                        <p style="color: var(--text-muted); margin-bottom: 5px;">Phone</p>
                                        <p style="font-weight: 500;">${contact}</p>
                                    </div>
                                    <div>
                                        <p style="color: var(--text-muted); margin-bottom: 5px;">Email</p>
                                        <p style="font-weight: 500;">${email}</p>
                                    </div>
                                    ${isGarage ? `
                                        <div>
                                            <p style="color: var(--text-muted); margin-bottom: 5px;">Address</p>
                                            <p style="font-weight: 500;">${u.address || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p style="color: var(--text-muted); margin-bottom: 5px;">Rating</p>
                                            <p style="font-weight: 500;">‚≠ê ${u.rating_average || 0} (${u.rating_count || 0})</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <h4 style="margin-bottom: 10px;"><i class="bi bi-box-seam"></i> Recent Orders</h4>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                                ${ordersHtml}
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid var(--border-color);">
                            ${u.is_suspended
                        ? `<button class="btn btn-success" onclick="activateUser('${userId}')"><i class="bi bi-check-circle"></i> Activate</button>`
                        : `<button class="btn btn-danger" onclick="suspendUser('${userId}')"><i class="bi bi-slash-circle"></i> Suspend</button>`
                    }
                            <button class="btn btn-ghost" onclick="document.getElementById('userDetailModal').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (err) {
                console.error('viewUser Error:', err);
                showToast('Connection error', 'error');
            }
        }

        async function suspendUser(userId) {
            const reason = prompt('Suspension reason (optional):');
            try {
                const res = await fetch(`${API_URL}/operations/users/${userId}/suspend`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason || 'Suspended by operations team' })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message || 'User suspended', 'success');
                    document.getElementById('userDetailModal')?.remove();
                    loadUsers();
                } else {
                    showToast(data.error || 'Failed to suspend user', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        async function activateUser(userId) {
            try {
                const res = await fetch(`${API_URL}/operations/users/${userId}/activate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message || 'User activated', 'success');
                    document.getElementById('userDetailModal')?.remove();
                    loadUsers();
                } else {
                    showToast(data.error || 'Failed to activate user', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }


        let currentAnalyticsPeriod = '7d';

        async function loadAnalytics() {
            try {
                const res = await fetch(`${API_URL}/operations/analytics?period=${currentAnalyticsPeriod}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                // Update stats
                document.getElementById('analyticsTotalRevenue').textContent = parseFloat(data.orders.total_revenue || 0).toLocaleString() + ' QAR';
                document.getElementById('analyticsNetRevenue').textContent = parseFloat(data.orders.net_revenue || 0).toLocaleString() + ' QAR';
                document.getElementById('analyticsTotalOrders').textContent = data.orders.total_orders || 0;
                document.getElementById('analyticsCompleted').textContent = data.orders.completed || 0;

                // Update disputes
                document.getElementById('analyticsDisputesTotal').textContent = data.disputes.total_disputes || 0;
                document.getElementById('analyticsDisputesPending').textContent = data.disputes.pending || 0;
                document.getElementById('analyticsDisputesResolved').textContent = data.disputes.resolved || 0;
                document.getElementById('analyticsRefundsApproved').textContent = data.disputes.refunds_approved || 0;
                document.getElementById('analyticsRefundsDenied').textContent = data.disputes.refunds_denied || 0;

                // Top garages table
                if (data.top_garages && data.top_garages.length) {
                    document.getElementById('topGaragesTable').innerHTML = data.top_garages.map(g => `
                        <tr>
                            <td><strong>${g.garage_name}</strong></td>
                            <td>${g.order_count}</td>
                            <td>${parseFloat(g.total_revenue || 0).toLocaleString()} QAR</td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('topGaragesTable').innerHTML = '<tr><td colspan="3" class="empty-state">No data</td></tr>';
                }

                // Top parts table
                if (data.top_parts && data.top_parts.length) {
                    document.getElementById('topPartsTable').innerHTML = data.top_parts.map(p => `
                        <tr>
                            <td>${p.part_description}</td>
                            <td>${p.request_count}</td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('topPartsTable').innerHTML = '<tr><td colspan="2" class="empty-state">No data</td></tr>';
                }
            } catch (err) {
                console.error('Failed to load analytics:', err);
            }
        }

        // Period tabs for Finance section
        document.getElementById('periodTabs')?.addEventListener('click', e => {
            if (e.target.classList.contains('tab')) {
                document.querySelectorAll('#periodTabs .tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentAnalyticsPeriod = e.target.dataset.period;
                loadAnalytics();
            }
        });

        // Delivery Management Functions
        let availableDrivers = [];

        async function loadDeliveryData() {
            try {
                // Load stats
                const statsRes = await fetch(`${API_URL}/delivery/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statsData = await statsRes.json();

                document.getElementById('deliveryAvailable').textContent = statsData.stats?.available_drivers || 0;
                document.getElementById('deliveryBusy').textContent = statsData.stats?.busy_drivers || 0;
                document.getElementById('deliveryPending').textContent = statsData.stats?.pending_pickup || 0;
                document.getElementById('deliveryInTransit').textContent = statsData.stats?.in_transit || 0;

                // Load drivers
                const driversRes = await fetch(`${API_URL}/delivery/drivers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const driversData = await driversRes.json();
                availableDrivers = (driversData.drivers || []).filter(d => d.status === 'available');

                if (driversData.drivers && driversData.drivers.length) {
                    document.getElementById('driversTable').innerHTML = driversData.drivers.map(d => `
                        <tr>
                            <td><strong>${d.full_name}</strong><br><small style="color: var(--text-muted);">${d.phone}</small></td>
                            <td>${d.vehicle_type} - ${d.vehicle_plate || 'N/A'}</td>
                            <td><span class="status-badge ${d.status}">${d.status}</span></td>
                            <td>${d.total_deliveries}</td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('driversTable').innerHTML = '<tr><td colspan="4" class="empty-state">No drivers. Click "Add Driver" to create one.</td></tr>';
                }

                // Load orders for delivery
                const ordersRes = await fetch(`${API_URL}/delivery/orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const ordersData = await ordersRes.json();

                if (ordersData.orders && ordersData.orders.length) {
                    document.getElementById('deliveryOrdersTable').innerHTML = ordersData.orders.map(o => {
                        const statusLabel = o.driver_name ? `Assigned to ${o.driver_name}` : o.order_status;
                        const actionBtn = o.driver_name
                            ? `<span class="status-badge in_transit">Assigned</span>`
                            : `<button class="btn btn-primary btn-sm" onclick="openAssignDriverModal('${o.order_id}', '${o.order_number}')"><i class="bi bi-person-plus"></i> Assign</button>`;
                        return `
                            <tr>
                                <td><strong>#${o.order_number}</strong></td>
                                <td>${o.part_description}</td>
                                <td><span class="status-badge ${o.order_status}">${statusLabel}</span></td>
                                <td>${actionBtn}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('deliveryOrdersTable').innerHTML = '<tr><td colspan="4" class="empty-state">No orders ready for pickup</td></tr>';
                }
            } catch (err) {
                console.error('Failed to load delivery data:', err);
            }
        }

        function openAddDriverModal() {
            const modal = document.createElement('div');
            modal.id = 'addDriverModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-container" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2><i class="bi bi-person-plus"></i> Add Driver</h2>
                        <button class="modal-close" onclick="document.getElementById('addDriverModal').remove()"><i class="bi bi-x-lg"></i></button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Full Name *</label>
                            <input type="text" id="driverName" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);" required>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Phone *</label>
                            <input type="text" id="driverPhone" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);" required>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Vehicle Type</label>
                            <select id="driverVehicle" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                                <option value="motorcycle">Motorcycle</option>
                                <option value="car">Car</option>
                                <option value="van">Van</option>
                                <option value="truck">Truck</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Vehicle Plate</label>
                            <input type="text" id="driverPlate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-ghost" onclick="document.getElementById('addDriverModal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitAddDriver()"><i class="bi bi-check-lg"></i> Add Driver</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitAddDriver() {
            const name = document.getElementById('driverName').value.trim();
            const phone = document.getElementById('driverPhone').value.trim();
            const vehicle = document.getElementById('driverVehicle').value;
            const plate = document.getElementById('driverPlate').value.trim();

            if (!name || !phone) {
                showToast('Name and phone are required', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/delivery/drivers`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: name, phone, vehicle_type: vehicle, vehicle_plate: plate })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message || 'Driver added!', 'success');
                    document.getElementById('addDriverModal').remove();
                    loadDeliveryData();
                } else {
                    showToast(data.error || 'Failed to add driver', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        function openAssignDriverModal(orderId, orderNumber) {
            if (availableDrivers.length === 0) {
                showToast('No available drivers. Add or free up a driver first.', 'error');
                return;
            }

            const driverOptions = availableDrivers.map(d =>
                `<option value="${d.driver_id}">${d.full_name} (${d.vehicle_type})</option>`
            ).join('');

            const modal = document.createElement('div');
            modal.id = 'assignDriverModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-container" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2><i class="bi bi-person-check"></i> Assign Driver</h2>
                        <button class="modal-close" onclick="document.getElementById('assignDriverModal').remove()"><i class="bi bi-x-lg"></i></button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px;">Assign a driver to order <strong>#${orderNumber}</strong></p>
                        <select id="selectedDriver" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                            ${driverOptions}
                        </select>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-ghost" onclick="document.getElementById('assignDriverModal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitAssignDriver('${orderId}')"><i class="bi bi-check-lg"></i> Assign</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitAssignDriver(orderId) {
            const driverId = document.getElementById('selectedDriver').value;
            try {
                const res = await fetch(`${API_URL}/delivery/assign/${orderId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ driver_id: driverId })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message || 'Driver assigned!', 'success');
                    document.getElementById('assignDriverModal').remove();
                    loadDeliveryData();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to assign driver', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }


        async function loadQualityStats() {
            try {
                // Load stats
                const statsRes = await fetch(`${API_URL}/quality/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statsData = await statsRes.json();

                document.getElementById('qcPendingInspection').textContent = statsData.stats?.pending_inspection || 0;
                document.getElementById('qcPassedToday').textContent = statsData.stats?.passed_today || 0;
                document.getElementById('qcFailedToday').textContent = statsData.stats?.failed_today || 0;
                document.getElementById('qcPassRate').textContent = (statsData.stats?.pass_rate || 0) + '%';

                // Load pending inspections
                const pendingRes = await fetch(`${API_URL}/quality/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const pendingData = await pendingRes.json();

                if (pendingData.orders && pendingData.orders.length) {
                    document.getElementById('qcPendingTable').innerHTML = pendingData.orders.map(o => `
                        <tr>
                            <td><strong>#${o.order_number || o.order_id.slice(0, 8)}</strong></td>
                            <td>${o.part_description}</td>
                            <td>${o.garage_name}</td>
                            <td><span class="status-badge preparing">Awaiting QC</span></td>
                            <td>${new Date(o.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="openInspection('${o.order_id}', '${o.order_number}', '${o.part_description.replace(/'/g, "\\'")}', '${o.garage_name}')">
                                    <i class="bi bi-clipboard-check"></i> Inspect
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('qcPendingTable').innerHTML = '<tr><td colspan="6" class="empty-state"><i class="bi bi-check-circle"></i><h4>No pending inspections</h4></td></tr>';
                }

                // Load recent inspections
                const historyRes = await fetch(`${API_URL}/quality/history?limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const historyData = await historyRes.json();

                if (historyData.inspections && historyData.inspections.length) {
                    document.getElementById('qcRecentTable').innerHTML = historyData.inspections.map(i => `
                        <tr>
                            <td><strong>#${i.order_number}</strong></td>
                            <td>${i.part_description}</td>
                            <td><span class="status-badge ${i.status}">${i.status === 'passed' ? '‚úì Passed' : '‚úó Failed'}</span></td>
                            <td>${i.inspector_name || 'Inspector'}</td>
                            <td>${new Date(i.completed_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('qcRecentTable').innerHTML = '<tr><td colspan="5" class="empty-state">No recent inspections</td></tr>';
                }
            } catch (err) {
                console.error('Failed to load quality stats:', err);
            }
        }

        // Quality Inspection Modal Functions
        let inspectionCriteria = [];
        let currentInspectionOrder = null;

        async function openInspection(orderId, orderNumber, partDesc, garageName) {
            currentInspectionOrder = orderId;

            // Load criteria if not cached
            if (inspectionCriteria.length === 0) {
                const res = await fetch(`${API_URL}/quality/criteria`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                inspectionCriteria = data.criteria || [];
            }

            // Build checklist HTML
            const checklistHtml = inspectionCriteria.map(c => `
                <div class="checklist-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                    <input type="checkbox" id="criteria-${c.criteria_id}" data-criteria="${c.criteria_id}" style="width: 20px; height: 20px; margin-right: 12px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: var(--text-primary);">${c.name} ${c.is_required ? '<span style="color: var(--danger);">*</span>' : ''}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${c.description || ''}</div>
                    </div>
                </div>
            `).join('');

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'inspectionModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-container" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2><i class="bi bi-clipboard-check"></i> Quality Inspection</h2>
                        <button class="modal-close" onclick="closeInspectionModal()"><i class="bi bi-x-lg"></i></button>
                    </div>
                    <div class="modal-body">
                        <div class="info-card" style="margin-bottom: 20px;">
                            <p><strong>Order:</strong> #${orderNumber}</p>
                            <p><strong>Part:</strong> ${partDesc}</p>
                            <p><strong>Garage:</strong> ${garageName}</p>
                        </div>
                        
                        <h4 style="margin-bottom: 10px;"><i class="bi bi-check2-square"></i> Inspection Checklist</h4>
                        <div style="border: 1px solid var(--border-color); border-radius: 8px; max-height: 300px; overflow-y: auto;">
                            ${checklistHtml}
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                            <textarea id="inspectionNotes" rows="3" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);" placeholder="Optional inspection notes..."></textarea>
                        </div>
                        
                        <div id="failureReasonDiv" style="margin-top: 15px; display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--danger);">Failure Reason *</label>
                            <textarea id="failureReason" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--danger); background: var(--bg-tertiary); color: var(--text-primary);" placeholder="Explain why the part failed inspection..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-danger" id="failBtn" onclick="submitInspection('failed')">
                            <i class="bi bi-x-circle"></i> Fail
                        </button>
                        <button class="btn btn-success" id="passBtn" onclick="submitInspection('passed')">
                            <i class="bi bi-check-circle"></i> Pass
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeInspectionModal() {
            document.getElementById('inspectionModal')?.remove();
            currentInspectionOrder = null;
        }

        async function submitInspection(result) {
            if (!currentInspectionOrder) return;

            // Collect checklist results
            const checklistResults = inspectionCriteria.map(c => {
                const checkbox = document.getElementById(`criteria-${c.criteria_id}`);
                return {
                    criteria_id: c.criteria_id,
                    name: c.name,
                    passed: checkbox?.checked || false
                };
            });

            const notes = document.getElementById('inspectionNotes')?.value || '';
            const failureReason = document.getElementById('failureReason')?.value || '';

            // Validate failure reason if failing
            if (result === 'failed' && !failureReason.trim()) {
                document.getElementById('failureReasonDiv').style.display = 'block';
                showToast('Please provide a failure reason', 'error');
                return;
            }

            // Disable buttons
            document.getElementById('passBtn').disabled = true;
            document.getElementById('failBtn').disabled = true;

            try {
                const res = await fetch(`${API_URL}/quality/inspect/${currentInspectionOrder}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        result,
                        checklist_results: checklistResults,
                        notes,
                        failure_reason: failureReason
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    showToast(data.message || (result === 'passed' ? 'Part passed QC!' : 'Part failed QC'), 'success');
                    closeInspectionModal();
                    loadQualityStats();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to submit inspection', 'error');
                    document.getElementById('passBtn').disabled = false;
                    document.getElementById('failBtn').disabled = false;
                }
            } catch (err) {
                console.error('Submit inspection error:', err);
                showToast('Connection error', 'error');
                document.getElementById('passBtn').disabled = false;
                document.getElementById('failBtn').disabled = false;
            }
        }



        let currentModalOrderId = null;
        let currentModalDisputeId = null;

        async function viewOrder(orderId) {
            currentModalOrderId = orderId;

            try {
                const res = await fetch(`${API_URL}/operations/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to load order');
                }

                const data = await res.json();
                const order = data.order;
                const history = data.status_history || [];
                const dispute = data.dispute;

                // Populate modal header
                document.getElementById('modalOrderNumber').textContent = '#' + (order.order_number || orderId.slice(0, 8));

                // Customer info
                document.getElementById('modalCustomerName').textContent = order.customer_name || '---';
                document.getElementById('modalCustomerPhone').textContent = order.customer_phone || '---';
                document.getElementById('modalCustomerEmail').textContent = order.customer_email || '---';

                // Garage info
                document.getElementById('modalGarageName').textContent = order.garage_name || '---';
                document.getElementById('modalGaragePhone').textContent = order.garage_phone || '---';
                document.getElementById('modalGarageAddress').textContent = order.garage_address || '---';

                // Part details
                const vehicle = `${order.car_make || ''} ${order.car_model || ''} ${order.car_year || ''}`.trim();
                document.getElementById('modalVehicle').textContent = vehicle || '---';
                document.getElementById('modalPrice').textContent = (order.total_amount || 0) + ' QAR';
                document.getElementById('modalPartDesc').textContent = order.part_description || '---';
                document.getElementById('modalCondition').textContent = formatCondition(order.part_condition);
                document.getElementById('modalWarranty').textContent = order.warranty_days || 0;
                document.getElementById('modalVin').textContent = order.vin_number || 'N/A';

                // Status badge
                const statusLabels = {
                    confirmed: 'Confirmed', preparing: 'Preparing', ready_for_pickup: 'Ready',
                    in_transit: 'In Transit', delivered: 'Delivered', completed: 'Completed',
                    disputed: 'Disputed', refunded: 'Refunded', cancelled: 'Cancelled'
                };
                const statusClasses = {
                    confirmed: 'confirmed', preparing: 'preparing', ready_for_pickup: 'ready',
                    in_transit: 'in-transit', delivered: 'delivered', completed: 'completed',
                    disputed: 'pending', refunded: 'refunded', cancelled: 'refunded'
                };
                const statusBadge = document.getElementById('modalStatusBadge');
                statusBadge.textContent = statusLabels[order.order_status] || order.order_status;
                statusBadge.className = 'status-badge ' + (statusClasses[order.order_status] || '');

                // Images
                const imagesContainer = document.getElementById('modalImages');
                const allImages = [...(order.bid_photos || []), ...(order.request_images || [])];
                if (allImages.length > 0) {
                    imagesContainer.innerHTML = allImages.map(url =>
                        `<img src="${url}" class="gallery-img" onclick="window.open('${url}', '_blank')" alt="Part image">`
                    ).join('');
                } else {
                    imagesContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No images available</div>';
                }

                // Timeline
                renderTimeline(order.order_status, history);

                // Bid notes
                if (order.bid_notes) {
                    document.getElementById('modalNotesSection').style.display = 'block';
                    document.getElementById('modalBidNotes').textContent = order.bid_notes;
                } else {
                    document.getElementById('modalNotesSection').style.display = 'none';
                }

                // Dispute section
                if (dispute) {
                    currentModalDisputeId = dispute.dispute_id;
                    document.getElementById('modalDisputeSection').style.display = 'block';

                    const reasonLabels = {
                        wrong_part: 'Wrong Part', doesnt_fit: "Doesn't Fit", damaged: 'Damaged',
                        not_as_described: 'Not as Described', changed_mind: 'Changed Mind'
                    };
                    document.getElementById('modalDisputeReason').textContent = reasonLabels[dispute.reason] || dispute.reason;
                    document.getElementById('modalDisputeDesc').textContent = dispute.description || 'No description provided';
                    document.getElementById('modalRefundAmount').textContent = (dispute.refund_amount || 0) + ' QAR';

                    const disputeStatusBadge = document.getElementById('modalDisputeStatus');
                    disputeStatusBadge.textContent = dispute.status;
                    disputeStatusBadge.className = 'status-badge ' + dispute.status;

                    // Show/hide action buttons based on dispute status
                    const actionsDiv = document.getElementById('modalDisputeActions');
                    if (dispute.status === 'pending' || dispute.status === 'contested') {
                        actionsDiv.style.display = 'flex';
                        document.getElementById('btnApproveRefund').onclick = () => resolveDisputeFromModal('refund_approved');
                        document.getElementById('btnDenyRefund').onclick = () => resolveDisputeFromModal('refund_denied');
                    } else {
                        actionsDiv.style.display = 'none';
                    }
                } else {
                    document.getElementById('modalDisputeSection').style.display = 'none';
                    currentModalDisputeId = null;
                }

                // Show modal
                document.getElementById('orderModal').classList.add('active');

            } catch (err) {
                console.error('viewOrder error:', err);
                showToast(err.message || 'Failed to load order details', 'error');
            }
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            currentModalOrderId = null;
            currentModalDisputeId = null;
        }

        function formatCondition(condition) {
            const labels = { new: 'New', used_good: 'Used - Good', used_fair: 'Used - Fair', refurbished: 'Refurbished' };
            return labels[condition] || condition || '---';
        }

        function renderTimeline(currentStatus, history) {
            const timelineContainer = document.getElementById('modalTimeline');
            const statusOrder = ['confirmed', 'preparing', 'ready_for_pickup', 'in_transit', 'delivered', 'completed'];
            const statusLabels = {
                confirmed: 'Order Confirmed', preparing: 'Preparing Part', ready_for_pickup: 'Ready for Pickup',
                in_transit: 'In Transit', delivered: 'Delivered', completed: 'Completed',
                disputed: 'Disputed', refunded: 'Refunded', cancelled: 'Cancelled'
            };

            // Build history map
            const historyMap = {};
            history.forEach(h => { historyMap[h.status] = h.changed_at; });

            let html = '';
            let reachedCurrent = false;

            for (const status of statusOrder) {
                const isActive = historyMap[status];
                const isCurrent = status === currentStatus;
                if (isCurrent) reachedCurrent = true;

                const itemClass = isCurrent ? 'current' : (isActive ? 'active' : '');
                const time = historyMap[status] ? new Date(historyMap[status]).toLocaleString() : (reachedCurrent ? '' : 'Pending');

                html += `
                    <div class="timeline-item ${itemClass}">
                        <div class="timeline-dot"></div>
                        <div class="timeline-status">${statusLabels[status]}</div>
                        <div class="timeline-time">${time}</div>
                    </div>
                `;

                if (isCurrent) break; // Don't show future statuses
            }

            // Add special statuses if current
            if (['disputed', 'refunded', 'cancelled'].includes(currentStatus)) {
                const time = historyMap[currentStatus] ? new Date(historyMap[currentStatus]).toLocaleString() : '';
                html += `
                    <div class="timeline-item current">
                        <div class="timeline-dot"></div>
                        <div class="timeline-status">${statusLabels[currentStatus]}</div>
                        <div class="timeline-time">${time}</div>
                    </div>
                `;
            }

            timelineContainer.innerHTML = html;
        }

        async function resolveDisputeFromModal(resolution) {
            if (!currentModalDisputeId) {
                showToast('No dispute selected', 'error');
                return;
            }

            const confirmMsg = resolution === 'refund_approved'
                ? 'Are you sure you want to approve this refund?'
                : 'Are you sure you want to deny this refund?';

            if (!confirm(confirmMsg)) return;

            await resolveDispute(currentModalDisputeId, resolution, true); // skipConfirm since we already confirmed
            closeOrderModal();
        }


        let isResolvingDispute = false;

        async function resolveDispute(disputeId, resolution, skipConfirm = false) {
            if (isResolvingDispute) return; // Prevent double-clicks

            if (!skipConfirm) {
                const confirmMsg = resolution === 'refund_approved'
                    ? 'Are you sure you want to approve this refund?'
                    : 'Are you sure you want to deny this refund?';
                if (!confirm(confirmMsg)) return;
            }

            isResolvingDispute = true;

            // Disable buttons and show loading state
            const approveBtn = document.getElementById(`approveBtn-${disputeId}`);
            const denyBtn = document.getElementById(`denyBtn-${disputeId}`);
            const originalApproveHtml = approveBtn?.innerHTML;
            const originalDenyHtml = denyBtn?.innerHTML;

            if (approveBtn) {
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
            }
            if (denyBtn) {
                denyBtn.disabled = true;
            }

            try {
                const res = await fetch(`${API_URL}/operations/disputes/${disputeId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ resolution })
                });

                const data = await res.json();

                if (res.ok) {
                    const msg = resolution === 'refund_approved'
                        ? 'Refund approved successfully'
                        : 'Refund denied successfully';
                    showToast(msg, 'success');
                    loadDisputes(); // Reload to show updated status
                    loadStats();
                } else {
                    console.error('Resolve dispute error:', data);
                    showToast(data.error || 'Failed to resolve dispute', 'error');
                    // Re-enable buttons on error
                    if (approveBtn) {
                        approveBtn.disabled = false;
                        approveBtn.innerHTML = originalApproveHtml;
                    }
                    if (denyBtn) {
                        denyBtn.disabled = false;
                        denyBtn.innerHTML = originalDenyHtml;
                    }
                }
            } catch (err) {
                console.error('Resolve dispute network error:', err);
                showToast('Connection error. Please try again.', 'error');
                // Re-enable buttons on network error
                if (approveBtn) {
                    approveBtn.disabled = false;
                    approveBtn.innerHTML = originalApproveHtml;
                }
                if (denyBtn) {
                    denyBtn.disabled = false;
                }
            } finally {
                isResolvingDispute = false;
            }
        }

        // Search with debouncing
        let searchTimeout = null;
        function searchOrders() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadOrders();
            }, 300);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('opsToken');
            token = null;
            if (socket) socket.disconnect();
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            showToast('Logged out successfully', 'success');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'exclamation-triangle'}"></i> ${message}`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ===== DELIVERY MANAGEMENT =====
        let deliveryMap = null;
        let deliveryMarkers = {};

        async function loadActiveDeliveries() {
            try {
                const res = await fetch(`${API_URL}/delivery/active`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.deliveries && data.deliveries.length > 0) {
                    renderActiveDeliveries(data.deliveries);
                    initDeliveryMap(data.deliveries);
                } else {
                    document.getElementById('activeDeliveriesTable').innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="bi bi-truck"></i>
                                <p>No active deliveries</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (err) {
                console.error('Failed to load active deliveries:', err);
            }
        }

        function renderActiveDeliveries(deliveries) {
            const tbody = document.getElementById('activeDeliveriesTable');
            tbody.innerHTML = deliveries.map(d => `
                <tr>
                    <td>${d.order_number}</td>
                    <td>
                        <strong>${d.driver_name}</strong><br>
                        <span style="color: var(--text-muted); font-size: 12px;">${d.vehicle_type} - ${d.vehicle_plate}</span>
                    </td>
                    <td>
                        ${d.customer_name}<br>
                        <a href="tel:${d.customer_phone}" style="color: var(--accent); font-size: 12px;">${d.customer_phone}</a>
                    </td>
                    <td><span class="status-badge ${d.status}">${d.status}</span></td>
                    <td>
                        ${d.current_lat && d.current_lng ?
                    `<span style="color: var(--success);"><i class="bi bi-geo-alt-fill"></i> ${parseFloat(d.current_lat).toFixed(4)}, ${parseFloat(d.current_lng).toFixed(4)}</span>`
                    : '<span style="color: var(--text-muted);">No GPS</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="openLocationModal('${d.assignment_id}', '${d.order_number}')" 
                                style="padding: 4px 8px; font-size: 11px; background: var(--accent);">
                            <i class="bi bi-geo-alt"></i> Update GPS
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function initDeliveryMap(deliveries) {
            const container = document.getElementById('deliveryMapContainer');
            if (!container || !window.L) return;

            // Initialize map if not exists
            if (!deliveryMap) {
                deliveryMap = L.map('deliveryMapContainer').setView([25.2854, 51.5310], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18
                }).addTo(deliveryMap);
            }

            // Clear existing markers
            Object.values(deliveryMarkers).forEach(m => m.remove());
            deliveryMarkers = {};

            // Add markers for each delivery
            deliveries.forEach(d => {
                if (d.current_lat && d.current_lng) {
                    const icon = L.divIcon({
                        className: 'driver-marker',
                        html: `<div style="width: 36px; height: 36px; background: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); border: 3px solid white;">
                            <span style="font-size: 18px;">üöö</span>
                        </div>`,
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    });

                    const marker = L.marker([parseFloat(d.current_lat), parseFloat(d.current_lng)], { icon })
                        .bindPopup(`
                            <strong>${d.order_number}</strong><br>
                            Driver: ${d.driver_name}<br>
                            Part: ${d.part_description}
                        `)
                        .addTo(deliveryMap);

                    deliveryMarkers[d.assignment_id] = marker;
                }
            });

            // Fit bounds if markers exist
            const bounds = Object.values(deliveryMarkers).map(m => m.getLatLng());
            if (bounds.length > 0) {
                deliveryMap.fitBounds(bounds.map(b => [b.lat, b.lng]), { padding: [50, 50] });
            }
        }

        function openLocationModal(assignmentId, orderNumber) {
            const lat = prompt(`Enter Latitude for ${orderNumber}:`, '25.2854');
            if (!lat) return;
            const lng = prompt(`Enter Longitude for ${orderNumber}:`, '51.5310');
            if (!lng) return;
            updateDriverLocation(assignmentId, parseFloat(lat), parseFloat(lng));
        }

        async function updateDriverLocation(assignmentId, lat, lng) {
            try {
                const res = await fetch(`${API_URL}/delivery/assignment/${assignmentId}/location`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lat, lng })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('üìç Driver location updated', 'success');
                    loadActiveDeliveries(); // Refresh
                } else {
                    showToast(data.error || 'Failed to update location', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        async function loadDeliveryStats() {
            try {
                const res = await fetch(`${API_URL}/delivery/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.stats) {
                    document.getElementById('deliveryInTransit').textContent = data.stats.in_transit || 0;
                    document.getElementById('deliveryAvailableDrivers').textContent = data.stats.available_drivers || 0;
                    document.getElementById('deliveryPendingPickup').textContent = data.stats.pending_pickup || 0;
                    document.getElementById('deliveryDeliveredToday').textContent = data.stats.delivered_today || 0;
                }
            } catch (e) {
                console.error('Failed to load delivery stats:', e);
            }
        }

        // Load delivery data when section is shown
        document.querySelectorAll('.nav-item[data-section="delivery"]').forEach(el => {
            el.addEventListener('click', () => {
                loadDeliveryStats();
                loadActiveDeliveries();
            });
        });
    </script>
</body>

</html>
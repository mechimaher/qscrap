<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QScrap - Find Auto Parts in Qatar</title>
    <meta name="description"
        content="Find genuine and used auto parts from verified scrap yards across Qatar. Fast delivery, best prices.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Leaflet Maps for Driver Tracking -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* Light Theme (Default for Customer) */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --input-bg: #ffffff;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --input-bg: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Smooth theme transition */
        body,
        .app-header,
        .request-form-card,
        .request-card,
        .order-card,
        .bid-card,
        .auth-card {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== AUTH SCREEN ===== */
        .auth-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 50%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--bg-primary);
            padding: 4px;
            border-radius: var(--radius-md);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* ===== FORM ELEMENTS ===== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 16px;
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ===== APP LAYOUT ===== */
        .app {
            display: none;
        }

        .app.active {
            display: block;
        }

        .app-header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .logo-icon {
            font-size: 28px;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: var(--bg-primary);
        }

        .nav-tab.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .btn-logout {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--danger);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
        }

        /* Theme Toggle Button */
        .btn-theme {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-theme:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .theme-icon-light {
            display: block;
        }

        .theme-icon-dark {
            display: none;
        }

        [data-theme="dark"] .theme-icon-light {
            display: none;
        }

        [data-theme="dark"] .theme-icon-dark {
            display: block;
        }

        /* Notification Badge */
        .nav-tab-badge {
            position: relative;
        }

        .notification-dot {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        .notification-count {
            position: absolute;
            top: -4px;
            right: -8px;
            min-width: 18px;
            height: 18px;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* VIN Scanner Modal */
        .vin-scanner-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .vin-scanner-modal.active {
            display: flex;
        }

        .scanner-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 10;
        }

        .scanner-title {
            font-size: 18px;
            font-weight: 600;
        }

        .scanner-close {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .scanner-video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 16/9;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        #scannerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .scanner-frame {
            width: 90%;
            height: 40px;
            border: 2px dashed var(--primary);
            border-radius: 8px;
            position: relative;
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
            animation: scan-line 2s linear infinite;
        }

        @keyframes scan-line {
            0% {
                top: 0;
            }

            50% {
                top: 100%;
            }

            100% {
                top: 0;
            }
        }

        .scanner-instructions {
            color: white;
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            opacity: 0.8;
        }

        .scanner-result {
            margin-top: 20px;
            padding: 16px 24px;
            background: var(--success);
            color: white;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 18px;
            letter-spacing: 2px;
            display: none;
        }

        .scanner-result.visible {
            display: block;
            animation: result-pop 0.3s ease-out;
        }

        @keyframes result-pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .scanner-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
        }

        .scanner-btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .scanner-btn.primary {
            background: var(--primary);
            color: white;
        }

        .scanner-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* ===== REQUEST FORM ===== */
        .request-form-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--shadow-md);
        }

        .form-section {
            margin-bottom: 28px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-title i {
            color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .form-row.two {
            grid-template-columns: repeat(2, 1fr);
        }

        /* VIN Input with Camera */
        .vin-input-group {
            position: relative;
        }

        .vin-input-group .form-control {
            padding-right: 50px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
        }

        .vin-camera-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .vin-help {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Part Categories */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .category-item {
            padding: 16px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .category-item:hover {
            border-color: var(--primary-light);
        }

        .category-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .category-item i {
            font-size: 24px;
            color: var(--primary);
            display: block;
            margin-bottom: 8px;
        }

        .category-item span {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-primary);
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.02);
        }

        .image-upload-icon {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .image-upload-text {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .image-upload-hint {
            font-size: 13px;
            color: var(--text-muted);
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: var(--bg-primary);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        /* ===== REQUEST CARDS ===== */
        .request-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .request-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .request-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .request-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .request-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .request-badge.accepted {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .request-desc {
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .request-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .request-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== BIDS ===== */
        .bids-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .bids-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .bid-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .bid-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .bid-info {
            flex: 1;
            min-width: 0;
            /* Important for text overflow */
        }

        .bid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .bid-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--success);
        }

        .bid-garage {
            font-weight: 600;
            color: var(--text-primary);
        }

        .bid-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0;
            font-size: 13px;
        }

        .bid-details .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.condition-new {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge.condition-refurbished {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
        }

        .badge.condition-used_good,
        .badge.condition-used_fair {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .bid-notes {
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
            /* TEXT OVERFLOW CONTROL */
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-height: 80px;
            overflow-y: auto;
            line-height: 1.4;
        }

        [data-theme="dark"] .bid-notes {
            background: rgba(255, 255, 255, 0.05);
        }

        .bid-thumbnails {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .bid-thumbnails .thumb {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .bid-thumbnails .thumb:hover {
            border-color: var(--primary);
        }

        .bid-thumbnails .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bid-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .btn-reject {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-reject:hover {
            background: var(--danger);
            color: white;
        }

        .btn-accept {
            padding: 10px 20px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-accept:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-counter {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-counter:hover {
            background: var(--primary);
            color: white;
        }

        /* Counter-Offer Modal */
        .counter-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .counter-modal-overlay.active {
            display: flex;
        }

        .counter-modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: var(--shadow-lg);
        }

        .counter-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .counter-modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .counter-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
        }

        .counter-modal-close:hover {
            background: var(--bg-primary);
        }

        .counter-modal-body {
            padding: 24px;
        }

        .price-comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .price-comparison .original {
            text-align: left;
        }

        .price-comparison .original-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .price-comparison .original-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        .price-comparison .arrow {
            font-size: 24px;
            color: var(--primary);
        }

        .price-comparison .your-offer {
            text-align: right;
        }

        .counter-input-group {
            margin-bottom: 16px;
        }

        .counter-input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .counter-price-input {
            display: flex;
            align-items: center;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 4px;
            transition: border-color 0.2s;
        }

        .counter-price-input:focus-within {
            border-color: var(--primary);
        }

        .counter-price-input input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
            padding: 12px;
            outline: none;
        }

        .counter-price-input .currency {
            padding: 0 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .counter-message textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            resize: none;
            min-height: 80px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .negotiation-history {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .negotiation-history h4 {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .negotiation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 13px;
        }

        .negotiation-item .round-badge {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        .negotiation-item.garage .round-badge {
            background: var(--warning);
        }

        .counter-modal-actions {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .counter-modal-actions button {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel-counter {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-send-counter {
            background: var(--primary);
            border: none;
            color: white;
        }

        .btn-send-counter:hover {
            opacity: 0.9;
        }

        .rounds-remaining {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* ===== ORDERS ===== */
        .order-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 16px;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .order-number {
            font-size: 18px;
            font-weight: 700;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .order-status.confirmed {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .order-status.preparing {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .order-status.in_transit {
            background: rgba(168, 85, 247, 0.1);
            color: #8b5cf6;
        }

        .order-status.delivered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .order-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .order-timeline {
            display: flex;
            justify-content: space-between;
            margin: 24px 0;
            position: relative;
        }

        .order-timeline::before {
            content: '';
            position: absolute;
            top: 16px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
        }

        .timeline-step {
            text-align: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .timeline-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            color: white;
            font-size: 16px;
        }

        .timeline-step.completed .timeline-dot {
            background: var(--success);
        }

        .timeline-step.current .timeline-dot {
            background: var(--primary);
            animation: pulse 2s infinite;
        }

        .timeline-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .btn-confirm-delivery {
            width: 100%;
            padding: 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            color: var(--border);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: var(--text-secondary);
        }

        /* Bid Thumbnails */
        .bid-thumbnails {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .bid-thumbnails .thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            cursor: zoom-in;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .bid-thumbnails .thumb:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .bid-thumbnails .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Bid Action Buttons */
        .bid-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Negotiation Status Badges */
        .bid-negotiated-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .bid-pending-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Bid card with garage counter-offer - attention-grabbing */
        .bid-card.has-counter-offer {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.03) 0%, rgba(245, 158, 11, 0.08) 100%);
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.12);
        }

        .bid-card.has-counter-offer:hover {
            border-color: #f59e0b;
            box-shadow: 0 6px 24px rgba(245, 158, 11, 0.2);
        }

        /* Counter-offer price comparison */
        .counter-offer-prices {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .original-price {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-muted);
            text-decoration: line-through;
            opacity: 0.7;
        }

        .counter-price {
            font-size: 26px;
            font-weight: 800;
            color: #10b981;
        }

        .counter-offer-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            padding: 4px 10px;
            border-radius: 20px;
        }

        /* Counter-offer action badge */
        .counter-action-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.2) 100%);
            color: #f59e0b;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin: 12px 0;
        }

        /* Garage message in counter-offer */
        .garage-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(245, 158, 11, 0.08);
            border-left: 3px solid #f59e0b;
            border-radius: 0 10px 10px 0;
            margin: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .garage-message i {
            color: #f59e0b;
            margin-top: 2px;
        }

        /* Improved bid actions for counter-offer */
        .bid-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr;
            gap: 10px;
            margin-top: 16px;
        }

        .bid-actions-grid .btn-accept {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }


        .btn-reject {
            padding: 10px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-reject:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn-counter {
            padding: 10px 16px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            color: #f59e0b;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-counter:hover {
            background: rgba(245, 158, 11, 0.2);
        }

        .btn-accept {
            padding: 10px 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-accept:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Report Issue & Confirm Delivery Buttons */
        .btn-report-issue {
            padding: 12px 18px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            color: #f59e0b;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-report-issue:hover {
            background: rgba(245, 158, 11, 0.2);
        }

        .btn-confirm-delivery {
            padding: 12px 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-confirm-delivery:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .dispute-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: white;
            border-radius: var(--radius-md);
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ===== MODAL OVERLAY ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
        }

        /* Negotiation history item */
        .negotiation-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 4px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 6px;
            font-size: 13px;
        }

        .negotiation-item.customer {
            background: rgba(16, 185, 129, 0.1);
        }

        .negotiation-item.garage {
            background: rgba(99, 102, 241, 0.1);
        }

        .round-badge {
            width: 22px;
            height: 22px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        /* ===== IMAGE LIGHTBOX ===== */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .lightbox-overlay.active {
            display: flex;
        }

        .lightbox-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .lightbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.5);
        }

        .lightbox-title {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .lightbox-controls {
            display: flex;
            gap: 8px;
        }

        .lightbox-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .lightbox-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-btn.close {
            background: rgba(239, 68, 68, 0.3);
        }

        .lightbox-btn.close:hover {
            background: rgba(239, 68, 68, 0.5);
        }

        .lightbox-image-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            position: relative;
        }

        .lightbox-image-container:active {
            cursor: grabbing;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            user-select: none;
            -webkit-user-drag: none;
        }

        .lightbox-zoom-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .lightbox-nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.5);
        }

        .lightbox-thumb {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .lightbox-thumb.active {
            border-color: var(--primary);
            opacity: 1;
        }

        .lightbox-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Click indicator on thumbnails */
        .image-preview-item {
            cursor: pointer;
        }

        .image-preview-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            transition: background 0.2s;
        }

        .image-preview-item:hover::after {
            background: rgba(0, 0, 0, 0.1);
        }

        .image-preview-zoom-icon {
            position: absolute;
            bottom: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            pointer-events: none;
        }

        /* ===== CANCELED ITEMS STYLING ===== */
        .request-card.cancelled,
        .order-card.cancelled {
            opacity: 0.7;
            position: relative;
            border-left-color: var(--danger);
        }

        .request-card.cancelled::before,
        .order-card.cancelled::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--danger), transparent);
            animation: cancelStrike 0.5s ease-out;
        }

        @keyframes cancelStrike {
            from {
                transform: scaleX(0);
            }

            to {
                transform: scaleX(1);
            }
        }

        .request-badge.cancelled,
        .order-status.cancelled {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .cancelled-overlay {
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 10px,
                    rgba(239, 68, 68, 0.03) 10px,
                    rgba(239, 68, 68, 0.03) 20px);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Cancel buttons */
        .btn-cancel {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            color: var(--danger);
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-cancel:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
        }

        .request-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Cancel confirmation modal */
        .cancel-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2500;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .cancel-modal-overlay.active {
            display: flex;
        }

        .cancel-modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .cancel-modal-icon {
            font-size: 48px;
            color: var(--danger);
            margin-bottom: 16px;
        }

        .cancel-modal h3 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .cancel-modal p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .cancel-modal-actions {
            display: flex;
            gap: 12px;
        }

        .cancel-modal-actions button {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-keep {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .btn-confirm-cancel {
            background: var(--danger);
            border: none;
            color: white;
        }

        .btn-confirm-cancel:hover {
            background: #dc2626;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
        }

        /* ===== MOBILE ===== */
        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .form-row.two {
                grid-template-columns: 1fr;
            }

            .category-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .image-preview-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .nav-tabs {
                display: none;
            }

            .mobile-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid var(--border);
                padding: 8px 16px;
                justify-content: space-around;
                z-index: 100;
            }

            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                padding: 8px 16px;
                border: none;
                background: none;
                color: var(--text-muted);
                font-size: 11px;
                cursor: pointer;
            }

            .mobile-nav-item.active {
                color: var(--primary);
            }

            .mobile-nav-item i {
                font-size: 22px;
            }

            .main-content {
                padding-bottom: 80px;
            }
        }

        .mobile-nav {
            display: none;
        }

        .bid-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            background: var(--bg-primary);
            flex-wrap: wrap;
            gap: 12px;
        }

        .bid-info {
            flex: 1;
        }

        .bid-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .bid-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .bid-garage {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .bid-thumbnails {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            overflow-x: auto;
        }

        .thumb {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            overflow: hidden;
            cursor: zoom-in;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bid-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-reject {
            padding: 8px 16px;
            border: 1px solid var(--danger);
            color: var(--danger);
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-reject:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .btn-accept {
            padding: 8px 16px;
            border: none;
            background: var(--success);
            color: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-accept:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- IMAGE LIGHTBOX -->
    <div class="lightbox-overlay" id="lightboxOverlay">
        <div class="lightbox-container">
            <div class="lightbox-header">
                <span class="lightbox-title" id="lightboxTitle">Image 1 of 3</span>
                <div class="lightbox-controls">
                    <button class="lightbox-btn" onclick="lightboxZoom(-0.25)" title="Zoom Out">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button class="lightbox-btn" onclick="lightboxZoom(0.25)" title="Zoom In">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button class="lightbox-btn" onclick="lightboxReset()" title="Reset">
                        <i class="bi bi-arrows-angle-contract"></i>
                    </button>
                    <button class="lightbox-btn close" onclick="closeLightbox()" title="Close">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="lightbox-image-container" id="lightboxImageContainer">
                <img id="lightboxImage" class="lightbox-image" src="" alt="Preview">
                <div class="lightbox-zoom-info" id="lightboxZoomInfo">100%</div>
            </div>
            <div class="lightbox-nav" id="lightboxNav"></div>
        </div>
    </div>

    <!-- CANCEL CONFIRMATION MODAL -->
    <div class="cancel-modal-overlay" id="cancelModal">
        <div class="cancel-modal">
            <div class="cancel-modal-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <h3 id="cancelModalTitle">Cancel Request?</h3>
            <p id="cancelModalMessage">This action cannot be undone. All bids will be rejected.</p>
            <div class="cancel-modal-actions">
                <button class="btn-keep" onclick="closeCancelModal()">Keep It</button>
                <button class="btn-confirm-cancel" onclick="confirmCancel()">Yes, Cancel</button>
            </div>
        </div>
    </div>

    <!-- VIN SCANNER MODAL -->
    <div class="vin-scanner-modal" id="vinScannerModal">
        <div class="scanner-header">
            <span class="scanner-title"> Scan VIN Number</span>
            <button class="scanner-close" onclick="closeVinScanner()"></button>
        </div>

        <div class="scanner-video-container">
            <video id="scannerVideo" autoplay playsinline></video>
            <div class="scanner-overlay">
                <div class="scanner-frame">
                    <div class="scanner-line"></div>
                </div>
            </div>
        </div>

        <p class="scanner-instructions">
            Point the camera at your registration card (Istimara)<br>
            Focus on the VIN/Chassis number
        </p>

        <div class="scanner-result" id="scannerResult"></div>

        <div class="scanner-actions" id="scannerActions">
            <button class="scanner-btn secondary" onclick="captureAndScan()">
                <i class="bi bi-camera-fill"></i> Capture
            </button>
        </div>
    </div>

    <!-- COUNTER-OFFER MODAL -->
    <div class="counter-modal-overlay" id="counterOfferModal">
        <div class="counter-modal">
            <div class="counter-modal-header">
                <h3><i class="bi bi-cash-coin"></i> Make Counter-Offer</h3>
                <button class="counter-modal-close" onclick="closeCounterOfferModal()"></button>
            </div>
            <div class="counter-modal-body">
                <div class="price-comparison">
                    <div class="original">
                        <div class="original-label">Garage's Price</div>
                        <div class="original-price" id="counterOriginalPrice">0 QAR</div>
                    </div>
                    <div class="arrow"></div>
                    <div class="your-offer">
                        <div class="original-label">Your Offer</div>
                        <div class="original-price" id="counterYourPrice"
                            style="text-decoration: none; color: var(--success);">? QAR</div>
                    </div>
                </div>

                <div class="counter-input-group">
                    <label>Your Proposed Price</label>
                    <div class="counter-price-input">
                        <input type="number" id="counterAmount" placeholder="0" oninput="updateCounterPreview()">
                        <span class="currency">QAR</span>
                    </div>
                </div>

                <div class="counter-input-group counter-message">
                    <label>Message (Optional)</label>
                    <textarea id="counterMessage"
                        placeholder="e.g. I found similar parts for less, could you match this price?"></textarea>
                </div>

                <div class="negotiation-history" id="negotiationHistory" style="display: none;">
                    <h4>Negotiation History</h4>
                    <div id="negotiationHistoryList"></div>
                </div>

                <div class="rounds-remaining" id="roundsRemaining">
                    3 rounds remaining in negotiation
                </div>
            </div>
            <div class="counter-modal-actions">
                <button class="btn-cancel-counter" onclick="closeCounterOfferModal()">Cancel</button>
                <button class="btn-send-counter" onclick="sendCounterOffer()">
                    <i class="bi bi-send-fill"></i> Send Offer
                </button>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo"></div>
                <h1 class="auth-title">QScrap</h1>
                <p class="auth-subtitle">Find auto parts across Qatar</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="loginPhone" placeholder="+974 5XXX XXXX" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="Enter password"
                        required>
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>

            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="regName" placeholder="Your full name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="regPhone" placeholder="+974 5XXX XXXX" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="regPassword" placeholder="Min 6 characters"
                        required>
                </div>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <span>QScrap</span>
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-section="create"><i class="bi bi-plus-circle"></i> New
                        Request</button>
                    <button class="nav-tab nav-tab-badge" data-section="requests">
                        <i class="bi bi-list-task"></i> My Requests
                        <span class="notification-dot" id="requestsNotificationDot" style="display: none;"></span>
                    </button>
                    <button class="nav-tab nav-tab-badge" data-section="orders">
                        <i class="bi bi-box-seam"></i> Orders
                        <span class="notification-dot" id="ordersNotificationDot" style="display: none;"></span>
                    </button>
                </nav>
                <div class="header-actions">
                    <button class="btn-theme" onclick="toggleTheme()" title="Toggle theme">
                        <i class="bi bi-sun-fill theme-icon-light"></i>
                        <i class="bi bi-moon-fill theme-icon-dark"></i>
                    </button>
                    <button class="btn-logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Sign
                        Out</button>
                </div>
            </div>
        </header>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <button class="mobile-nav-item active" data-section="create">
                <i class="bi bi-plus-circle-fill"></i>
                <span>New</span>
            </button>
            <button class="mobile-nav-item" data-section="requests">
                <i class="bi bi-list-task"></i>
                <span>Requests</span>
            </button>
            <button class="mobile-nav-item" data-section="orders">
                <i class="bi bi-box-seam"></i>
                <span>Orders</span>
            </button>
        </nav>

        <main class="main-content">
            <!-- CREATE REQUEST -->
            <section class="section active" id="sectionCreate">
                <div class="page-header">
                    <h1 class="page-title">Request a Part</h1>
                    <p class="page-subtitle">Describe what you need and get quotes from verified scrap yards</p>
                </div>

                <div class="request-form-card">
                    <form id="requestForm">
                        <!-- Vehicle Info -->
                        <div class="form-section">
                            <h3 class="form-section-title"><i class="bi bi-car-front"></i> Vehicle Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Make *</label>
                                    <select class="form-control" id="carMake" required>
                                        <option value="">Select make</option>
                                        <option>Toyota</option>
                                        <option>Nissan</option>
                                        <option>Honda</option>
                                        <option>Lexus</option>
                                        <option>Land Rover</option>
                                        <option>Mercedes-Benz</option>
                                        <option>BMW</option>
                                        <option>Audi</option>
                                        <option>Porsche</option>
                                        <option>Ford</option>
                                        <option>Chevrolet</option>
                                        <option>GMC</option>
                                        <option>Hyundai</option>
                                        <option>Kia</option>
                                        <option>Mitsubishi</option>
                                        <option>Mazda</option>
                                        <option>Volkswagen</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Model *</label>
                                    <input type="text" class="form-control" id="carModel"
                                        placeholder="e.g. Camry, Patrol" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Year *</label>
                                    <input type="number" class="form-control" id="carYear" placeholder="2020" min="1990"
                                        max="2025" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">VIN / Chassis Number (17 characters)</label>
                                <div class="vin-input-group">
                                    <input type="text" class="form-control" id="vinNumber"
                                        placeholder="e.g. JTDKN3DU5A0123456" maxlength="17">
                                    <button type="button" class="vin-camera-btn" title="Scan from registration card">
                                        <i class="bi bi-camera"></i>
                                    </button>
                                </div>
                                <p class="vin-help">Find on your vehicle registration card (Istimara)</p>
                            </div>
                        </div>

                        <!-- Part Category -->
                        <div class="form-section">
                            <h3 class="form-section-title"><i class="bi bi-grid"></i> Part Category</h3>
                            <div class="category-grid" id="categoryGrid">
                                <div class="category-item" data-category="engine">
                                    <i class="bi bi-gear-wide-connected"></i>
                                    <span>Engine</span>
                                </div>
                                <div class="category-item" data-category="transmission">
                                    <i class="bi bi-box"></i>
                                    <span>Transmission</span>
                                </div>
                                <div class="category-item" data-category="body">
                                    <i class="bi bi-car-front-fill"></i>
                                    <span>Body Parts</span>
                                </div>
                                <div class="category-item" data-category="electrical">
                                    <i class="bi bi-lightning-charge"></i>
                                    <span>Electrical</span>
                                </div>
                                <div class="category-item" data-category="suspension">
                                    <i class="bi bi-arrows-expand"></i>
                                    <span>Suspension</span>
                                </div>
                                <div class="category-item" data-category="interior">
                                    <i class="bi bi-door-open"></i>
                                    <span>Interior</span>
                                </div>
                                <div class="category-item" data-category="lights">
                                    <i class="bi bi-lightbulb"></i>
                                    <span>Lights</span>
                                </div>
                                <div class="category-item" data-category="other">
                                    <i class="bi bi-three-dots"></i>
                                    <span>Other</span>
                                </div>
                            </div>
                            <input type="hidden" id="partCategory" value="">
                        </div>

                        <!-- Part Details -->
                        <div class="form-section">
                            <h3 class="form-section-title"><i class="bi bi-card-text"></i> Part Details</h3>
                            <div class="form-group">
                                <label class="form-label">Part Description *</label>
                                <textarea class="form-control" id="partDesc"
                                    placeholder="Describe the part you need in detail. Include any part numbers if known."
                                    required></textarea>
                            </div>
                            <div class="form-row two">
                                <div class="form-group">
                                    <label class="form-label">Part Number (if known)</label>
                                    <input type="text" class="form-control" id="partNumber"
                                        placeholder="OEM part number">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Condition</label>
                                    <select class="form-control" id="condition">
                                        <option value="any">Any Condition</option>
                                        <option value="used">Used (Good)</option>
                                        <option value="new">New Only</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Images -->
                        <div class="form-section">
                            <h3 class="form-section-title"><i class="bi bi-images"></i> Photos (Optional)</h3>
                            <div class="image-upload-area" id="imageUploadArea">
                                <i class="bi bi-cloud-arrow-up image-upload-icon"></i>
                                <p class="image-upload-text">Tap to upload photos</p>
                                <p class="image-upload-hint">Add photos of the part you need or damaged part</p>
                            </div>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                            <div class="image-preview-grid" id="imagePreviewGrid"></div>
                        </div>

                        <!-- Delivery -->
                        <div class="form-section">
                            <h3 class="form-section-title"><i class="bi bi-geo-alt"></i> Delivery Location</h3>
                            <div class="form-group">
                                <label class="form-label">Delivery Address *</label>
                                <input type="text" class="form-control" id="deliveryAddress"
                                    placeholder="Street, Building, Zone, Area" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send-fill"></i> Submit Request
                        </button>
                    </form>
                </div>
            </section>

            <!-- MY REQUESTS -->
            <section class="section" id="sectionRequests">
                <div class="page-header">
                    <h1 class="page-title">My Requests</h1>
                    <p class="page-subtitle">Track your part requests and incoming bids</p>
                </div>
                <div class="request-list" id="requestsList"></div>
            </section>

            <!-- ORDERS -->
            <section class="section" id="sectionOrders">
                <div class="page-header">
                    <h1 class="page-title">My Orders</h1>
                    <p class="page-subtitle">Track your orders and confirm deliveries</p>
                </div>
                <div id="ordersList"></div>
            </section>
        </main>
    </div>

    <!-- Counter-Offer Modal -->
    <div class="modal-overlay" id="counterOfferModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3> Make Counter-Offer</h3>
                <button class="modal-close" onclick="closeCounterOfferModal()"></button>
            </div>
            <div class="modal-body">
                <div
                    style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 12px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Garage Bid</div>
                        <div id="counterOriginalPrice"
                            style="font-size: 22px; font-weight: 700; color: var(--text-primary);">0 QAR</div>
                    </div>
                    <div style="display: flex; align-items: center;"><i class="bi bi-arrow-right"
                            style="font-size: 24px; color: var(--accent);"></i></div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Your Offer</div>
                        <div id="counterYourPrice" style="font-size: 22px; font-weight: 700; color: #10b981;">? QAR
                        </div>
                    </div>
                </div>

                <div id="negotiationHistory" style="display: none; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Negotiation History:
                    </div>
                    <div id="negotiationHistoryList" style="max-height: 120px; overflow-y: auto;"></div>
                </div>

                <div id="roundsRemaining"
                    style="font-size: 12px; color: var(--accent); margin-bottom: 15px; text-align: center;">
                    3 rounds remaining in negotiation
                </div>

                <div class="form-group">
                    <label>Your Counter-Offer (QAR)</label>
                    <input type="number" class="form-control" id="counterAmount" placeholder="Enter your price"
                        oninput="updateCounterPreview()" min="1" step="0.01">
                </div>

                <div class="form-group">
                    <label>Message (Optional)</label>
                    <textarea class="form-control" id="counterMessage" rows="2"
                        placeholder="e.g., I can do this price if delivery is included..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="sendCounterOffer()" style="width: 100%;">
                    <i class="bi bi-send"></i> Send Counter-Offer
                </button>
            </div>
        </div>
    </div>

    <!-- Report Issue Modal -->
    <div class="modal-overlay" id="reportIssueModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h3> Report Issue</h3>
                <button class="modal-close" onclick="closeReportIssueModal()"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>What's the issue?</label>
                    <select class="form-control" id="issueReason" onchange="updateRefundPreview()">
                        <option value="">Select a reason...</option>
                        <option value="wrong_part">Wrong Part Sent</option>
                        <option value="doesnt_fit">Doesn't Fit My Car</option>
                        <option value="damaged">Damaged in Transit</option>
                        <option value="not_as_described">Not as Described</option>
                        <option value="changed_mind">Changed My Mind</option>
                    </select>
                </div>

                <div id="refundPreview"
                    style="display: none; margin-bottom: 16px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>Expected Refund:</span>
                        <strong id="previewRefund">0 QAR</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: var(--text-secondary);">
                        <span>Restocking Fee:</span>
                        <span id="previewFee">0 QAR</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Describe the issue</label>
                    <textarea class="form-control" id="issueDescription" rows="3"
                        placeholder="Please explain what's wrong..."></textarea>
                </div>

                <div class="form-group">
                    <label>Photos (required for damage/wrong part)</label>
                    <div class="image-upload-area" onclick="document.getElementById('issuePhotos').click()"
                        style="padding: 20px; cursor: pointer;">
                        <i class="bi bi-camera" style="font-size: 24px; color: var(--text-secondary);"></i>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">Tap to add photos</p>
                    </div>
                    <input type="file" id="issuePhotos" accept="image/*" multiple style="display: none;"
                        onchange="previewIssuePhotos()">
                    <div id="issuePhotoPreview" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                    </div>
                </div>

                <div
                    style="padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; margin-bottom: 16px;">
                    <p style="font-size: 12px; color: #f59e0b; margin: 0;">
                        <i class="bi bi-info-circle"></i> Delivery fee (25 QAR) is non-refundable unless damaged in
                        transit.
                    </p>
                </div>

                <button class="btn btn-primary" onclick="submitDispute()" style="width: 100%;">
                    <i class="bi bi-send"></i> Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        const API_URL = '/api';
        let token = localStorage.getItem('token');
        let userId = localStorage.getItem('userId');
        let userType = localStorage.getItem('userType');

        // STRICT ROLE CHECK: If logged in as garage, force logout on customer dashboard
        if (token && userType && userType !== 'customer') {
            console.warn('Wrong user role for Customer Dashboard. Clearing session.');
            localStorage.clear();
            token = null;
            userId = null;
            userType = null;
        }

        let socket = null;

        // ===== THEME MANAGEMENT =====
        function initTheme() {
            const savedTheme = localStorage.getItem('customerTheme');
            // Default to light for customers
            const theme = savedTheme || 'light';
            setTheme(theme);
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem('customerTheme', theme);
        }

        function toggleTheme() {
            const isDark = document.documentElement.hasAttribute('data-theme');
            setTheme(isDark ? 'light' : 'dark');
        }

        // Initialize theme immediately
        initTheme();

        // ===== NOTIFICATION SYSTEM =====
        let notificationSound = null;

        function initNotificationSound() {
            // Create a simple beep sound using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            notificationSound = () => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            };
        }

        function playNotificationSound() {
            if (notificationSound) {
                try { notificationSound(); } catch (e) { }
            }
        }

        function showNotificationBadge(type) {
            const dotId = type === 'requests' ? 'requestsNotificationDot' : 'ordersNotificationDot';
            const dot = document.getElementById(dotId);
            if (dot) dot.style.display = 'block';
        }

        function clearNotificationBadge(type) {
            const dotId = type === 'requests' ? 'requestsNotificationDot' : 'ordersNotificationDot';
            const dot = document.getElementById(dotId);
            if (dot) dot.style.display = 'none';
        }

        // ===== VIN SCANNER =====
        let scannerStream = null;
        let scannerWorker = null;

        async function openVinScanner() {
            const modal = document.getElementById('vinScannerModal');
            const video = document.getElementById('scannerVideo');

            try {
                // Request camera access
                scannerStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = scannerStream;
                modal.classList.add('active');

                // Initialize Tesseract worker
                if (!scannerWorker) {
                    showToast('Loading OCR engine...', 'info');
                    scannerWorker = await Tesseract.createWorker('eng');
                    await scannerWorker.setParameters({
                        tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789'
                    });
                }
            } catch (err) {
                showToast('Camera access denied. Please allow camera access.', 'error');
                console.error('Camera error:', err);
            }
        }

        function closeVinScanner() {
            const modal = document.getElementById('vinScannerModal');
            modal.classList.remove('active');

            // Stop camera
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }

            // Reset result
            document.getElementById('scannerResult').classList.remove('visible');
            document.getElementById('scannerResult').textContent = '';
        }

        async function captureAndScan() {
            const video = document.getElementById('scannerVideo');
            const resultDiv = document.getElementById('scannerResult');

            // Create canvas to capture frame
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            showToast('Scanning for VIN...', 'info');

            try {
                const { data: { text } } = await scannerWorker.recognize(canvas);

                // Extract VIN pattern (17 alphanumeric, no I, O, Q)
                const vinRegex = /[A-HJ-NPR-Z0-9]{17}/g;
                const matches = text.match(vinRegex);

                if (matches && matches.length > 0) {
                    const vin = matches[0];
                    resultDiv.textContent = vin;
                    resultDiv.classList.add('visible');

                    // Update input field
                    document.getElementById('vinNumber').value = vin;

                    playNotificationSound();
                    showToast('VIN detected! ', 'success');

                    // Close after a moment
                    setTimeout(() => closeVinScanner(), 1500);
                } else {
                    showToast('No VIN found. Try focusing on the VIN area.', 'warning');
                }
            } catch (err) {
                showToast('Scan failed. Please try again.', 'error');
                console.error('OCR error:', err);
            }
        }
        let selectedCategory = '';
        let uploadedImages = [];

        // Check auth
        if (token && localStorage.getItem('userType') === 'customer') {
            showApp();
        }

        // Auth tabs
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1));
            });
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: document.getElementById('loginPhone').value,
                        password: document.getElementById('loginPassword').value
                    })
                });
                const data = await res.json();
                if (data.token && data.userType === 'customer') {
                    saveAuth(data);
                    showApp();
                } else if (data.token) {
                    showToast('Please use the Garage Portal', 'error');
                } else {
                    showToast(data.error || 'Login failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: document.getElementById('regName').value,
                        phone_number: document.getElementById('regPhone').value,
                        password: document.getElementById('regPassword').value,
                        user_type: 'customer'
                    })
                });
                const data = await res.json();
                if (data.userId) {
                    showToast('Account created! Please sign in.', 'success');
                    switchAuthTab('login');
                } else {
                    showToast(data.error || 'Registration failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        function saveAuth(data) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('userId', data.userId);
            localStorage.setItem('userType', data.userType);
            token = data.token;
            userId = data.userId;
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        async function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');

            // Initialize notification sound
            initNotificationSound();

            socket = io();
            socket.emit('join_user_room', userId);

            socket.on('new_bid', (data) => {
                playNotificationSound();
                showNotificationBadge('requests');
                showToast(' ' + data.notification, 'success');
                loadRequests();
            });

            // Request expired notification
            socket.on('request_expired', (data) => {
                showToast(data.notification, 'warning');
                loadRequests();
            });

            // Counter offer expired notification
            socket.on('counter_offer_expired', (data) => {
                showToast(data.notification, 'warning');
                loadRequests();
            });

            // NEW: Handle bid updates from garages
            socket.on('bid_updated', (data) => {
                playNotificationSound();
                showNotificationBadge('requests');
                showToast(' A garage updated their bid!', 'info');
                loadRequests();
            });

            // Handle bid withdrawal by garage
            socket.on('bid_withdrawn', (data) => {
                playNotificationSound();
                showNotificationBadge('requests');
                showToast(' ' + data.message, 'info');
                loadRequests();
            });

            socket.on('order_status_updated', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'success');
                loadOrders();
            });

            socket.on('order_cancelled', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(` ${data.message}`, 'warning');
                loadOrders();
            });

            // Order created notification
            socket.on('order_created', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'success');
                loadOrders();
                loadRequests(); // Refresh requests as this one is now accepted
            });

            // Counter-offer socket handlers
            socket.on('counter_offer_accepted', (data) => {
                playNotificationSound();
                showToast(data.notification, 'success');
                loadRequests();
            });

            socket.on('counter_offer_rejected', (data) => {
                playNotificationSound();
                showToast(data.notification, 'warning');
                loadRequests();
            });

            socket.on('garage_counter_offer', (data) => {
                playNotificationSound();
                showNotificationBadge('requests');
                showToast(data.notification, 'info');
                loadRequests();
            });

            // ===== QC AND DELIVERY TRACKING EVENTS =====

            // QC Inspection passed
            socket.on('qc_passed', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'success');
                loadOrders();
            });

            // QC Inspection failed - order will be cancelled
            socket.on('qc_failed', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'error');
                loadOrders();
            });

            // Driver assigned - store driver info and show on order card
            socket.on('driver_assigned', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'success');

                // Store driver info globally for map display
                if (!window.activeDeliveries) window.activeDeliveries = {};
                window.activeDeliveries[data.order_id] = {
                    driver: data.driver,
                    estimated_delivery: data.estimated_delivery
                };

                loadOrders();
            });

            // Real-time driver location update
            socket.on('driver_location_update', (data) => {
                console.log('Driver location update:', data);

                // Update stored location
                if (!window.activeDeliveries) window.activeDeliveries = {};
                if (!window.activeDeliveries[data.order_id]) {
                    window.activeDeliveries[data.order_id] = {};
                }
                window.activeDeliveries[data.order_id].location = data.location;

                // Update map marker if exists
                if (window.deliveryMaps && window.deliveryMaps[data.order_id]) {
                    const map = window.deliveryMaps[data.order_id];
                    if (map.driverMarker) {
                        map.driverMarker.setLatLng([data.location.lat, data.location.lng]);
                    }
                }
            });

            // Dispute socket handlers
            socket.on('dispute_accepted', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'success');
                loadOrders();
            });

            socket.on('dispute_contested', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'warning');
                loadOrders();
            });

            socket.on('dispute_resolved', (data) => {
                playNotificationSound();
                showNotificationBadge('orders');
                showToast(data.notification, 'success');
                loadOrders();
            });

            // Navigation with badge clearing
            document.querySelectorAll('.nav-tab, .mobile-nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;
                    switchSection(section);
                    // Clear badge when visiting section
                    if (section === 'requests') clearNotificationBadge('requests');
                    if (section === 'orders') clearNotificationBadge('orders');
                });
            });

            // VIN Camera button
            document.querySelector('.vin-camera-btn')?.addEventListener('click', openVinScanner);

            // Category selection
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.category-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedCategory = item.dataset.category;
                    document.getElementById('partCategory').value = selectedCategory;
                });
            });

            // Image upload
            document.getElementById('imageUploadArea').addEventListener('click', () => {
                document.getElementById('imageInput').click();
            });

            document.getElementById('imageInput').addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (uploadedImages.length < 5) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            uploadedImages.push({ file, preview: e.target.result });
                            renderImagePreviews();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });

            await Promise.all([loadRequests(), loadOrders()]);
        }

        function renderImagePreviews() {
            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = uploadedImages.map((img, i) => `
                <div class="image-preview-item" onclick="openLightbox(${i})">
                    <img src="${img.preview}" alt="Preview">
                    <span class="image-preview-zoom-icon"><i class="bi bi-zoom-in"></i></span>
                    <button type="button" class="image-preview-remove" onclick="event.stopPropagation(); removeImage(${i})">&times;</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderImagePreviews();
        }

        // ===== LIGHTBOX (Zoom/Pan) =====
        let lightboxCurrentIndex = 0;
        let lightboxZoomLevel = 1;
        let lightboxPanX = 0;
        let lightboxPanY = 0;
        let lightboxIsDragging = false;
        let lightboxStartX = 0;
        let lightboxStartY = 0;

        function openLightbox(index) {
            if (uploadedImages.length === 0) return;
            simpleLightboxMode = false; // Reset mode
            lightboxCurrentIndex = index;
            lightboxZoomLevel = 1;
            lightboxPanX = 0;
            lightboxPanY = 0;

            updateLightboxImage();
            updateLightboxNav();
            document.getElementById('lightboxOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Setup drag handlers
            const container = document.getElementById('lightboxImageContainer');
            container.onmousedown = startDrag;
            container.ontouchstart = startDrag;
            document.onmouseup = stopDrag;
            document.ontouchend = stopDrag;
            document.onmousemove = doDrag;
            document.ontouchmove = doDrag;

            // Wheel zoom
            container.onwheel = (e) => {
                e.preventDefault();
                lightboxZoom(e.deltaY > 0 ? -0.1 : 0.1);
            };
        }

        // New Helper Variables
        let simpleLightboxMode = false;
        let simpleLightboxImages = [];

        function openSimpleLightbox(urls, index) {
            simpleLightboxMode = true;
            simpleLightboxImages = urls;

            lightboxCurrentIndex = index;
            lightboxZoomLevel = 1;
            lightboxPanX = 0;
            lightboxPanY = 0;

            updateLightboxImage();
            updateLightboxNav();
            document.getElementById('lightboxOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            const container = document.getElementById('lightboxImageContainer');
            container.onmousedown = startDrag;
            container.ontouchstart = startDrag;
            container.onwheel = (e) => {
                e.preventDefault();
                lightboxZoom(e.deltaY > 0 ? -0.1 : 0.1);
            };
        }

        async function rejectBid(bidId) {
            if (!confirm('Are you sure you want to reject this bid?')) return;
            try {
                const res = await fetch(`${API_URL}/bids/${bidId}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Bid rejected', 'success');
                    loadRequests();
                } else {
                    showToast(data.error || 'Failed to reject', 'error');
                }
            } catch (e) { showToast('Connection error', 'error'); }
        }

        function closeLightbox() {
            document.getElementById('lightboxOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateLightboxImage() {
            const img = document.getElementById('lightboxImage');
            if (simpleLightboxMode) {
                img.src = simpleLightboxImages[lightboxCurrentIndex];
                document.getElementById('lightboxTitle').textContent = `Image ${lightboxCurrentIndex + 1} of ${simpleLightboxImages.length}`;
            } else {
                img.src = uploadedImages[lightboxCurrentIndex].preview;
                document.getElementById('lightboxTitle').textContent = `Image ${lightboxCurrentIndex + 1} of ${uploadedImages.length}`;
            }
            img.style.transform = `translate(${lightboxPanX}px, ${lightboxPanY}px) scale(${lightboxZoomLevel})`;
            document.getElementById('lightboxZoomInfo').textContent = `${Math.round(lightboxZoomLevel * 100)}%`;
        }

        function updateLightboxNav() {
            const nav = document.getElementById('lightboxNav');
            if (simpleLightboxMode) {
                // External URLs mode (viewing bid images)
                nav.innerHTML = simpleLightboxImages.map((url, i) => `
                    <div class="lightbox-thumb ${i === lightboxCurrentIndex ? 'active' : ''}" onclick="lightboxGoTo(${i})">
                        <img src="${url}" alt="Thumbnail" onerror="this.src='https://placehold.co/60?text=Error'">
                    </div>
                `).join('');
            } else {
                // Upload preview mode
                nav.innerHTML = uploadedImages.map((img, i) => `
                    <div class="lightbox-thumb ${i === lightboxCurrentIndex ? 'active' : ''}" onclick="lightboxGoTo(${i})">
                        <img src="${img.preview}" alt="Thumbnail">
                    </div>
                `).join('');
            }
        }

        function lightboxGoTo(index) {
            lightboxCurrentIndex = index;
            lightboxZoomLevel = 1;
            lightboxPanX = 0;
            lightboxPanY = 0;
            updateLightboxImage();
            updateLightboxNav();
        }

        function lightboxZoom(delta) {
            lightboxZoomLevel = Math.max(0.5, Math.min(4, lightboxZoomLevel + delta));
            if (lightboxZoomLevel <= 1) {
                lightboxPanX = 0;
                lightboxPanY = 0;
            }
            updateLightboxImage();
        }

        function lightboxReset() {
            lightboxZoomLevel = 1;
            lightboxPanX = 0;
            lightboxPanY = 0;
            updateLightboxImage();
        }

        function startDrag(e) {
            if (lightboxZoomLevel <= 1) return;
            lightboxIsDragging = true;
            const pos = e.touches ? e.touches[0] : e;
            lightboxStartX = pos.clientX - lightboxPanX;
            lightboxStartY = pos.clientY - lightboxPanY;
        }

        function stopDrag() {
            lightboxIsDragging = false;
        }

        function doDrag(e) {
            if (!lightboxIsDragging) return;
            e.preventDefault();
            const pos = e.touches ? e.touches[0] : e;
            lightboxPanX = pos.clientX - lightboxStartX;
            lightboxPanY = pos.clientY - lightboxStartY;
            updateLightboxImage();
        }

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft' && uploadedImages.length > 1) lightboxGoTo((lightboxCurrentIndex - 1 + uploadedImages.length) % uploadedImages.length);
            if (e.key === 'ArrowRight' && uploadedImages.length > 1) lightboxGoTo((lightboxCurrentIndex + 1) % uploadedImages.length);
        });

        function switchSection(section) {
            document.querySelectorAll('.nav-tab, .mobile-nav-item').forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`[data-section="${section}"]`).forEach(b => b.classList.add('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');

            if (section === 'requests') loadRequests();
            if (section === 'orders') loadOrders();
        }

        // Submit Request
        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('car_make', document.getElementById('carMake').value);
            formData.append('car_model', document.getElementById('carModel').value);
            formData.append('car_year', document.getElementById('carYear').value);
            formData.append('vin_number', document.getElementById('vinNumber').value.toUpperCase());
            formData.append('part_description', document.getElementById('partDesc').value);
            formData.append('part_number', document.getElementById('partNumber').value);
            formData.append('part_category', selectedCategory);
            formData.append('condition_required', document.getElementById('condition').value);
            formData.append('delivery_address_text', document.getElementById('deliveryAddress').value);

            uploadedImages.forEach(img => formData.append('images', img.file));

            try {
                const res = await fetch(`${API_URL}/requests`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();

                if (data.request_id) {
                    showToast('Request submitted! Garages will send bids.', 'success');
                    document.getElementById('requestForm').reset();
                    document.querySelectorAll('.category-item').forEach(i => i.classList.remove('selected'));
                    selectedCategory = '';
                    uploadedImages = [];
                    renderImagePreviews();
                    switchSection('requests');
                } else {
                    showToast(data.error || 'Failed to submit', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        async function loadRequests() {
            try {
                const res = await fetch(`${API_URL}/requests/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const requests = await res.json();

                if (!requests.length) {
                    document.getElementById('requestsList').innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-inbox empty-state-icon"></i>
                            <h3 class="empty-state-title">No requests yet</h3>
                            <p class="empty-state-text">Create your first part request to get started</p>
                        </div>
                    `;
                    return;
                }

                const html = await Promise.all(requests.map(async r => {
                    let bidsHtml = '';
                    const isCancelled = r.status.includes('cancelled');

                    if (r.status === 'active' && r.bid_count > 0) {
                        const bidsRes = await fetch(`${API_URL}/requests/${r.request_id}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const { bids } = await bidsRes.json();

                        if (bids && bids.length) {
                            bidsHtml = `
                                <div class="bids-section">
                                    <h4 class="bids-title">Received Bids (${bids.length})</h4>
                                    ${bids.map(b => `
                                        <div class="bid-card ${b.garage_counter_amount ? 'has-counter-offer' : ''}">
                                            <div class="bid-info">
                                                <div class="bid-header">
                                                    ${b.garage_counter_amount ? `
                                                        <div class="counter-offer-prices">
                                                            <span class="original-price">${b.bid_amount} QAR</span>
                                                            <i class="bi bi-arrow-right" style="color: var(--text-muted);"></i>
                                                            <span class="counter-price">${b.garage_counter_amount} QAR</span>
                                                            <span class="counter-offer-label"><i class="bi bi-tag-fill"></i> New Price</span>
                                                        </div>
                                                    ` : `
                                                        <span class="bid-price">${b.bid_amount} QAR</span>
                                                    `}
                                                    <span class="bid-garage">${b.garage_name || 'Garage'}</span>
                                                </div>
                                                <div class="bid-details">
                                                    <span class="badge condition-${b.part_condition}">${b.part_condition}</span>
                                                    <span><i class="bi bi-shield-check"></i> ${b.warranty_days} days warranty</span>
                                                </div>
                                                ${b.garage_counter_message ? `
                                                    <div class="garage-message">
                                                        <i class="bi bi-chat-quote-fill"></i>
                                                        <span>"${b.garage_counter_message}"</span>
                                                    </div>
                                                ` : (b.notes ? `<div class="bid-notes">"${b.notes}"</div>` : '')}
                                                
                                                ${b.image_urls && b.image_urls.length ? (() => {
                                    const normalizedUrls = b.image_urls.map(url => url.startsWith('/') ? url : '/' + url);
                                    return `
                                                    <div class="bid-thumbnails">
                                                        ${normalizedUrls.map((url, i) => `
                                                            <div class="thumb" onclick='openSimpleLightbox(${JSON.stringify(normalizedUrls).replace(/"/g, "&quot;")}, ${i})'>
                                                                <img src="${url}" onerror="this.src='https://placehold.co/100?text=No+Image'">
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                `;
                                })() : ''}
                                            </div>
                                            ${(() => {
                                    // Check if bid notes indicate negotiation completed
                                    const isNegotiated = b.notes && b.notes.includes('[Negotiated');
                                    const hasGarageCounterOffer = b.garage_counter_amount;
                                    const hasActivePendingCounter = b.has_pending_counter && !hasGarageCounterOffer;

                                    if (isNegotiated) {
                                        // Price was agreed - only show Accept (at agreed price) or Reject
                                        return `
                                                        <div class="bid-negotiated-badge">
                                                            <i class="bi bi-check-circle-fill"></i> Price Agreed
                                                        </div>
                                                        <div class="bid-actions">
                                                            <button class="btn-reject" onclick="rejectBid('${b.bid_id}')">Reject</button>
                                                            <button class="btn-accept" onclick="acceptBid('${b.bid_id}')">
                                                                <i class="bi bi-cart-check"></i> Accept at ${b.bid_amount} QAR
                                                            </button>
                                                        </div>
                                                    `;
                                    } else if (hasGarageCounterOffer) {
                                        // Garage made a counter-offer - show prominent accept/counter/reject
                                        return `
                                                        <div class="counter-action-badge">
                                                            <i class="bi bi-bell-fill"></i> 
                                                            <span>Garage has responded  make your decision!</span>
                                                        </div>
                                                        <div class="bid-actions-grid">
                                                            <button class="btn-reject" onclick="rejectBid('${b.bid_id}')">
                                                                <i class="bi bi-x-lg"></i> Reject
                                                            </button>
                                                            <button class="btn-counter" onclick="openCounterOfferModal('${b.bid_id}', ${b.garage_counter_amount}, '${b.garage_counter_id}')">
                                                                <i class="bi bi-arrow-repeat"></i> Counter
                                                            </button>
                                                            <button class="btn-accept" onclick="acceptGarageCounter('${b.garage_counter_id}')">
                                                                <i class="bi bi-cart-check"></i> Accept ${b.garage_counter_amount} QAR
                                                            </button>
                                                        </div>
                                                    `;
                                    } else if (hasActivePendingCounter) {
                                        // There's a customer pending counter-offer - show waiting status
                                        return `
                                                        <div class="bid-pending-badge">
                                                            <i class="bi bi-hourglass-split"></i> Your Counter-Offer Pending
                                                        </div>
                                                        <div class="bid-actions">
                                                            <button class="btn-reject" onclick="rejectBid('${b.bid_id}')">Reject</button>
                                                            <button class="btn-accept" onclick="acceptBid('${b.bid_id}')">Accept Original</button>
                                                        </div>
                                                    `;
                                    } else {
                                        // Normal state - can negotiate
                                        return `
                                                        <div class="bid-actions">
                                                            <button class="btn-reject" onclick="rejectBid('${b.bid_id}')">Reject</button>
                                                            <button class="btn-counter" onclick="openCounterOfferModal('${b.bid_id}', ${b.bid_amount})">
                                                                <i class="bi bi-cash-coin"></i> Negotiate
                                                            </button>
                                                            <button class="btn-accept" onclick="acceptBid('${b.bid_id}')">Accept</button>
                                                        </div>
                                                    `;
                                    }
                                })()}
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }

                    const statusLabel = isCancelled ? 'Cancelled' : r.status;
                    const statusClass = isCancelled ? 'cancelled' : r.status;

                    return `
                        <div class="request-card ${isCancelled ? 'cancelled' : ''}">
                            ${isCancelled ? '<div class="cancelled-overlay"></div>' : ''}
                            <div class="request-header">
                                <div class="request-title">${r.car_make} ${r.car_model} ${r.car_year || ''}</div>
                                <span class="request-badge ${statusClass}">${statusLabel}</span>
                            </div>
                            <p class="request-desc">${r.part_description}</p>
                            <div class="request-meta">
                                <span><i class="bi bi-tag"></i> ${r.bid_count || 0} bids</span>
                                <span><i class="bi bi-clock"></i> ${getTimeAgo(r.created_at)}</span>
                            </div>
                            ${bidsHtml}
                            ${r.status === 'active' ? `
                                <div class="request-actions">
                                    <button class="btn-cancel" onclick="openCancelModal('request', '${r.request_id}')">
                                        <i class="bi bi-x-circle"></i> Cancel Request
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }));

                document.getElementById('requestsList').innerHTML = html.join('');
            } catch (err) {
                console.error('Failed to load requests:', err);
            }
        }

        async function acceptBid(bidId) {
            if (!confirm('Accept this bid and create an order?')) return;
            try {
                const res = await fetch(`${API_URL}/orders/accept-bid/${bidId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ payment_method: 'cash' })
                });
                const data = await res.json();
                if (data.order_id) {
                    showToast('Order created!', 'success');
                    switchSection('orders');
                } else {
                    showToast(data.error || 'Failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Accept garage counter-offer (agrees to their price)
        async function acceptGarageCounter(counterOfferId) {
            if (!counterOfferId) {
                showToast('Counter-offer not found', 'error');
                return;
            }
            if (!confirm('Accept this counter-offer and create an order at this price?')) return;
            try {
                const res = await fetch(`${API_URL}/negotiations/counter-offers/${counterOfferId}/customer-respond`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'accept' })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Counter-offer accepted! Order will be created.', 'success');
                    loadRequests();
                } else {
                    showToast(data.error || 'Failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/orders/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await res.json();

                if (!orders.length) {
                    document.getElementById('ordersList').innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-box-seam empty-state-icon"></i>
                            <h3 class="empty-state-title">No orders yet</h3>
                            <p class="empty-state-text">Accept a bid to create your first order</p>
                        </div>
                    `;
                    return;
                }

                const statuses = ['confirmed', 'preparing', 'ready_for_pickup', 'in_transit', 'delivered'];
                const statusLabels = {
                    confirmed: 'Confirmed',
                    preparing: 'Preparing',
                    ready_for_pickup: 'Ready',
                    in_transit: 'In Transit',
                    delivered: 'Delivered',
                    completed: 'Completed',
                    disputed: 'Disputed',
                    refunded: 'Refunded'
                };

                document.getElementById('ordersList').innerHTML = orders.map(o => {
                    const currentIdx = statuses.indexOf(o.order_status);
                    const isCancelled = o.order_status.includes('cancelled');
                    const isDisputed = o.order_status === 'disputed';
                    const isRefunded = o.order_status === 'refunded';
                    const canCancel = ['confirmed', 'preparing'].includes(o.order_status);
                    const showTimeline = !isCancelled && !isDisputed && !isRefunded;

                    const timeline = showTimeline ? statuses.map((s, i) => {
                        let cls = i < currentIdx ? 'completed' : i === currentIdx ? 'current' : '';
                        return `
                            <div class="timeline-step ${cls}">
                                <div class="timeline-dot"><i class="bi bi-${i < currentIdx ? 'check' : 'circle'}"></i></div>
                                <div class="timeline-label">${statusLabels[s]}</div>
                            </div>
                        `;
                    }).join('') : '';

                    const statusLabel = isCancelled ? 'Cancelled' : (statusLabels[o.order_status] || o.order_status);
                    const statusClass = isCancelled ? 'cancelled' : (isDisputed ? 'disputed' : (isRefunded ? 'refunded' : o.order_status));

                    // Build actions HTML based on status
                    let actionsHtml = '';
                    if (o.order_status === 'delivered') {
                        actionsHtml = `
                            <button class="btn-report-issue" onclick="openReportIssueModal('${o.order_id}')">
                                <i class="bi bi-exclamation-triangle"></i> Report Issue
                            </button>
                            <button class="btn-confirm-delivery" onclick="confirmDelivery('${o.order_id}')">
                                <i class="bi bi-check-lg"></i> Confirm Delivery
                            </button>
                        `;
                    } else if (isDisputed) {
                        actionsHtml = `<span class="dispute-badge"><i class="bi bi-hourglass-split"></i> Dispute in Progress</span>`;
                    } else if (isRefunded) {
                        // Option A: Platform-managed refund with actual amount
                        const refundAmount = o.total_amount || o.part_price || 0;
                        actionsHtml = `
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); border-radius: 12px; text-align: center;">
                                <i class="bi bi-check-circle-fill" style="font-size: 32px; color: #10b981;"></i>
                                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Refund Approved</div>
                                <div style="font-size: 22px; font-weight: 800; color: #10b981;">${refundAmount} QAR</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Will be credited within 1-3 business days</div>
                            </div>
                        `;
                    } else if (canCancel) {
                        actionsHtml = `<button class="btn-cancel" onclick="openCancelModal('order', '${o.order_id}')"><i class="bi bi-x-circle"></i> Cancel Order</button>`;
                    }

                    // Build tracking panel HTML for in_transit orders
                    let trackingHtml = '';
                    if (o.order_status === 'in_transit') {
                        const delivery = window.activeDeliveries?.[o.order_id] || {};
                        const driver = delivery.driver || {};
                        trackingHtml = `
                            <div class="driver-tracking-panel" style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: 12px; border: 1px solid var(--primary);">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div style="width: 48px; height: 48px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-truck" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; color: var(--text-primary);"> ${driver.name || 'Driver Assigned'}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            ${driver.vehicle_type || 'Vehicle'}  ${driver.vehicle_plate || ''}
                                        </div>
                                        ${driver.phone ? `<a href="tel:${driver.phone}" style="font-size: 12px; color: var(--primary); text-decoration: none;"><i class="bi bi-telephone"></i> ${driver.phone}</a>` : ''}
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 11px; color: var(--text-muted);">LIVE</div>
                                        <div style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; margin-left: auto;"></div>
                                    </div>
                                </div>
                                <div id="tracking-map-${o.order_id}" style="height: 200px; border-radius: 8px; overflow: hidden; background: #1e293b;"></div>
                                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                    <span><i class="bi bi-geo-alt"></i> Delivery in progress</span>
                                    <span id="eta-${o.order_id}">${delivery.estimated_delivery ? 'ETA: ' + new Date(delivery.estimated_delivery).toLocaleTimeString('en-QA', { hour: '2-digit', minute: '2-digit' }) : ''}</span>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="order-card ${isCancelled ? 'cancelled' : ''} ${isDisputed ? 'disputed' : ''} ${isRefunded ? 'refunded' : ''}" data-order-id="${o.order_id}">
                            ${isCancelled ? '<div class="cancelled-overlay"></div>' : ''}
                            <div class="order-header">
                                <div class="order-number">Order #${o.order_number || o.order_id.slice(0, 8)}</div>
                                <span class="order-status ${statusClass}">${statusLabel}</span>
                            </div>
                            <p style="color: var(--text-secondary);">${o.car_make} ${o.car_model} - ${o.part_description}</p>
                            <div style="font-size: 24px; font-weight: 800; color: var(--success); margin-top: 8px;">${o.total_amount} QAR</div>
                            ${timeline ? `<div class="order-timeline">${timeline}</div>` : ''}
                            ${trackingHtml}
                            <div class="request-actions">
                                ${actionsHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                // Initialize maps for in_transit orders after render
                setTimeout(() => initializeTrackingMaps(orders), 100);
            } catch (err) {
                console.error('Failed to load orders:', err);
            }
        }

        async function confirmDelivery(orderId) {
            if (!confirm('Confirm you received the delivery?')) return;
            try {
                const res = await fetch(`${API_URL}/orders/${orderId}/confirm-delivery`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.prompt_review) {
                    showToast('Delivery confirmed! Thank you.', 'success');
                    loadOrders();
                } else {
                    showToast(data.error || 'Failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Initialize Leaflet maps for in_transit orders (Talabat-style tracking)
        function initializeTrackingMaps(orders) {
            if (!window.L) {
                console.warn('Leaflet not loaded');
                return;
            }

            // Initialize map storage
            if (!window.deliveryMaps) window.deliveryMaps = {};

            orders.filter(o => o.order_status === 'in_transit').forEach(order => {
                const mapId = `tracking-map-${order.order_id}`;
                const container = document.getElementById(mapId);

                if (!container) return;

                // Skip if already initialized
                if (window.deliveryMaps[order.order_id]) return;

                try {
                    // Qatar center coordinates (Doha)
                    const qatarCenter = [25.2854, 51.5310];

                    // Create map
                    const map = L.map(mapId, {
                        zoomControl: false,
                        attributionControl: false
                    }).setView(qatarCenter, 13);

                    // Add tile layer (OpenStreetMap)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 18
                    }).addTo(map);

                    // Custom truck icon
                    const truckIcon = L.divIcon({
                        className: 'driver-marker',
                        html: `<div style="width: 40px; height: 40px; background: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); border: 3px solid white;">
                            <span style="font-size: 20px;"></span>
                        </div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });

                    // Get stored location or use center
                    const delivery = window.activeDeliveries?.[order.order_id] || {};
                    const location = delivery.location || { lat: qatarCenter[0], lng: qatarCenter[1] };

                    // Add driver marker
                    const driverMarker = L.marker([location.lat, location.lng], { icon: truckIcon }).addTo(map);

                    // Store map reference for live updates
                    window.deliveryMaps[order.order_id] = {
                        map: map,
                        driverMarker: driverMarker
                    };

                    // Center on marker
                    map.setView([location.lat, location.lng], 14);

                } catch (e) {
                    console.error('Map init error:', e);
                }
            });
        }

        // ===== CANCEL MODAL =====
        let cancelType = '';
        let cancelId = '';

        function openCancelModal(type, id) {
            cancelType = type;
            cancelId = id;

            if (type === 'request') {
                document.getElementById('cancelModalTitle').textContent = 'Cancel Request?';
                document.getElementById('cancelModalMessage').textContent = 'This will reject all bids and remove the request. This action cannot be undone.';
            } else {
                document.getElementById('cancelModalTitle').textContent = 'Cancel Order?';
                document.getElementById('cancelModalMessage').textContent = 'The garage will be notified. Cancellation policy may apply.';
            }

            document.getElementById('cancelModal').classList.add('active');
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('active');
            cancelType = '';
            cancelId = '';
        }

        async function confirmCancel() {
            try {
                let endpoint = '';
                if (cancelType === 'request') {
                    endpoint = `${API_URL}/cancellations/requests/${cancelId}/cancel`;
                } else {
                    endpoint = `${API_URL}/cancellations/orders/${cancelId}/cancel/customer`;
                }

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: 'Customer requested cancellation' })
                });
                const data = await res.json();

                if (res.ok) {
                    showToast(`${cancelType === 'request' ? 'Request' : 'Order'} cancelled successfully`, 'success');
                    const wasRequest = cancelType === 'request';
                    closeCancelModal();
                    // Reload data after modal closes
                    if (wasRequest) {
                        await loadRequests();
                    } else {
                        await loadOrders();
                    }
                } else {
                    showToast(data.error || 'Failed to cancel', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // ===== COUNTER-OFFER MODAL =====
        let currentCounterBidId = null;
        let currentCounterOriginalPrice = 0;
        let currentGarageCounterId = null; // New variable to track what we are responding to
        const MAX_NEGOTIATION_ROUNDS = 3;

        function openCounterOfferModal(bidId, originalPrice, garageCounterId = null) {
            currentCounterBidId = bidId;
            currentCounterOriginalPrice = originalPrice;
            currentGarageCounterId = garageCounterId;

            document.getElementById('counterOriginalPrice').textContent = originalPrice.toFixed(2) + ' QAR';
            document.getElementById('counterAmount').value = '';
            document.getElementById('counterYourPrice').textContent = '? QAR';
            document.getElementById('counterMessage').value = '';

            // Load negotiation history
            loadNegotiationHistory(bidId);

            document.getElementById('counterOfferModal').classList.add('active');
        }

        function closeCounterOfferModal() {
            document.getElementById('counterOfferModal').classList.remove('active');
            currentCounterBidId = null;
            currentCounterOriginalPrice = 0;
            currentGarageCounterId = null;
        }

        function updateCounterPreview() {
            const amount = document.getElementById('counterAmount').value;
            if (amount && !isNaN(amount)) {
                document.getElementById('counterYourPrice').textContent = parseFloat(amount).toFixed(2) + ' QAR';
            } else {
                document.getElementById('counterYourPrice').textContent = '? QAR';
            }
        }

        async function sendCounterOffer() {
            const amount = parseFloat(document.getElementById('counterAmount').value);
            const message = document.getElementById('counterMessage').value;

            if (!amount || amount <= 0) {
                showToast('Please enter a valid price', 'error');
                return;
            }

            if (amount >= currentCounterOriginalPrice) {
                showToast('Counter-offer must be lower than the current price', 'error');
                return;
            }

            try {
                let endpoint, body;

                if (currentGarageCounterId) {
                    // Responding to a garage counter-offer
                    endpoint = `${API_URL}/negotiations/counter-offers/${currentGarageCounterId}/customer-respond`;
                    body = {
                        action: 'counter',
                        counter_amount: amount,
                        message: message
                    };
                } else {
                    // Initiating a new counter-offer on a bid
                    endpoint = `${API_URL}/negotiations/bids/${currentCounterBidId}/counter-offer`;
                    body = {
                        proposed_amount: amount,
                        message: message
                    };
                }

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (res.ok) {
                    showToast(` Counter-offer of ${amount} QAR sent! (Round ${data.round || '?'}/${MAX_NEGOTIATION_ROUNDS})`, 'success');
                    closeCounterOfferModal();
                    loadRequests();
                } else {
                    showToast(data.error || 'Failed to send counter-offer', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        async function loadNegotiationHistory(bidId) {
            try {
                const res = await fetch(`${API_URL}/negotiations/bids/${bidId}/negotiations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const historyDiv = document.getElementById('negotiationHistory');
                const historyList = document.getElementById('negotiationHistoryList');
                const roundsRemaining = document.getElementById('roundsRemaining');

                if (data.negotiations && data.negotiations.length > 0) {
                    historyDiv.style.display = 'block';
                    historyList.innerHTML = data.negotiations.map(n => `
                        <div class="negotiation-item ${n.offered_by_type}">
                            <span class="round-badge">${n.round_number}</span>
                            <span>${n.offered_by_type === 'customer' ? 'You' : 'Garage'} offered <strong>${n.proposed_amount} QAR</strong></span>
                            <span class="text-muted">(${n.status})</span>
                        </div>
                    `).join('');

                    const remaining = MAX_NEGOTIATION_ROUNDS - data.current_round;
                    roundsRemaining.textContent = remaining > 0 ? `${remaining} round(s) remaining` : 'Final round - no more negotiations';
                } else {
                    historyDiv.style.display = 'none';
                    roundsRemaining.textContent = '3 rounds remaining in negotiation';
                }
            } catch (err) {
                console.error('Failed to load negotiation history:', err);
            }
        }

        // ===== REPORT ISSUE MODAL =====
        let currentDisputeOrderId = null;
        let currentOrderPrice = 0;
        let issuePhotosFiles = [];

        const REFUND_CONFIGS = {
            wrong_part: { refundPercent: 100, restockingFee: 0 },
            doesnt_fit: { refundPercent: 85, restockingFee: 15 },
            damaged: { refundPercent: 100, restockingFee: 0 },
            not_as_described: { refundPercent: 100, restockingFee: 0 },
            changed_mind: { refundPercent: 70, restockingFee: 30 }
        };

        function openReportIssueModal(orderId) {
            currentDisputeOrderId = orderId;
            issuePhotosFiles = [];
            document.getElementById('issueReason').value = '';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issuePhotoPreview').innerHTML = '';
            document.getElementById('refundPreview').style.display = 'none';
            document.getElementById('reportIssueModal').classList.add('active');
        }

        function closeReportIssueModal() {
            document.getElementById('reportIssueModal').classList.remove('active');
            currentDisputeOrderId = null;
            issuePhotosFiles = [];
        }

        function updateRefundPreview() {
            const reason = document.getElementById('issueReason').value;
            const preview = document.getElementById('refundPreview');

            if (reason && REFUND_CONFIGS[reason]) {
                const config = REFUND_CONFIGS[reason];
                // For now, estimate with 0 price - actual will come from API
                preview.style.display = 'block';
                document.getElementById('previewRefund').textContent = config.refundPercent + '% of part price';
                document.getElementById('previewFee').textContent = config.restockingFee + '% restocking';
            } else {
                preview.style.display = 'none';
            }
        }

        function previewIssuePhotos() {
            const input = document.getElementById('issuePhotos');
            const preview = document.getElementById('issuePhotoPreview');
            const files = Array.from(input.files);

            files.forEach(file => {
                if (issuePhotosFiles.length < 5) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        issuePhotosFiles.push(file);
                        preview.innerHTML += `
                            <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; border: 2px solid var(--border);">
                                <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        async function submitDispute() {
            const reason = document.getElementById('issueReason').value;
            const description = document.getElementById('issueDescription').value;

            if (!reason) {
                showToast('Please select a reason', 'error');
                return;
            }

            if (!description.trim()) {
                showToast('Please describe the issue', 'error');
                return;
            }

            // Check if photos required
            if (['damaged', 'wrong_part', 'not_as_described'].includes(reason) && issuePhotosFiles.length === 0) {
                showToast('Photos are required for this type of issue', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('order_id', currentDisputeOrderId);
            formData.append('reason', reason);
            formData.append('description', description);
            issuePhotosFiles.forEach(file => {
                formData.append('photos', file);
            });

            try {
                const res = await fetch(`${API_URL}/disputes`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();

                if (res.ok) {
                    showToast(`Dispute submitted! Expected refund: ${data.expected_refund} QAR`, 'success');
                    closeReportIssueModal();
                    loadOrders();
                } else {
                    showToast(data.error || 'Failed to submit dispute', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'x-circle-fill'}"></i> ${message}`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>

</html>